angular.module('ozpIwcAngular').factory('ozpIwc',function(){var ozpIwc=ozpIwc||{};ozpIwc.AsyncAction=function(){this.callbacks={}},ozpIwc.AsyncAction.prototype.when=function(a,b,c){return c&&(b=function(){return b.apply(c,arguments)}),this.resolution===a?b.apply(this,this.value):this.callbacks[a]=b,this},ozpIwc.AsyncAction.prototype.resolve=function(a){if(this.resolution)throw"Cannot resolve an already resolved AsyncAction";var b=this.callbacks[a];return this.resolution=a,this.value=Array.prototype.slice.call(arguments,1),b&&b.apply(this,this.value),this},ozpIwc.AsyncAction.prototype.success=function(a,b){return this.when("success",a,b)},ozpIwc.AsyncAction.prototype.failure=function(a,b){return this.when("failure",a,b)};var ozpIwc=ozpIwc||{};ozpIwc.Event=function(){this.events={}},ozpIwc.Event.prototype.on=function(a,b,c){var d=b;return c&&(d=function(){b.apply(c,arguments)},d.ozpIwcDelegateFor=b),this.events[a]=this.events[a]||[],this.events[a].push(d),d},ozpIwc.Event.prototype.off=function(a,b){this.events[a]=(this.events[a]||[]).filter(function(a){return a!==b&&a.ozpIwcDelegateFor!==b})},ozpIwc.Event.prototype.trigger=function(a,b){b=b||new ozpIwc.CancelableEvent;var c=this.events[a]||[];return c.forEach(function(a){a(b)}),b},ozpIwc.Event.prototype.mixinOnOff=function(a){var b=this;a.on=function(){return b.on.apply(b,arguments)},a.off=function(){return b.off.apply(b,arguments)}},ozpIwc.CancelableEvent=function(a){a=a||{};for(k in a)this[k]=a[k];this.canceled=!1,this.cancelReason=null},ozpIwc.CancelableEvent.prototype.cancel=function(a){return a=a||"Unknown",this.canceled=!0,this.cancelReason=a,this};var ozpIwc=ozpIwc||{};ozpIwc.log=ozpIwc.log||{log:function(){window.console&&"function"==typeof window.console.log&&window.console.log.apply(window.console,arguments)},error:function(){window.console&&"error"==typeof window.console.error&&window.console.error.apply(window.console,arguments)}};var ozpIwc=ozpIwc||{};ozpIwc.util=ozpIwc.util||{},ozpIwc.util.generateId=function(){return Math.floor(4294967295*Math.random()).toString(16)},ozpIwc.util.now=function(){return(new Date).getTime()},ozpIwc.util.extend=function(a,b){return b.prototype=Object.create(a.prototype),b.prototype.constructor=b,b};var ozpIwc=ozpIwc||{};ozpIwc.Client=function(a){a=a||{},this.participantId="$nobody",this.replyCallbacks={},this.peerUrl=a.peerUrl;var b=document.createElement("a");b.href=this.peerUrl,this.peerOrigin=b.protocol+"//"+b.hostname,b.port&&(this.peerOrigin+=":"+b.port),this.autoPeer="autoPeer"in a?a.autoPeer:!0,this.msgIdSequence=0,this.events=new ozpIwc.Event,this.events.mixinOnOff(this),this.receivedPackets=0,this.receivedBytes=0,this.sentPackets=0,this.sentBytes=0,this.startTime=ozpIwc.util.now();var c=this;this.autoPeer&&this.findPeer(),this.messageEventListener=window.addEventListener("message",function(a){if(a.origin===c.peerOrigin)try{c.receive(JSON.parse(a.data)),c.receivedBytes+=2*a.data.length,c.receivedPackets++}catch(b){}},!1)},ozpIwc.Client.prototype.receive=function(a){a.replyTo&&this.replyCallbacks[a.replyTo]?this.replyCallbacks[a.replyTo](a):this.events.trigger("receive",a)},ozpIwc.Client.prototype.send=function(a,b){var c=(new Date).getTime(),d="p:"+this.msgIdSequence++,e={ver:1,src:this.participantId,msgId:d,time:c};for(var f in a)e[f]=a[f];b&&(this.replyCallbacks[d]=b);var g=JSON.stringify(e);return this.peer.postMessage(g,"*"),this.sentBytes+=g.length,this.sentPackets++,e},ozpIwc.Client.prototype.on=function(a,b){return"connected"===a&&"$nobody"!==this.participantId?void b(this):this.events.on.apply(this.events,arguments)},ozpIwc.Client.prototype.off=function(){return this.events.off.apply(this.events,arguments)},ozpIwc.Client.prototype.disconnect=function(){window.removeEventListener("message",this.messageEventListener,!1),this.iframe&&document.body.removeChild(this.iframe)},ozpIwc.Client.prototype.createIframePeer=function(a){var b=this,c=function(){b.iframe=document.createElement("iframe"),b.iframe.src=a+"/iframe_peer.html",b.iframe.height=1,b.iframe.width=1,b.iframe.style="display:none !important;",b.iframe.addEventListener("load",function(){b.requestAddress()},!1),document.body.appendChild(b.iframe),b.peer=b.iframe.contentWindow};"complete"===document.readyState?c():window.addEventListener("load",c,!1)},ozpIwc.Client.prototype.findPeer=function(){this.createIframePeer(this.peerUrl)},ozpIwc.Client.prototype.requestAddress=function(){var a=this;this.send({dst:"$transport"},function(b){a.participantId=b.dst,a.events.trigger("connected",a)})};return ozpIwc;});