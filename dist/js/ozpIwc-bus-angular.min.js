angular.module("ozpIwcAngular",[]).factory("ozpIwc",function(){var a=a||{};a.AsyncAction=function(){this.callbacks={}},a.AsyncAction.prototype.when=function(a,b,c){return c=c||this,this.resolution===a?b.apply(c,this.value):this.callbacks[a]=function(){return b.apply(c,arguments)},this},a.AsyncAction.prototype.resolve=function(a){if(this.resolution)throw"Cannot resolve an already resolved AsyncAction";var b=this.callbacks[a];return this.resolution=a,this.value=Array.prototype.slice.call(arguments,1),b&&b.apply(this,this.value),this},a.AsyncAction.prototype.success=function(a,b){return this.when("success",a,b)},a.AsyncAction.prototype.failure=function(a,b){return this.when("failure",a,b)},function(a,b){"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():a.returnExports=b()}(this,function(){function a(a){try{return a.sentinel=0,0===Object.getOwnPropertyDescriptor(a,"sentinel").value}catch(b){}}function b(a){try{return Object.defineProperty(a,"sentinel",{}),"sentinel"in a}catch(b){}}var c,d,e,f,g=Function.prototype.call,h=Object.prototype,i=g.bind(h.hasOwnProperty),j=i(h,"__defineGetter__");if(j&&(c=g.bind(h.__defineGetter__),d=g.bind(h.__defineSetter__),e=g.bind(h.__lookupGetter__),f=g.bind(h.__lookupSetter__)),Object.getPrototypeOf||(Object.getPrototypeOf=function(a){var b=a.__proto__;return b||null===b?b:a.constructor?a.constructor.prototype:h}),Object.defineProperty){var k=a({}),l="undefined"==typeof document||a(document.createElement("div"));if(!l||!k)var m=Object.getOwnPropertyDescriptor}if(!Object.getOwnPropertyDescriptor||m){var n="Object.getOwnPropertyDescriptor called on a non-object: ";Object.getOwnPropertyDescriptor=function(a,b){if("object"!=typeof a&&"function"!=typeof a||null===a)throw new TypeError(n+a);if(m)try{return m.call(Object,a,b)}catch(c){}if(i(a,b)){var d={enumerable:!0,configurable:!0};if(j){var g=a.__proto__,k=a!==h;k&&(a.__proto__=h);var l=e(a,b),o=f(a,b);if(k&&(a.__proto__=g),l||o)return l&&(d.get=l),o&&(d.set=o),d}return d.value=a[b],d.writable=!0,d}}}if(Object.getOwnPropertyNames||(Object.getOwnPropertyNames=function(a){return Object.keys(a)}),!Object.create){var o,p=!({__proto__:null}instanceof Object);o=p||"undefined"==typeof document?function(){return{__proto__:null}}:function(){function a(){}var b=document.createElement("iframe"),c=document.body||document.documentElement;b.style.display="none",c.appendChild(b),b.src="javascript:";var d=b.contentWindow.Object.prototype;return c.removeChild(b),b=null,delete d.constructor,delete d.hasOwnProperty,delete d.propertyIsEnumerable,delete d.isPrototypeOf,delete d.toLocaleString,delete d.toString,delete d.valueOf,d.__proto__=null,a.prototype=d,o=function(){return new a},new a},Object.create=function(a,b){function c(){}var d;if(null===a)d=o();else{if("object"!=typeof a&&"function"!=typeof a)throw new TypeError("Object prototype may only be an Object or null");c.prototype=a,d=new c,d.__proto__=a}return void 0!==b&&Object.defineProperties(d,b),d}}if(Object.defineProperty){var q=b({}),r="undefined"==typeof document||b(document.createElement("div"));if(!q||!r)var s=Object.defineProperty,t=Object.defineProperties}if(!Object.defineProperty||s){var u="Property description must be an object: ",v="Object.defineProperty called on non-object: ",w="getters & setters can not be defined on this javascript engine";Object.defineProperty=function(a,b,g){if("object"!=typeof a&&"function"!=typeof a||null===a)throw new TypeError(v+a);if("object"!=typeof g&&"function"!=typeof g||null===g)throw new TypeError(u+g);if(s)try{return s.call(Object,a,b,g)}catch(k){}if(i(g,"value"))if(j&&(e(a,b)||f(a,b))){var l=a.__proto__;a.__proto__=h,delete a[b],a[b]=g.value,a.__proto__=l}else a[b]=g.value;else{if(!j)throw new TypeError(w);i(g,"get")&&c(a,b,g.get),i(g,"set")&&d(a,b,g.set)}return a}}(!Object.defineProperties||t)&&(Object.defineProperties=function(a,b){if(t)try{return t.call(Object,a,b)}catch(c){}for(var d in b)i(b,d)&&"__proto__"!==d&&Object.defineProperty(a,d,b[d]);return a}),Object.seal||(Object.seal=function(a){return a}),Object.freeze||(Object.freeze=function(a){return a});try{Object.freeze(function(){})}catch(x){Object.freeze=function(a){return function(b){return"function"==typeof b?b:a(b)}}(Object.freeze)}Object.preventExtensions||(Object.preventExtensions=function(a){return a}),Object.isSealed||(Object.isSealed=function(){return!1}),Object.isFrozen||(Object.isFrozen=function(){return!1}),Object.isExtensible||(Object.isExtensible=function(a){if(Object(a)!==a)throw new TypeError;for(var b="";i(a,b);)b+="?";a[b]=!0;var c=i(a,b);return delete a[b],c})}),function(a,b){"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():a.returnExports=b()}(this,function(){function a(a){return a=+a,a!==a?a=0:0!==a&&a!==1/0&&a!==-(1/0)&&(a=(a>0||-1)*Math.floor(Math.abs(a))),a}function b(a){var b=typeof a;return null===a||"undefined"===b||"boolean"===b||"number"===b||"string"===b}function c(a){var c,d,e;if(b(a))return a;if(d=a.valueOf,p(d)&&(c=d.call(a),b(c)))return c;if(e=a.toString,p(e)&&(c=e.call(a),b(c)))return c;throw new TypeError}function d(){}var e,f=Array.prototype,g=Object.prototype,h=Function.prototype,i=String.prototype,j=Number.prototype,k=f.slice,l=f.splice,m=(f.push,f.unshift),n=h.call,o=g.toString,p=function(a){return"[object Function]"===g.toString.call(a)},q=function(a){return"[object RegExp]"===g.toString.call(a)},r=function(a){return"[object Array]"===o.call(a)},s=function(a){return"[object String]"===o.call(a)},t=function(a){var b=o.call(a),c="[object Arguments]"===b;return c||(c=!r(b)&&null!==a&&"object"==typeof a&&"number"==typeof a.length&&a.length>=0&&p(a.callee)),c},u=Object.defineProperty&&function(){try{return Object.defineProperty({},"x",{}),!0}catch(a){return!1}}();e=u?function(a,b,c,d){!d&&b in a||Object.defineProperty(a,b,{configurable:!0,enumerable:!1,writable:!0,value:c})}:function(a,b,c,d){!d&&b in a||(a[b]=c)};var v=function(a,b,c){for(var d in b)g.hasOwnProperty.call(b,d)&&e(a,d,b[d],c)},w=function(a){if(null==a)throw new TypeError("can't convert "+a+" to object");return Object(a)},x=function(a){return a>>>0};v(h,{bind:function(a){var b=this;if(!p(b))throw new TypeError("Function.prototype.bind called on incompatible "+b);for(var c=k.call(arguments,1),e=function(){if(this instanceof i){var d=b.apply(this,c.concat(k.call(arguments)));return Object(d)===d?d:this}return b.apply(a,c.concat(k.call(arguments)))},f=Math.max(0,b.length-c.length),g=[],h=0;f>h;h++)g.push("$"+h);var i=Function("binder","return function ("+g.join(",")+"){return binder.apply(this,arguments)}")(e);return b.prototype&&(d.prototype=b.prototype,i.prototype=new d,d.prototype=null),i}});var y,z,A,B,C,D=n.bind(g.hasOwnProperty);(C=D(g,"__defineGetter__"))&&(y=n.bind(g.__defineGetter__),z=n.bind(g.__defineSetter__),A=n.bind(g.__lookupGetter__),B=n.bind(g.__lookupSetter__));var E=function(){var a=[1,2],b=a.splice();return 2===a.length&&r(b)&&0===b.length}();v(f,{splice:function(){return 0===arguments.length?[]:l.apply(this,arguments)}},E);var F=function(){var a={};return f.splice.call(a,0,0,1),1===a.length}();v(f,{splice:function(b,c){if(0===arguments.length)return[];var d=arguments;return this.length=Math.max(a(this.length),0),arguments.length>0&&"number"!=typeof c&&(d=k.call(arguments),d.length<2?d.push(this.length-b):d[1]=a(c)),l.apply(this,d)}},!F);var G=1!==[].unshift(0);v(f,{unshift:function(){return m.apply(this,arguments),this.length}},G),v(Array,{isArray:r});var H=Object("a"),I="a"!==H[0]||!(0 in H),J=function(a){var b=!0,c=!0;return a&&(a.call("foo",function(a,c,d){"object"!=typeof d&&(b=!1)}),a.call([1],function(){"use strict";c="string"==typeof this},"x")),!!a&&b&&c};v(f,{forEach:function(a){var b=w(this),c=I&&s(this)?this.split(""):b,d=arguments[1],e=-1,f=c.length>>>0;if(!p(a))throw new TypeError;for(;++e<f;)e in c&&a.call(d,c[e],e,b)}},!J(f.forEach)),v(f,{map:function(a){var b=w(this),c=I&&s(this)?this.split(""):b,d=c.length>>>0,e=Array(d),f=arguments[1];if(!p(a))throw new TypeError(a+" is not a function");for(var g=0;d>g;g++)g in c&&(e[g]=a.call(f,c[g],g,b));return e}},!J(f.map)),v(f,{filter:function(a){var b,c=w(this),d=I&&s(this)?this.split(""):c,e=d.length>>>0,f=[],g=arguments[1];if(!p(a))throw new TypeError(a+" is not a function");for(var h=0;e>h;h++)h in d&&(b=d[h],a.call(g,b,h,c)&&f.push(b));return f}},!J(f.filter)),v(f,{every:function(a){var b=w(this),c=I&&s(this)?this.split(""):b,d=c.length>>>0,e=arguments[1];if(!p(a))throw new TypeError(a+" is not a function");for(var f=0;d>f;f++)if(f in c&&!a.call(e,c[f],f,b))return!1;return!0}},!J(f.every)),v(f,{some:function(a){var b=w(this),c=I&&s(this)?this.split(""):b,d=c.length>>>0,e=arguments[1];if(!p(a))throw new TypeError(a+" is not a function");for(var f=0;d>f;f++)if(f in c&&a.call(e,c[f],f,b))return!0;return!1}},!J(f.some));var K=!1;f.reduce&&(K="object"==typeof f.reduce.call("es5",function(a,b,c,d){return d})),v(f,{reduce:function(a){var b=w(this),c=I&&s(this)?this.split(""):b,d=c.length>>>0;if(!p(a))throw new TypeError(a+" is not a function");if(!d&&1===arguments.length)throw new TypeError("reduce of empty array with no initial value");var e,f=0;if(arguments.length>=2)e=arguments[1];else for(;;){if(f in c){e=c[f++];break}if(++f>=d)throw new TypeError("reduce of empty array with no initial value")}for(;d>f;f++)f in c&&(e=a.call(void 0,e,c[f],f,b));return e}},!K);var L=!1;f.reduceRight&&(L="object"==typeof f.reduceRight.call("es5",function(a,b,c,d){return d})),v(f,{reduceRight:function(a){var b=w(this),c=I&&s(this)?this.split(""):b,d=c.length>>>0;if(!p(a))throw new TypeError(a+" is not a function");if(!d&&1===arguments.length)throw new TypeError("reduceRight of empty array with no initial value");var e,f=d-1;if(arguments.length>=2)e=arguments[1];else for(;;){if(f in c){e=c[f--];break}if(--f<0)throw new TypeError("reduceRight of empty array with no initial value")}if(0>f)return e;do f in c&&(e=a.call(void 0,e,c[f],f,b));while(f--);return e}},!L);var M=Array.prototype.indexOf&&-1!==[0,1].indexOf(1,2);v(f,{indexOf:function(b){var c=I&&s(this)?this.split(""):w(this),d=c.length>>>0;if(!d)return-1;var e=0;for(arguments.length>1&&(e=a(arguments[1])),e=e>=0?e:Math.max(0,d+e);d>e;e++)if(e in c&&c[e]===b)return e;return-1}},M);var N=Array.prototype.lastIndexOf&&-1!==[0,1].lastIndexOf(0,-3);v(f,{lastIndexOf:function(b){var c=I&&s(this)?this.split(""):w(this),d=c.length>>>0;if(!d)return-1;var e=d-1;for(arguments.length>1&&(e=Math.min(e,a(arguments[1]))),e=e>=0?e:d-Math.abs(e);e>=0;e--)if(e in c&&b===c[e])return e;return-1}},N);var O=!{toString:null}.propertyIsEnumerable("toString"),P=function(){}.propertyIsEnumerable("prototype"),Q=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],R=Q.length;v(Object,{keys:function(a){var b=p(a),c=t(a),d=null!==a&&"object"==typeof a,e=d&&s(a);if(!d&&!b&&!c)throw new TypeError("Object.keys called on a non-object");var f=[],g=P&&b;if(e||c)for(var h=0;h<a.length;++h)f.push(String(h));else for(var i in a)g&&"prototype"===i||!D(a,i)||f.push(String(i));if(O)for(var j=a.constructor,k=j&&j.prototype===a,l=0;R>l;l++){var m=Q[l];k&&"constructor"===m||!D(a,m)||f.push(m)}return f}});var S=Object.keys&&function(){return 2===Object.keys(arguments).length}(1,2),T=Object.keys;v(Object,{keys:function(a){return T(t(a)?f.slice.call(a):a)}},!S);var U=-621987552e5,V="-000001",W=Date.prototype.toISOString&&-1===new Date(U).toISOString().indexOf(V);v(Date.prototype,{toISOString:function(){var a,b,c,d,e;if(!isFinite(this))throw new RangeError("Date.prototype.toISOString called on non-finite value.");for(d=this.getUTCFullYear(),e=this.getUTCMonth(),d+=Math.floor(e/12),e=(e%12+12)%12,a=[e+1,this.getUTCDate(),this.getUTCHours(),this.getUTCMinutes(),this.getUTCSeconds()],d=(0>d?"-":d>9999?"+":"")+("00000"+Math.abs(d)).slice(d>=0&&9999>=d?-4:-6),b=a.length;b--;)c=a[b],10>c&&(a[b]="0"+c);return d+"-"+a.slice(0,2).join("-")+"T"+a.slice(2).join(":")+"."+("000"+this.getUTCMilliseconds()).slice(-3)+"Z"}},W);var X=!1;try{X=Date.prototype.toJSON&&null===new Date(0/0).toJSON()&&-1!==new Date(U).toJSON().indexOf(V)&&Date.prototype.toJSON.call({toISOString:function(){return!0}})}catch(Y){}X||(Date.prototype.toJSON=function(){var a,b=Object(this),d=c(b);if("number"==typeof d&&!isFinite(d))return null;if(a=b.toISOString,"function"!=typeof a)throw new TypeError("toISOString property is not callable");return a.call(b)});var Z=1e15===Date.parse("+033658-09-27T01:46:40.000Z"),$=!isNaN(Date.parse("2012-04-04T24:00:00.500Z"))||!isNaN(Date.parse("2012-11-31T23:59:59.000Z")),_=isNaN(Date.parse("2000-01-01T00:00:00.000Z"));(!Date.parse||_||$||!Z)&&(Date=function(a){function b(c,d,e,f,g,h,i){var j=arguments.length;if(this instanceof a){var k=1===j&&String(c)===c?new a(b.parse(c)):j>=7?new a(c,d,e,f,g,h,i):j>=6?new a(c,d,e,f,g,h):j>=5?new a(c,d,e,f,g):j>=4?new a(c,d,e,f):j>=3?new a(c,d,e):j>=2?new a(c,d):j>=1?new a(c):new a;return k.constructor=b,k}return a.apply(this,arguments)}function c(a,b){var c=b>1?1:0;return f[b]+Math.floor((a-1969+c)/4)-Math.floor((a-1901+c)/100)+Math.floor((a-1601+c)/400)+365*(a-1970)}function d(b){return Number(new a(1970,0,1,0,0,0,b))}var e=new RegExp("^(\\d{4}|[+-]\\d{6})(?:-(\\d{2})(?:-(\\d{2})(?:T(\\d{2}):(\\d{2})(?::(\\d{2})(?:(\\.\\d{1,}))?)?(Z|(?:([-+])(\\d{2}):(\\d{2})))?)?)?)?$"),f=[0,31,59,90,120,151,181,212,243,273,304,334,365];for(var g in a)b[g]=a[g];return b.now=a.now,b.UTC=a.UTC,b.prototype=a.prototype,b.prototype.constructor=b,b.parse=function h(b){var f=e.exec(b);if(f){var g,i=Number(f[1]),h=Number(f[2]||1)-1,j=Number(f[3]||1)-1,k=Number(f[4]||0),l=Number(f[5]||0),m=Number(f[6]||0),n=Math.floor(1e3*Number(f[7]||0)),o=Boolean(f[4]&&!f[8]),p="-"===f[9]?1:-1,q=Number(f[10]||0),r=Number(f[11]||0);return(l>0||m>0||n>0?24:25)>k&&60>l&&60>m&&1e3>n&&h>-1&&12>h&&24>q&&60>r&&j>-1&&j<c(i,h+1)-c(i,h)&&(g=60*(24*(c(i,h)+j)+k+q*p),g=1e3*(60*(g+l+r*p)+m)+n,o&&(g=d(g)),g>=-864e13&&864e13>=g)?g:0/0}return a.parse.apply(this,arguments)},b}(Date)),Date.now||(Date.now=function(){return(new Date).getTime()});var ab=j.toFixed&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==0xde0b6b3a7640080.toFixed(0)),bb={base:1e7,size:6,data:[0,0,0,0,0,0],multiply:function(a,b){for(var c=-1;++c<bb.size;)b+=a*bb.data[c],bb.data[c]=b%bb.base,b=Math.floor(b/bb.base)},divide:function(a){for(var b=bb.size,c=0;--b>=0;)c+=bb.data[b],bb.data[b]=Math.floor(c/a),c=c%a*bb.base},numToString:function(){for(var a=bb.size,b="";--a>=0;)if(""!==b||0===a||0!==bb.data[a]){var c=String(bb.data[a]);""===b?b=c:b+="0000000".slice(0,7-c.length)+c}return b},pow:function nb(a,b,c){return 0===b?c:b%2===1?nb(a,b-1,c*a):nb(a*a,b/2,c)},log:function(a){for(var b=0;a>=4096;)b+=12,a/=4096;for(;a>=2;)b+=1,a/=2;return b}};v(j,{toFixed:function(a){var b,c,d,e,f,g,h,i;if(b=Number(a),b=b!==b?0:Math.floor(b),0>b||b>20)throw new RangeError("Number.toFixed called with invalid number of decimals");if(c=Number(this),c!==c)return"NaN";if(-1e21>=c||c>=1e21)return String(c);if(d="",0>c&&(d="-",c=-c),e="0",c>1e-21)if(f=bb.log(c*bb.pow(2,69,1))-69,g=0>f?c*bb.pow(2,-f,1):c/bb.pow(2,f,1),g*=4503599627370496,f=52-f,f>0){for(bb.multiply(0,g),h=b;h>=7;)bb.multiply(1e7,0),h-=7;for(bb.multiply(bb.pow(10,h,1),0),h=f-1;h>=23;)bb.divide(1<<23),h-=23;bb.divide(1<<h),bb.multiply(1,1),bb.divide(2),e=bb.numToString()}else bb.multiply(0,g),bb.multiply(1<<-f,0),e=bb.numToString()+"0.00000000000000000000".slice(2,2+b);return b>0?(i=e.length,e=b>=i?d+"0.0000000000000000000".slice(0,b-i+2)+e:d+e.slice(0,i-b)+"."+e.slice(i-b)):e=d+e,e}},ab);var cb=i.split;2!=="ab".split(/(?:ab)*/).length||4!==".".split(/(.?)(.?)/).length||"t"==="tesst".split(/(s)*/)[1]||4!=="test".split(/(?:)/,-1).length||"".split(/.?/).length||".".split(/()()/).length>1?!function(){var a=void 0===/()??/.exec("")[1];i.split=function(b,c){var d=this;if(void 0===b&&0===c)return[];if("[object RegExp]"!==o.call(b))return cb.call(this,b,c);var e,g,h,i,j=[],k=(b.ignoreCase?"i":"")+(b.multiline?"m":"")+(b.extended?"x":"")+(b.sticky?"y":""),l=0;for(b=new RegExp(b.source,k+"g"),d+="",a||(e=new RegExp("^"+b.source+"$(?!\\s)",k)),c=void 0===c?-1>>>0:x(c);(g=b.exec(d))&&(h=g.index+g[0].length,!(h>l&&(j.push(d.slice(l,g.index)),!a&&g.length>1&&g[0].replace(e,function(){for(var a=1;a<arguments.length-2;a++)void 0===arguments[a]&&(g[a]=void 0)}),g.length>1&&g.index<d.length&&f.push.apply(j,g.slice(1)),i=g[0].length,l=h,j.length>=c)));)b.lastIndex===g.index&&b.lastIndex++;return l===d.length?(i||!b.test(""))&&j.push(""):j.push(d.slice(l)),j.length>c?j.slice(0,c):j}}():"0".split(void 0,0).length&&(i.split=function(a,b){return void 0===a&&0===b?[]:cb.call(this,a,b)});var db=i.replace,eb=function(){var a=[];return"x".replace(/x(.)?/g,function(b,c){a.push(c)}),1===a.length&&"undefined"==typeof a[0]}();eb||(i.replace=function(a,b){var c=p(b),d=q(a)&&/\)[*?]/.test(a.source);if(c&&d){var e=function(c){var d=arguments.length,e=a.lastIndex;a.lastIndex=0;var f=a.exec(c);return a.lastIndex=e,f.push(arguments[d-2],arguments[d-1]),b.apply(this,f)};return db.call(this,a,e)}return db.call(this,a,b)});var fb=i.substr,gb="".substr&&"b"!=="0b".substr(-1);v(i,{substr:function(a,b){return fb.call(this,0>a&&(a=this.length+a)<0?0:a,b)}},gb);var hb="	\n\f\r   ᠎             　\u2028\u2029﻿",ib="​",jb="["+hb+"]",kb=new RegExp("^"+jb+jb+"*"),lb=new RegExp(jb+jb+"*$"),mb=i.trim&&(hb.trim()||!ib.trim());v(i,{trim:function(){if(void 0===this||null===this)throw new TypeError("can't convert "+this+" to object");return String(this).replace(kb,"").replace(lb,"")}},mb),(8!==parseInt(hb+"08")||22!==parseInt(hb+"0x16"))&&(parseInt=function(a){var b=/^0[xX]/;return function(c,d){return c=String(c).trim(),Number(d)||(d=b.test(c)?16:10),a(c,d)}}(parseInt))});var a=a||{};a.Event=function(){this.events={}},a.Event.prototype.on=function(a,b,c){var d=b;return c&&(d=function(){b.apply(c,arguments)},d.ozpIwcDelegateFor=b),this.events[a]=this.events[a]||[],this.events[a].push(d),d},a.Event.prototype.off=function(a,b){this.events[a]=(this.events[a]||[]).filter(function(a){return a!==b&&a.ozpIwcDelegateFor!==b})},a.Event.prototype.trigger=function(b,c){c=c||new a.CancelableEvent;var d=this.events[b]||[];return d.forEach(function(a){a(c)}),c},a.Event.prototype.mixinOnOff=function(a){var b=this;a.on=function(){return b.on.apply(b,arguments)},a.off=function(){return b.off.apply(b,arguments)}},a.CancelableEvent=function(a){a=a||{};for(var b in a)this[b]=a[b];this.canceled=!1,this.cancelReason=null},a.CancelableEvent.prototype.cancel=function(a){return a=a||"Unknown",this.canceled=!0,this.cancelReason=a,this};var a=a||{};a.log=a.log||{log:function(){window.console&&"function"==typeof window.console.log&&window.console.log.apply(window.console,arguments)},error:function(){window.console&&"function"==typeof window.console.error&&window.console.error.apply(window.console,arguments)}};var a=a||{};a.util=a.util||{},a.util.generateId=function(){return Math.floor(4294967295*Math.random()).toString(16)},a.util.now=function(){return(new Date).getTime()},a.util.extend=function(a,b){return b.prototype=Object.create(a.prototype),b.prototype.constructor=b,b},a.util.structuredCloneSupport=function(){if(void 0!==a.util.structuredCloneSupport.cache)return a.util.structuredCloneSupport.cache;var b=!1;try{window.postMessage({toString:function(){b=!0},blob:new Blob},"*")}catch(c){b=!0}return a.util.structuredCloneSupport.cache=!b,a.util.structuredCloneSupport.cache},a.util.structuredCloneSupport.cache=void 0,a.util.clone=function(a){if(!Array.isArray(a)&&"object"!=typeof a)return a;try{return JSON.parse(JSON.stringify(a))}catch(b){console.log(b)}},a.util.arrayContainsAll=function(a,b,c){return c=c||function(a,b){return a===b},b.every(function(b){return a.some(function(a){return c(a,b)})})},a.util.objectContainsAll=function(a,b,c){c=c||function(a,b){return a===b};for(var d in b)if(!c(a[d],b[d]))return!1;return!0},a.util.parseQueryParams=function(a){a=a||window.location.search;for(var b,c={},d=/\??([^&=]+)=?([^&]*)/g;b=d.exec(a);)c[b[1]]=decodeURIComponent(b[2]);return c},a.util.ajax=function(b){var c=new a.AsyncAction,d=new XMLHttpRequest;return d.onreadystatechange=function(){4===d.readyState&&(200===d.status?c.resolve("success",JSON.parse(this.responseText)):c.resolve("failure",this.statusText,this.responseText))},d.open(b.method,b.href,!0),"POST"===b.method&&d.send(b.data),d.setRequestHeader("Content-Type","application/json"),d.setRequestHeader("Cache-Control","no-cache"),d.send(),c};var a=a||{};a.metricsStats=a.metricsStats||{},a.metricsStats.DEFAULT_POOL_SIZE=1028,a.metricsStats.Sample=function(){this.clear()},a.metricsStats.Sample.prototype.update=function(a){this.values.push(a)},a.metricsStats.Sample.prototype.clear=function(){this.values=[],this.count=0},a.metricsStats.Sample.prototype.size=function(){return this.values.length},a.metricsStats.Sample.prototype.getValues=function(){return this.values},a.metricsStats.UniformSample=a.util.extend(a.metricsStats.Sample,function(b){a.metricsStats.Sample.apply(this),this.limit=b||a.metricsStats.DEFAULT_POOL_SIZE}),a.metricsStats.UniformSample.prototype.update=function(a){if(this.count++,this.size()<this.limit)this.values.push(a);else{var b=parseInt(Math.random()*this.count);b<this.limit&&(this.values[b]=a)}};var a=a||{};a.metricsStats=a.metricsStats||{},a.metricsStats.BinaryHeap=function(a){this.content=[],this.scoreFunction=a},a.metricsStats.BinaryHeap.prototype={clone:function(){var b=new a.metricsStats.BinaryHeap(this.scoreFunction);return b.content=JSON.parse(JSON.stringify(this.content)),b},push:function(a){this.content.push(a),this.bubbleUp(this.content.length-1)},peek:function(){return this.content[0]},pop:function(){var a=this.content[0],b=this.content.pop();return this.content.length>0&&(this.content[0]=b,this.sinkDown(0)),a},remove:function(a){for(var b=this.content.length,c=0;b>c;c++)if(this.content[c]==a){var d=this.content.pop();return c!=b-1&&(this.content[c]=d,this.scoreFunction(d)<this.scoreFunction(a)?this.bubbleUp(c):this.sinkDown(c)),!0}throw new Error("Node not found.")},size:function(){return this.content.length},bubbleUp:function(a){for(var b=this.content[a];a>0;){var c=Math.floor((a+1)/2)-1,d=this.content[c];if(!(this.scoreFunction(b)<this.scoreFunction(d)))break;this.content[c]=b,this.content[a]=d,a=c}},sinkDown:function(a){for(var b=this.content.length,c=this.content[a],d=this.scoreFunction(c);;){var e=2*(a+1),f=e-1,g=null;if(b>f){var h=this.content[f],i=this.scoreFunction(h);d>i&&(g=f)}if(b>e){var j=this.content[e],k=this.scoreFunction(j);(null==g?d:i)>k&&(g=e)}if(null==g)break;this.content[a]=this.content[g],this.content[g]=c,a=g}}};var a=a||{};a.metricsStats=a.metricsStats||{},a.metricsStats.DEFAULT_RESCALE_THRESHOLD=36e5,a.metricsStats.DEFAULT_DECAY_ALPHA=.015,a.metricsStats.ExponentiallyDecayingSample=a.util.extend(a.metricsStats.Sample,function(b,c){a.metricsStats.Sample.apply(this),this.limit=b||a.metricsStats.DEFAULT_POOL_SIZE,this.alpha=c||a.metricsStats.DEFAULT_DECAY_ALPHA,this.rescaleThreshold=a.metricsStats.DEFAULT_RESCALE_THRESHOLD}),a.metricsStats.ExponentiallyDecayingSample.prototype.getValues=function(){for(var a,b=[],c=this.values.clone();a=c.pop();)b.push(a.val);return b},a.metricsStats.ExponentiallyDecayingSample.prototype.size=function(){return this.values.size()},a.metricsStats.ExponentiallyDecayingSample.prototype.newHeap=function(){return new a.metricsStats.BinaryHeap(function(a){return a.priority})},a.metricsStats.ExponentiallyDecayingSample.prototype.now=function(){return a.util.now()},a.metricsStats.ExponentiallyDecayingSample.prototype.tick=function(){return this.now()/1e3},a.metricsStats.ExponentiallyDecayingSample.prototype.clear=function(){this.values=this.newHeap(),this.count=0,this.startTime=this.tick(),this.nextScaleTime=this.now()+this.rescaleThreshold},a.metricsStats.ExponentiallyDecayingSample.prototype.update=function(a,b){void 0==b?b=this.tick():b/=1e3;var c=this.weight(b-this.startTime)/Math.random(),d={val:a,priority:c};if(this.count<this.limit)this.count+=1,this.values.push(d);else{var e=this.values.peek();e.priority<c&&(this.values.push(d),this.values.pop())}this.now()>this.nextScaleTime&&this.rescale()},a.metricsStats.ExponentiallyDecayingSample.prototype.weight=function(a){return Math.exp(this.alpha*a)},a.metricsStats.ExponentiallyDecayingSample.prototype.rescale=function(){this.nextScaleTime=this.now()+this.rescaleThreshold;var a=this.values.content,b=[],c=this.startTime;this.startTime=this.tick();for(var d=0;d<a.length;d++)b.push({val:a[d].val,priority:a[d].priority*Math.exp(-this.alpha*(this.startTime-c))});this.values.content=b};var a=a||{};a.metricsStats=a.metricsStats||{},a.metricsStats.M1_ALPHA=1-Math.exp(-5/60),a.metricsStats.M5_ALPHA=1-Math.exp(-5/60/5),a.metricsStats.M15_ALPHA=1-Math.exp(-5/60/15),a.metricsStats.ExponentiallyWeightedMovingAverage=function(b,c){this.alpha=b,this.interval=c||5e3,this.currentRate=null,this.uncounted=0,this.lastTick=a.util.now()},a.metricsStats.ExponentiallyWeightedMovingAverage.prototype.update=function(a){this.uncounted+=a||1,this.tick()},a.metricsStats.ExponentiallyWeightedMovingAverage.prototype.tick=function(){var b=a.util.now(),c=b-this.lastTick;if(c>this.interval){this.lastTick=b-c%this.interval;for(var d=Math.floor(c/this.interval),e=0;d>e;++e){var f=this.uncounted/this.interval;this.uncounted=0,null!==this.currentRate?this.currentRate+=this.alpha*(f-this.currentRate):this.currentRate=f}}},a.metricsStats.ExponentiallyWeightedMovingAverage.prototype.rate=function(){return 1e3*this.currentRate};var a=a||{};a.metricTypes=a.metricTypes||{},a.metricTypes.BaseMetric=function(){this.value=0,this.name="",this.unitName=""},a.metricTypes.BaseMetric.prototype.get=function(){return this.value},a.metricTypes.BaseMetric.prototype.unit=function(a){return a?(this.unitName=a,this):this.unitName},a.metricTypes.Counter=a.util.extend(a.metricTypes.BaseMetric,function(){a.metricTypes.BaseMetric.apply(this,arguments),this.value=0}),a.metricTypes.Counter.prototype.inc=function(a){return this.value+=a?a:1},a.metricTypes.Counter.prototype.dec=function(a){return this.value-=a?a:1},a.metricTypes=a.metricTypes||{},a.metricTypes.Gauge=a.util.extend(a.metricTypes.BaseMetric,function(b){a.metricTypes.BaseMetric.apply(this,arguments),this.callback=b}),a.metricTypes.Gauge.prototype.set=function(a){return this.callback=a,this},a.metricTypes.Gauge.prototype.get=function(){return this.callback?this.callback():void 0},a.metricTypes.Histogram=a.util.extend(a.metricTypes.BaseMetric,function(){a.metricTypes.BaseMetric.apply(this,arguments),this.sample=new a.metricsStats.ExponentiallyDecayingSample,this.clear()}),a.metricTypes.Histogram.prototype.clear=function(){this.sample.clear(),this.min=this.max=null,this.varianceMean=0,this.varianceM2=0,this.sum=0,this.count=0},a.metricTypes.Histogram.prototype.mark=function(b,c){c=c||a.util.now(),this.sample.update(b,c),this.max=null===this.max?b:Math.max(this.max,b),this.min=null===this.min?b:Math.min(this.min,b),this.sum+=b,this.count++;var d=b-this.varianceMean;return this.varianceMean+=d/this.count,this.varianceM2+=d*(b-this.varianceMean),this.count},a.metricTypes.Histogram.prototype.get=function(){var a=this.sample.getValues().map(function(a){return parseFloat(a)}).sort(function(a,b){return a-b}),b=function(b){var c=b*a.length;if(c>=a.length)return a[a.length-1];c=Math.max(0,c),c=Math.min(c,a.length+1);var d=a[Math.floor(c)-1],e=a[Math.floor(c)];return d+(c-Math.floor(c))*(e-d)};return{percentile_10:b(.1),percentile_25:b(.25),median:b(.5),percentile_75:b(.75),percentile_90:b(.9),percentile_95:b(.95),percentile_99:b(.99),percentile_999:b(.999),variance:this.count<1?null:this.varianceM2/(this.count-1),mean:0===this.count?null:this.varianceMean,stdDev:this.count<1?null:Math.sqrt(this.varianceM2/(this.count-1)),count:this.count,sum:this.sum,max:this.max,min:this.min}},a.metricTypes.Meter=a.util.extend(a.metricTypes.BaseMetric,function(){a.metricTypes.BaseMetric.apply(this,arguments),this.m1Rate=new a.metricsStats.ExponentiallyWeightedMovingAverage(a.metricsStats.M1_ALPHA),this.m5Rate=new a.metricsStats.ExponentiallyWeightedMovingAverage(a.metricsStats.M5_ALPHA),this.m15Rate=new a.metricsStats.ExponentiallyWeightedMovingAverage(a.metricsStats.M15_ALPHA),this.startTime=a.util.now(),this.value=0}),a.metricTypes.Meter.prototype.mark=function(a){return a=a||1,this.value+=a,this.m1Rate.update(a),this.m5Rate.update(a),this.m15Rate.update(a),this.value},a.metricTypes.Meter.prototype.get=function(){return{rate_1m:this.m1Rate.rate(),rate_5m:this.m5Rate.rate(),rate_15m:this.m15Rate.rate(),rate_mean:this.value/(a.util.now()-this.startTime)*1e3,count:this.value}},a.metricTypes.Meter.prototype.tick=function(){this.m1Rate.tick(),this.m5Rate.tick(),this.m15Rate.tick()},a.metricTypes.Timer=a.util.extend(a.metricTypes.BaseMetric,function(){a.metricTypes.BaseMetric.apply(this,arguments),this.meter=new a.metricTypes.Meter,this.histogram=new a.metricTypes.Histogram}),a.metricTypes.Timer.prototype.mark=function(a,b){this.meter.mark(),this.histogram.mark(a,b)},a.metricTypes.Timer.prototype.start=function(){var b=this,c=a.util.now();return function(){var d=a.util.now();b.mark(d-c,d)}},a.metricTypes.Timer.prototype.time=function(b){var c=a.util.now();try{b()}finally{var d=a.util.now();this.mark(d-c,d)}},a.metricTypes.Timer.prototype.get=function(){var a=this.histogram.get(),b=this.meter.get();for(var c in b)a[c]=b[c];return a};var a=a||{};a.MetricsRegistry=function(){this.metrics={};var a=this;this.gauge("registry.metrics.types").set(function(){return Object.keys(a.metrics).length})},a.MetricsRegistry.prototype.findOrCreateMetric=function(a,b){var c=this.metrics[a];return c?c instanceof b?c:null:(c=this.metrics[a]=new b,c.name=a,c)},a.MetricsRegistry.prototype.makeName=function(a){return Array.prototype.slice.call(a).join(".")},a.MetricsRegistry.prototype.counter=function(){return this.findOrCreateMetric(this.makeName(arguments),a.metricTypes.Counter)},a.MetricsRegistry.prototype.meter=function(){return this.findOrCreateMetric(this.makeName(arguments),a.metricTypes.Meter)},a.MetricsRegistry.prototype.gauge=function(){return this.findOrCreateMetric(this.makeName(arguments),a.metricTypes.Gauge)},a.MetricsRegistry.prototype.histogram=function(){return this.findOrCreateMetric(this.makeName(arguments),a.metricTypes.Histogram)},a.MetricsRegistry.prototype.timer=function(){return this.findOrCreateMetric(this.makeName(arguments),a.metricTypes.Timer)},a.MetricsRegistry.prototype.register=function(a,b){return this.metrics[this.makeName(a)]=b,b},a.MetricsRegistry.prototype.toJson=function(){var a={};for(var b in this.metrics){for(var c=b.split("."),d=a;c.length>1;){var e=c.shift();d=d[e]=d[e]||{}}d[c[0]]=this.metrics[b].get()}return a},a.MetricsRegistry.prototype.allMetrics=function(){var a=[];for(var b in this.metrics)a.push(this.metrics[b]);return a},a.metrics=new a.MetricsRegistry,a.abacPolicies={},a.abacPolicies.permitWhenObjectHasNoAttributes=function(a){return a.object&&0===Object.keys(a.object).length?"permit":"undetermined"},a.abacPolicies.subjectHasAllObjectAttributes=function(b){if(!b.object)return"permit";var c=b.subject||{};return a.util.objectContainsAll(c,b.object,this.implies)?"permit":"deny"},a.abacPolicies.permitAll=function(){return"permit"};var a=a||{};a.BasicAuthentication=function(){this.roles={};var b=this;a.metrics.gauge("security.authentication.roles").set(function(){return b.getRoleCount()})},a.BasicAuthentication.prototype.getRoleCount=function(){return this.roles&&Object.keys(this.roles)?Object.keys(this.roles).length:0},a.BasicAuthentication.prototype.login=function(b,c){if(!b)throw"Must supply credentials for login";var d=new a.AsyncAction;return c=c||[],d.resolve("success",c)};var a=a||{};a.BasicAuthorization=function(b){b=b||{},this.roles={},this.policies=b.policies||[a.abacPolicies.permitWhenObjectHasNoAttributes,a.abacPolicies.subjectHasAllObjectAttributes];
var c=this;a.metrics.gauge("security.authorization.roles").set(function(){return c.getRoleCount()})},a.BasicAuthorization.prototype.getRoleCount=function(){return this.roles&&Object.keys(this.roles)?Object.keys(this.roles).length:0},a.BasicAuthorization.prototype.implies=function(b,c){return void 0===c||null===c?!0:void 0===b||null===b?!1:(b=Array.isArray(b)?b:[b],c=Array.isArray(c)?c:[c],a.util.arrayContainsAll(b,c))},a.BasicAuthorization.prototype.isPermitted=function(b){var c=new a.AsyncAction,d=this.policies.some(function(a){return"permit"===a.call(this,b)},this);return c.resolve(d?"success":"failure")},a.authorization=new a.BasicAuthorization;var a=a||{};a.KeyBroadcastLocalStorageLink=function(b){b=b||{},this.prefix=b.prefix||"ozpIwc",this.peer=b.peer||a.defaultPeer,this.selfId=b.selfId||this.peer.selfId,this.myKeysTimeout=b.myKeysTimeout||5e3,this.otherKeysTimeout=b.otherKeysTimeout||12e4,this.maxRetries=b.maxRetries||6,this.queueSize=b.queueSize||1024,this.sendQueue=this.sendQueue||[],this.fragmentSize=b.fragmentSize||1310720,this.fragmentTimeout=b.fragmentTimeout||1e3,String.prototype.chunk=function(a){for(var b=[],c=0;c<this.length;c+=a)b.push(this.slice(c,c+a));return b};var c,d=this,e=function(b){try{c=JSON.parse(b.key)}catch(e){return console.log("Parse error on "+b.key),void a.metrics.counter("links.keyBroadcastLocalStorage.packets.parseError").inc()}c.data.fragment?d.handleFragment(c):(d.peer.receive(d.linkId,c),a.metrics.counter("links.keyBroadcastLocalStorage.packets.received").inc())};window.addEventListener("storage",e,!1),this.peer.on("send",function(a){d.send(a.packet)}),this.peer.on("beforeShutdown",function(){window.removeEventListener("storage",e)},this)},a.KeyBroadcastLocalStorageLink.prototype.handleFragment=function(b){if(!this.peer.haveSeen(b)){var c=b.data.msgId;this.storeFragment(b);var d=this.defragmentPacket(this.fragments[c]);if(d){window.clearTimeout(this.fragments[c].fragmentTimer);var e=this.peer.packetsSeen[d.src_peer].indexOf(d.sequence);delete this.peer.packetsSeen[d.src_peer][e],this.peer.receive(this.linkId,d),a.metrics.counter("links.keyBroadcastLocalStorage.packets.received").inc(),delete this.fragments[c]}}},a.KeyBroadcastLocalStorageLink.prototype.storeFragment=function(b){if(!b.data.fragment)return null;this.fragments=this.fragments||[];var c=b.sequence,d=b.src_peer,e=b.data.msgId,f=b.data.id,g=b.data.chunk,h=b.data.total;if(void 0===e||void 0===f)return null;if(!this.fragments[e]){this.fragments[e]={},this.fragments[e].chunks=[];var i=this;i.key=e,i.total=h,this.fragments[e].timeoutFunc=function(){a.metrics.counter("network.packets.dropped").inc(),a.metrics.counter("network.fragments.dropped").inc(i.total),delete i.fragments[i.key]}}return window.clearTimeout(this.fragments[e].fragmentTimer),this.fragments[e].fragmentTimer=window.setTimeout(this.fragments[e].timeoutFunc,this.fragmentTimeout),this.fragments[e].total=h||this.fragments[e].total,this.fragments[e].sequence=void 0!==c?c:this.fragments[e].sequence,this.fragments[e].src_peer=d||this.fragments[e].src_peer,this.fragments[e].chunks[f]=g,void 0===this.fragments[e].total||void 0===this.fragments[e].sequence||void 0===this.fragments[e].src_peer?null:(a.metrics.counter("links.keyBroadcastLocalStorage.fragments.received").inc(),!0)},a.KeyBroadcastLocalStorageLink.prototype.defragmentPacket=function(a){if(a.total!=a.chunks.length)return null;try{var b=JSON.parse(a.chunks.join(""));return{defragmented:!0,sequence:a.sequence,src_peer:a.src_peer,data:b}}catch(c){return null}},a.KeyBroadcastLocalStorageLink.prototype.send=function(a){var b=JSON.stringify(a.data);if(b.length<this.fragmentSize)this.queueSend(a);else{var c=b.chunk(this.fragmentSize),d=this;d.data=a.data,delete a.data;for(var e=function(a,b){return b.sequence=d.peer.sequenceCounter++,b.data={fragment:!0,msgId:d.data.msgId,id:f,total:c.length,chunk:a},b},f=0;f<c.length;f++)this.queueSend(e(c[f],a))}},a.KeyBroadcastLocalStorageLink.prototype.queueSend=function(b){if(this.sendQueue.length<this.queueSize)for(this.sendQueue=this.sendQueue.concat(b);this.sendQueue.length>0;)this.attemptSend(this.sendQueue.shift());else a.metrics.counter("links.keyBroadcastLocalStorage.packets.failed").inc(),a.log.error("Failed to write packet(len="+b.length+"): Send queue full.")},a.KeyBroadcastLocalStorageLink.prototype.attemptSend=function(b,c){var d=this.sendImpl(b);if(d){var e=this;c=c||0;var f=Math.max(1,Math.pow(2,c-1))-1;if(!(c<e.maxRetries))return a.metrics.counter("links.keyBroadcastLocalStorage.packets.failed").inc(),a.log.error("Failed to write packet(len="+b.length+"):"+d),d;c++,window.setTimeout(function(){e.attemptSend(b,c)},f)}},a.KeyBroadcastLocalStorageLink.prototype.sendImpl=function(b){var c;try{var d=JSON.stringify(b);localStorage.setItem(d,""),a.metrics.counter("links.keyBroadcastLocalStorage.packets.sent").inc(),localStorage.removeItem(d),c=null}catch(e){c=e}finally{return c}};var a=a||{};a.LocalStorageLink=function(b){b=b||{},this.prefix=b.prefix||"ozpIwc",this.peer=b.peer||a.defaultPeer,this.selfId=b.selfId||this.peer.selfId,this.myKeysTimeout=b.myKeysTimeout||5e3,this.otherKeysTimeout=b.otherKeysTimeout||12e4;var c=this,d=function(b){var d=c.splitKey(b.key);if(d){var e=JSON.parse(localStorage.getItem(b.key));e?"object"!=typeof e?a.metrics.counter("links.localStorage.packets.notAnObject").inc():(a.metrics.counter("links.localStorage.packets.receive").inc(),c.peer.receive(c.linkId,e)):a.metrics.counter("links.localStorage.packets.vanished").inc()}};window.addEventListener("storage",d,!1),this.peer.on("send",function(a){c.send(a.packet)}),this.peer.on("beforeShutdown",function(){c.cleanKeys(),window.removeEventListener("storage",d)},this),window.setInterval(function(){c.cleanKeys()},250),a.metrics.gauge("links.localStorage.buffer").set(function(){for(var b={used:0,max:5242880,bufferLen:0,peerUsage:{},peerPackets:{}},d=0;d<localStorage.length;++d){var e=localStorage.key(d),f=localStorage.getItem(e),g=2*f.length,h=a.util.now()-this.myKeysTimeout;b.used+=g;var i=c.splitKey(e);i&&(b.peerUsage[i.id]=b.peerUsage[i.id]?b.peerUsage[i.id]+g:g,b.peerPackets[i.id]=b.peerPackets[i.id]?b.peerPackets[i.id]+1:1,b.bufferLen++,i.createdAt<h&&(b.oldKeysCount++,b.oldKeysSize+=g))}return b})},a.LocalStorageLink.prototype.makeKey=function(b){return[this.prefix,this.selfId,a.util.now(),b].join("|")},a.LocalStorageLink.prototype.splitKey=function(a){var b=a.split("|");return 4===b.length&&b[0]===this.prefix?{id:b[1],createdAt:parseInt(b[2])}:null},a.LocalStorageLink.prototype.cleanKeys=function(){for(var b=a.util.now(),c=b-this.myKeysTimeout,d=b-this.otherKeysTimeout,e=0;e<localStorage.length;++e){var f=localStorage.key(e),g=this.splitKey(f);g&&(g.id===this.selfId&&g.createdAt<=c||g.createdAt<=d)&&localStorage.removeItem(f)}},a.LocalStorageLink.prototype.send=function(b){localStorage.setItem(this.makeKey(b.sequence),JSON.stringify(b)),a.metrics.counter("links.localStorage.packets.sent").inc()};var a=a||{};a.Peer=function(){this.selfId=a.util.generateId(),this.sequenceCounter=0,this.packetsSeen={},this.knownPeers={},this.events=new a.Event,this.events.mixinOnOff(this);var b=this;this.unloadListener=function(){b.shutdown()},window.addEventListener("beforeunload",this.unloadListener)},a.Peer.maxSeqIdPerSource=500,a.Peer.prototype.haveSeen=function(b){if(b.src_peer===this.selfId)return a.metrics.counter("network.packets.droppedOwnPacket").inc(),!0;var c=this.packetsSeen[b.src_peer];return c||(c=this.packetsSeen[b.src_peer]=[]),c.indexOf(b.sequence)>=0?!0:(c.unshift(b.sequence),c.length>=a.Peer.maxSeqIdPerSource&&(c.length=a.Peer.maxSeqIdPerSource),!1)},a.Peer.prototype.send=function(b){var c={src_peer:this.selfId,sequence:this.sequenceCounter++,data:b},d=new a.CancelableEvent({packet:c});this.events.trigger("preSend",d),d.canceled?a.metrics.counter("network.packets.sendRejected").inc():(a.metrics.counter("network.packets.sent").inc(),this.events.trigger("send",{packet:c}))},a.Peer.prototype.receive=function(b,c){return this.haveSeen(c)?void a.metrics.counter("network.packets.dropped").inc():(a.metrics.counter("network.packets.received").inc(),void this.events.trigger("receive",{packet:c,linkId:b}))},a.Peer.prototype.shutdown=function(){this.events.trigger("beforeShutdown"),window.removeEventListener("beforeunload",this.unloadListener)};var a=a||{};a.Participant=function(){this.events=new a.Event,this.events.mixinOnOff(this),this.securityAttributes={},this.msgId=0;var b=new a.metricTypes.Meter;this.sentPacketsMeter=b,this.receivedPacketsMeter=b,this.forbiddenPacketsMeter=b},a.Participant.prototype.receiveFromRouter=function(b){var c=this;a.authorization.isPermitted({subject:this.securityAttributes,object:b.packet.permissions}).success(function(){c.receivedPacketsMeter.mark(),c.receiveFromRouterImpl(b)}).failure(function(){c.forbiddenPacketsMeter.mark()})},a.Participant.prototype.receiveFromRouterImpl=function(a){return!a},a.Participant.prototype.connectToRouter=function(b,c){this.address=c,this.router=b,this.securityAttributes.rawAddress=c,this.msgId=0,this.metricRoot="participants."+this.address.split(".").reverse().join("."),this.sentPacketsMeter=a.metrics.meter(this.metricRoot,"sentPackets").unit("packets"),this.receivedPacketsMeter=a.metrics.meter(this.metricRoot,"receivedPackets").unit("packets"),this.forbiddenPacketsMeter=a.metrics.meter(this.metricRoot,"forbiddenPackets").unit("packets"),this.events.trigger("connectedToRouter")},a.Participant.prototype.fixPacket=function(b){return b.src=b.src||this.address,b.ver=b.ver||1,b.msgId=b.msgId||this.generateMsgId(),b.time=b.time||a.util.now(),b},a.Participant.prototype.send=function(a){return a=this.fixPacket(a),this.sentPacketsMeter.mark(),this.router.send(a,this),a},a.Participant.prototype.generateMsgId=function(){return"i:"+this.msgId++},a.Participant.prototype.heartbeatStatus=function(){return{address:this.address,securityAttributes:this.securityAttributes,type:this.participantType||this.constructor.name,name:this.name}},a.InternalParticipant=a.util.extend(a.Participant,function(b){b=b||{},a.Participant.apply(this,arguments),this.replyCallbacks={},this.participantType="internal",this.name=b.name;var c=this;this.on("connectedToRouter",function(){a.metrics.gauge(c.metricRoot,"registeredCallbacks").set(function(){return c.getCallbackCount()})})}),a.InternalParticipant.prototype.getCallbackCount=function(){return!this.replyCallbacks|!Object.keys(this.replyCallbacks)?0:Object.keys(this.replyCallbacks).length},a.InternalParticipant.prototype.receiveFromRouterImpl=function(a){var b=a.packet;b.replyTo&&this.replyCallbacks[b.replyTo]?this.replyCallbacks[b.replyTo](b)||this.cancelCallback(b.replyTo):this.events.trigger("receive",b)},a.InternalParticipant.prototype.send=function(b,c){var b=this.fixPacket(b);return c&&(this.replyCallbacks[b.msgId]=c),a.Participant.prototype.send.apply(this,arguments),b},a.InternalParticipant.prototype.cancelCallback=function(a){var b=!1;return a&&(delete this.replyCallbacks[a],b=!0),b};var a=a||{};a.TransportPacketContext=function(a){for(var b in a)this[b]=a[b]},a.TransportPacketContext.prototype.replyTo=function(a){var b=(new Date).getTime();return a.ver=a.ver||1,a.time=a.time||b,a.msgId=a.msgId||b,a.replyTo=a.replyTo||this.packet.msgId,a.src=a.src||this.packet.dst,a.dst=a.dst||this.packet.src,this.dstParticipant?this.dstParticipant.send(a):this.router.send(a),a},a.Router=function(b){b=b||{},this.peer=b.peer||a.defaultPeer;var c=this;this.self_id=a.util.generateId(),this.participants={},a.metrics.gauge("transport.participants").set(function(){return Object.keys(c.participants).length}),this.events=new a.Event,this.events.mixinOnOff(this),this.peer.on("receive",function(a){c.receiveFromPeer(a.packet)});var d=function(b){var c=b.packet;1!==c.ver&&b.cancel("badVersion"),c.src||b.cancel("nullSource"),c.dst||b.cancel("nullDestination"),b.canceled&&a.metrics.counter("transport.packets.invalidFormat").inc()};this.events.on("preSend",d),this.watchdog=new a.RouterWatchdog({router:this}),this.registerParticipant(this.watchdog),a.metrics.gauge("transport.router.participants").set(function(){return c.getParticipantCount()})},a.Router.prototype.getParticipantCount=function(){return this.participants&&Object.keys(this.participants)?Object.keys(this.participants).length:0},a.Router.prototype.shutdown=function(){this.watchdog.shutdown()},a.Router.prototype.registerParticipant=function(b,c){c=c||{};var d;do d=a.util.generateId()+"."+this.self_id;while(this.participants.hasOwnProperty(d));var e=new a.CancelableEvent({packet:c,registration:c.entity,participant:b});if(this.events.trigger("preRegisterParticipant",e),e.canceled)return a.log.log("registeredParticipant[DENIED] origin:"+b.origin+" because "+e.cancelReason),null;this.participants[d]=b,b.connectToRouter(this,d);var f=new a.CancelableEvent({packet:c,participant:b});return this.events.trigger("registeredParticipant",f),d},a.Router.prototype.deliverLocal=function(b,c){if(!b)throw"Cannot deliver a null packet!";var d=this.participants[b.dst];if(d){var e=new a.TransportPacketContext({packet:b,router:this,srcParticipant:c,dstParticipant:d}),f=new a.CancelableEvent({packet:b,dstParticipant:d,srcParticipant:c});return this.events.trigger("preDeliver",f).canceled?void a.metrics.counter("transport.packets.rejected").inc():void a.authorization.isPermitted({subject:d.securityAttributes,object:b.permissions,action:{action:"receive"}}).success(function(){a.metrics.counter("transport.packets.delivered").inc(),d.receiveFromRouter(e)}).failure(function(){a.metrics.counter("transport.packets.forbidden").inc()})}},a.Router.prototype.registerMulticast=function(b,c){var d=this;return c.forEach(function(c){var e=d.participants[c];if(e||(e=d.participants[c]=new a.MulticastParticipant(c),e.connectToRouter(this,c)),e.addMember(b),b.address){var f=new a.CancelableEvent({entity:{group:c,address:b.address}});d.events.trigger("registeredMulticast",f)}else console.log("no address for "+b.participantType+" "+b.name+"with address "+b.address+" for group "+c)}),c},a.Router.prototype.send=function(b,c){var d=new a.CancelableEvent({packet:b,participant:c});return this.events.trigger("preSend",d),d.canceled?void a.metrics.counter("transport.packets.sendCanceled"):(a.metrics.counter("transport.packets.sent").inc(),this.deliverLocal(b,c),this.events.trigger("send",{packet:b}),void this.peer.send(b))},a.Router.prototype.receiveFromPeer=function(b){a.metrics.counter("transport.packets.receivedFromPeer").inc();var c=new a.CancelableEvent({packet:b.data,rawPacket:b});this.events.trigger("prePeerReceive",c),c.canceled||this.deliverLocal(b.data)};var a=a||{};a.LeaderGroupParticipant=a.util.extend(a.Participant,function(b){if(a.Participant.apply(this,arguments),!b.name)throw"Config must contain a name value";this.name=b.name,this.electionAddress=b.electionAddress||this.name+".election",this.priority=b.priority||a.defaultLeaderPriority||Math.random(),this.priorityLessThan=b.priorityLessThan||function(a,b){return b>a},this.electionTimeout=b.electionTimeout||250,this.leaderState="connecting",this.electionQueue=[],this.leader=null,this.leaderPriority=null,this.participantType="leaderGroup",this.name=b.name,this.on("startElection",function(){this.electionQueue=[]},this),this.on("becameLeader",function(){this.electionQueue.forEach(function(a){this.forwardToTarget(a)},this),this.electionQueue=[]},this),this.on("newLeader",function(){this.electionQueue=[]},this);var c=this;window.addEventListener("beforeunload",function(){c.leaderPriority=0,c.startElection()}),a.metrics.gauge("transport.leaderGroup.election").set(function(){var a=c.getElectionQueue();return{queue:a?a.length:0}}),this.on("connectedToRouter",function(){this.router.registerMulticast(this,[this.electionAddress,this.name]),this.startElection()},this)}),a.LeaderGroupParticipant.prototype.getElectionQueue=function(){return this.electionQueue},a.LeaderGroupParticipant.prototype.fixPacket=function(b){return b.src=b.src||this.name,a.Participant.prototype.fixPacket.apply(this,arguments)},a.LeaderGroupParticipant.prototype.inElection=function(){return!!this.electionTimer},a.LeaderGroupParticipant.prototype.isLeader=function(){return this.leader===this.address},a.LeaderGroupParticipant.prototype.sendElectionMessage=function(a){this.send({src:this.address,dst:this.electionAddress,action:a,entity:{priority:this.priority}})},a.LeaderGroupParticipant.prototype.startElection=function(){if(!this.inElection()){this.leaderState="election",this.events.trigger("startElection");var a=this;this.electionTimer=window.setTimeout(function(){a.cancelElection(),a.leader=a.address,a.leaderPriority=a.priority,a.leaderState="leader",a.sendElectionMessage("victory"),a.events.trigger("becameLeader")},this.electionTimeout),this.sendElectionMessage("election")}},a.LeaderGroupParticipant.prototype.cancelElection=function(){this.electionTimer&&(window.clearTimeout(this.electionTimer),this.electionTimer=null,this.events.trigger("endElection"))},a.LeaderGroupParticipant.prototype.receiveFromRouterImpl=function(a){var b=a.packet;if(a.leaderState=this.leaderState,b.dst!==this.electionAddress)this.forwardToTarget(a);else{if(b.src===this.address)return;"election"===b.action?this.handleElectionMessage(b):"victory"===b.action&&this.handleVictoryMessage(b)}},a.LeaderGroupParticipant.prototype.forwardToTarget=function(a){return"election"===this.leaderState||"connecting"===this.leaderState?void this.electionQueue.push(a):(a.leaderState=this.leaderState,void this.events.trigger("receive",a))},a.LeaderGroupParticipant.prototype.handleElectionMessage=function(a){this.priorityLessThan(a.entity.priority,this.priority)?this.startElection():this.cancelElection()},a.LeaderGroupParticipant.prototype.handleVictoryMessage=function(a){this.priorityLessThan(a.entity.priority,this.priority)?this.startElection():(this.leader=a.src,this.leaderPriority=a.entity.priority,this.cancelElection(),this.leaderState="member",this.events.trigger("newLeader"))},a.LeaderGroupParticipant.prototype.heartbeatStatus=function(){var b=a.Participant.prototype.heartbeatStatus.apply(this,arguments);return b.leaderState=this.leaderState,b.leaderPriority=this.priority,b};var a=a||{};a.MulticastParticipant=a.util.extend(a.Participant,function(b){a.Participant.apply(this,arguments),this.name=b,this.participantType="multicast",this.members=[]}),a.MulticastParticipant.prototype.receiveFromRouterImpl=function(a){return this.members.forEach(function(b){a.dstParticipant=b,b.receiveFromRouter(a)}),!1},a.MulticastParticipant.prototype.addMember=function(a){this.members.push(a)},a.MulticastParticipant.prototype.heartbeatStatus=function(){var b=a.Participant.prototype.heartbeatStatus.apply(this,arguments);return b.members=this.members.map(function(a){return a.address}),b};var a=a||{};a.PostMessageParticipant=a.util.extend(a.Participant,function(b){a.Participant.apply(this,arguments),this.origin=this.name=b.origin,this.sourceWindow=b.sourceWindow,this.credentials=b.credentials,this.participantType="postMessageProxy",this.securityAttributes.origin=this.origin,this.on("connectedToRouter",function(){this.securityAttributes.sendAs=this.address,this.securityAttributes.receiveAs=this.address},this)}),a.PostMessageParticipant.prototype.receiveFromRouterImpl=function(b){var c=this;return a.authorization.isPermitted({subject:this.securityAttributes,object:{receiveAs:b.packet.dst}}).success(function(){c.sendToRecipient(b.packet)}).failure(function(){a.metrics.counter("transport.packets.forbidden").inc()})},a.PostMessageParticipant.prototype.sendToRecipient=function(b){var c=b;a.util.structuredCloneSupport()||(c=JSON.stringify(b)),this.sourceWindow.postMessage(c,this.origin)},a.PostMessageParticipant.prototype.handleTransportPacket=function(b){var c={ver:1,dst:this.address,src:"$transport",replyTo:b.msgId,msgId:this.generateMsgId(),entity:{address:this.address}};this.sendToRecipient(c);var d=a.namesApi.findOrMakeValue({resource:"/address/"+this.address,contentType:"ozp-address-collection-v1+json",entity:this}),b={src:this.address,entity:this,dst:"names.api"};d.set(b)},a.PostMessageParticipant.prototype.forwardFromPostMessage=function(b,c){return"object"!=typeof b?void a.log.error("Unknown packet received: "+JSON.stringify(b)):c.origin!==this.origin?void a.metrics.counter("transport."+this.address+".invalidSenderOrigin").inc():(b=this.fixPacket(b),void("$transport"===b.dst?this.handleTransportPacket(b):this.router.send(b,this)))},a.PostMessageParticipant.prototype.send=function(b){b=this.fixPacket(b);var c=this;return a.authorization.isPermitted({subject:this.securityAttributes,object:{sendAs:b.src}}).success(function(){c.router.send(b,this)}).failure(function(){a.metrics.counter("transport.packets.forbidden").inc()})},a.PostMessageParticipantListener=function(b){b=b||{},this.participants=[],this.router=b.router||a.defaultRouter;var c=this;window.addEventListener("message",function(a){c.receiveFromPostMessage(a)},!1),a.metrics.gauge("transport.postMessageListener.participants").set(function(){return c.getParticipantCount()})},a.PostMessageParticipantListener.prototype.getParticipantCount=function(){return this.participants?this.participants.length:0},a.PostMessageParticipantListener.prototype.findParticipant=function(a){for(var b=0;b<this.participants.length;++b)if(this.participants[b].sourceWindow===a)return this.participants[b]},a.PostMessageParticipantListener.prototype.receiveFromPostMessage=function(b){var c=this.findParticipant(b.source),d=b.data;"string"==typeof b.data&&(d=JSON.parse(b.data)),c||(c=new a.PostMessageParticipant({origin:b.origin,sourceWindow:b.source,credentials:d.entity}),this.router.registerParticipant(c,d),this.participants.push(c)),c.forwardFromPostMessage(d,b)},a.RouterWatchdog=a.util.extend(a.InternalParticipant,function(b){a.InternalParticipant.apply(this,arguments),this.participantType="routerWatchdog";var c=this;this.on("connected",function(){this.name=this.router.self_id},this),this.heartbeatFrequency=b.heartbeatFrequency||1e4;var c=this;this.timer=window.setInterval(function(){var a={dst:"names.api",action:"set",resource:"/router/"+c.router.self_id,entity:{participants:{}}};for(var b in c.router.participants)a.entity.participants[b]=c.router.participants[b].heartbeatStatus();c.send(a)},this.heartbeatFrequency),this.on("connected",this.setupWatches,this)}),a.RouterWatchdog.prototype.setupWatches=function(){this.name=this.router.self_id;var b=this,c=a.namesApi.findOrMakeValue({resource:"/address/"+b.address,contentType:"ozp-address-collection-v1+json"}),d={src:b.address,entity:b,dst:"names.api"};c.set(d),this.router.on("registeredParticipant",function(b){var c=b.participant.address||b.participant.electionAddress;if(c){var d=a.namesApi.findOrMakeValue({resource:"/address/"+c,contentType:"ozp-address-object-v1+json"}),e={src:c,entity:b.participant,dst:"names.api"};d.set(e)}}),this.router.on("registeredMulticast",function(b){var c=b.entity,d=a.namesApi.findOrMakeValue({resource:"/multicast/"+c.group,contentType:"ozp-multicast-object-v1+json"}),e={src:c.address,entity:c.address,dst:"names.api"};d.set(e)})},a.RouterWatchdog.prototype.shutdown=function(){window.clearInterval(this.timer)},a.CommonApiBase=function(b){b=b||{},this.participant=b.participant,this.participant.on("receive",a.CommonApiBase.prototype.routePacket,this),this.events=new a.Event,this.events.mixinOnOff(this),this.data={}},a.CommonApiBase.prototype.makeValue=function(){throw new Error("Subclasses of CommonApiBase must implement the makeValue(packet) function.")},a.CommonApiBase.prototype.isPermitted=function(b,c){var d=c.srcSubject||{rawAddress:c.packet.src};return a.authorization.isPermitted({subject:d,object:b.permissions,action:{action:c.action}})},a.CommonApiBase.prototype.notifyWatchers=function(a,b){a.eachWatcher(function(c){var d={dst:c.src,replyTo:c.msgId,action:"changed",resource:a.resource,permissions:a.permissions,entity:b};this.participant.send(d)},this)},a.CommonApiBase.prototype.findOrMakeValue=function(b){if(null===b.resource||void 0===b.resource)return new a.CommonApiValue;var c=this.data[b.resource];return c||(c=this.data[b.resource]=this.makeValue(b)),c},a.CommonApiBase.prototype.hasKey=function(a){return a in this.data},a.CommonApiBase.prototype.createKey=function(b){b=b||"";var c;do c=b+a.util.generateId();while(this.hasKey(c));return c},a.CommonApiBase.prototype.routePacket=function(a){var b=a.packet;if("leader"===a.leaderState){var c;this.events.trigger("receive",a),c=null===b.resource||void 0===b.resource?"rootHandle":"handle",b.action?c+=b.action.charAt(0).toUpperCase()+b.action.slice(1).toLowerCase():c="defaultHandler",c&&"function"==typeof this[c]||(c="defaultHandler");var d=this.findOrMakeValue(a.packet);this.invokeHandler(d,a,this[c])}},a.CommonApiBase.prototype.defaultHandler=function(a,b){b.replyTo({action:"badAction",entity:b.packet.action})},a.CommonApiBase.prototype.validateResource=function(){return!0},a.CommonApiBase.prototype.validatePreconditions=function(a,b){return!b.packet.ifTag||b.packet.ifTag===a.version},a.CommonApiBase.prototype.invokeHandler=function(a,b,c){var d=this.isPermitted(a,b);d.failure(function(){b.replyTo({action:"noPerm"})}).success(function(){if(!this.validateResource(a,b))return void b.replyTo({action:"badResource"});if(!this.validatePreconditions(a,b))return void b.replyTo({action:"noMatch"});var d=a.snapshot();c.call(this,a,b);var e=a.changesSince(d);e&&this.notifyWatchers(a,e)},this)},a.CommonApiBase.prototype.handleGet=function(a,b){b.replyTo(a.toPacket({action:"ok"}))},a.CommonApiBase.prototype.handleSet=function(a,b){a.set(b.packet),b.replyTo({action:"ok"})},a.CommonApiBase.prototype.handleDelete=function(a,b){a.deleteData(),b.replyTo({action:"ok"})},a.CommonApiBase.prototype.handleWatch=function(a,b){a.watch(b.packet),b.replyTo({action:"ok"})},a.CommonApiBase.prototype.handleUnwatch=function(a,b){a.unwatch(b.packet),b.replyTo({action:"ok"})},a.CommonApiBase.prototype.rootHandleList=function(a,b){b.replyTo({action:"ok",entity:Object.keys(this.data)})},a.CommonApiValue=function(a){a=a||{},this.watchers=[],this.resource=a.resource,this.entity=a.entity,this.contentType=a.contentType,this.permissions=a.permissions||{},this.version=a.version||0},a.CommonApiValue.prototype.set=function(a){this.isValidContentType(a.contentType)&&(this.permissions=a.permissions||this.permissions,this.contentType=a.contentType,this.entity=a.entity,this.version++)},a.CommonApiValue.prototype.watch=function(a){this.watchers.push({src:a.src,msgId:a.msgId})},a.CommonApiValue.prototype.unwatch=function(a){this.watchers=this.watchers.filter(function(b){return a.replyTo!==b.msgId&&a.src!==b.src})},a.CommonApiValue.prototype.eachWatcher=function(a,b){return b=b||this,this.watchers.map(a,b)},a.CommonApiValue.prototype.deleteData=function(){this.entity=void 0,this.contentType=void 0,this.permissions=[],this.version=0},a.CommonApiValue.prototype.toPacket=function(b){return b=b||{},b.entity=a.util.clone(this.entity),b.contentType=this.contentType,b.permissions=a.util.clone(this.permissions),b.eTag=this.version,b.resource=this.resource,b},a.CommonApiValue.prototype.isValidContentType=function(){return!0},a.CommonApiValue.prototype.snapshot=function(){return this.toPacket()},a.CommonApiValue.prototype.changesSince=function(b){return b.eTag===this.version?null:{newValue:a.util.clone(this.entity),oldValue:b.entity}};var a=a||{};a.DataApi=a.util.extend(a.CommonApiBase,function(){a.CommonApiBase.apply(this,arguments)}),a.DataApi.prototype.makeValue=function(b){return new a.DataApiValue({resource:b.resource})},a.DataApi.prototype.createChild=function(a,b){var c=this.createKey(a.resource+"/"),d=this.findOrMakeValue({resource:c});return d.set(b.packet),d},a.DataApi.prototype.handleList=function(a,b){b.replyTo({action:"ok",entity:a.listChildren()})},a.DataApi.prototype.handleAddchild=function(a,b){var c=this.createChild(a,b);a.addChild(c.resource),b.replyTo({action:"ok",entity:{resource:c.resource}})},a.DataApi.prototype.handleRemovechild=function(a,b){a.removeChild(b.packet.entity.resource),b.replyTo({action:"ok"})},a.DataApiValue=a.util.extend(a.CommonApiValue,function(b){a.CommonApiValue.apply(this,arguments),b=b||{},this.children=b.children||[]}),a.DataApiValue.prototype.addChild=function(a){this.children.indexOf(a)<0&&(this.children.push(a),this.version++)},a.DataApiValue.prototype.removeChild=function(a){var b=this.children.length;this.children=this.children.filter(function(b){return b!==a}),b!==this.children.length&&this.version++},a.DataApiValue.prototype.listChildren=function(){return a.util.clone(this.children)},a.DataApiValue.prototype.toPacket=function(){var b=a.CommonApiValue.prototype.toPacket.apply(this,arguments);return b.links=b.links||{},b.links.children=this.listChildren(),b},a.DataApiValue.prototype.changesSince=function(b){var c=a.CommonApiValue.prototype.changesSince.apply(this,arguments);return c&&(c.removedChildren=b.links.children.filter(function(a){return this.indexOf(a)<0},this.children),c.addedChildren=this.children.filter(function(a){return this.indexOf(a)<0},b.links.children)),c},a.IntentsApi=a.util.extend(a.CommonApiBase,function(b){a.CommonApiBase.apply(this,arguments),this.events.on("receive",a.IntentsApi.prototype.parseResource,this);b.href&&b.loadServerDataEmbedded?this.loadServerDataEmbedded({href:b.href}).success(function(){}):b.href&&b.loadServerData&&this.loadServerData({href:b.href}).success(function(){})}),a.IntentsApi.prototype.parseResource=function(a){if(a.packet.resource){var b=a.packet.resource.split("/"),c={type:b[1],subtype:b[2],verb:b[3],handler:b[4]};c.type&&c.subtype&&(c.verb?c.handler?(c.intentValueType="handler",c.handlerRes="/"+b[1]+"/"+b[2]+"/"+b[3]+"/"+b[4],c.definitionRes="/"+b[1]+"/"+b[2]+"/"+b[3],c.capabilityRes="/"+b[1]+"/"+b[2]):(c.intentValueType="definition",c.definitionRes="/"+b[1]+"/"+b[2]+"/"+b[3],c.capabilityRes="/"+b[1]+"/"+b[2]):(c.intentValueType="capabilities",c.capabilityRes="/"+b[1]+"/"+b[2]),a.packet.parsedResource=c)}},a.IntentsApi.prototype.makeValue=function(a){switch(a.parsedResource.intentValueType){case"handler":return this.getHandler(a);case"definition":return this.getDefinition(a);case"capabilities":return this.getCapability(a);default:return null}},a.IntentsApi.prototype.getGeneric=function(a,b){var c=this.data[a];return c||(c=this.data[a]=new b({resource:a})),c},a.IntentsApi.prototype.getCapability=function(b){return this.getGeneric(b.parsedResource.capabilityRes,a.IntentsApiCapabilityValue)},a.IntentsApi.prototype.getDefinition=function(b){var c=this.getCapability(b);c.entity=c.entity||{},c.entity.definitions=c.entity.definitions||[];var d=c.entity.definitions.indexOf(b.parsedResource.definitionRes);return-1===d&&c.pushDefinition(b.parsedResource.definitionRes),this.getGeneric(b.parsedResource.definitionRes,a.IntentsApiDefinitionValue)},a.IntentsApi.prototype.getHandler=function(b){var c=this.getDefinition(b);c.entity=c.entity||{},c.entity.handlers=c.entity.handlers||[];var d=c.entity.handlers.indexOf(b.parsedResource.handlerRes);return-1===d&&c.pushHandler(b.parsedResource.handlerRes),this.getGeneric(b.parsedResource.handlerRes,a.IntentsApiHandlerValue)},a.IntentsApi.prototype.handleRegister=function(a,b){if("definition"===b.packet.parsedResource.intentValueType)b.packet.parsedResource.handlerRes=this.createKey(b.packet.resource+"/");else if("handler"!==b.packet.parsedResource.intentValueType)return b.replyTo({action:"badResource"}),null;var c=this.getHandler(b.packet);c.set(b),b.replyTo({action:"ok",entity:c.resource})},a.IntentsApi.prototype.handleUnregister=function(a,b){var c=b.packet.parsedResource.definitionRes,d=b.packet.parsedResource.handlerRes,e=this.data[c].entity.handlers.indexOf(d);e>-1&&this.data[c].entity.handlers.splice(e,1),delete this.data[d],b.replyTo({action:"ok"})},a.IntentsApi.prototype.handleInvoke=function(a,b){switch(b.packet.parsedResource.intentValueType){case"handler":a.invoke(b.packet);break;case"definition":var c=0;
if(a.handlers.length>0){var d=a.handlers[c];this.data[d].invoke(packet)}else b.replyTo({action:"badResource"});break;default:b.replyTo({action:"badResource"})}},a.IntentsApi.prototype.handleListen=function(){},a.IntentsApi.prototype.handleBroadcast=function(){},a.IntentsApi.prototype.loadServerDataEmbedded=function(b){var c=this,d=new a.AsyncAction;return a.util.ajax({href:b.href,method:"GET"}).success(function(a){var b=a._links.self.href;for(var e in a._embedded["ozp:intentTypes"]){var f=a._embedded["ozp:intentTypes"][e];for(var g in f._embedded["ozp:intentSubTypes"]){var h=f._embedded["ozp:intentSubTypes"][g];for(var i in h._embedded["ozp:intentActions"]){var j=h._embedded["ozp:intentActions"][i],k={packet:{resource:j._links.self.href.replace(b,""),entity:j}};c.parseResource(k);var l=c.getDefinition(k.packet);l.set(k.packet)}}}d.resolve("success")}),d},a.IntentsApi.prototype.loadServerData=function(b){var c=this,d=new a.AsyncAction,e={types:{total:0,received:0},subTypes:{total:0,received:0},actions:{total:0,received:0}};return a.util.ajax({href:b.href,method:"GET"}).success(function(b){var f=b._links.self.href;e.types.total+=b._links["ozp:intentTypes"].length;for(var g in b._links["ozp:intentTypes"])a.util.ajax({href:b._links["ozp:intentTypes"][g].href,method:"GET"}).success(function(b){e.types.received++,e.subTypes.total+=b._links["ozp:intentSubTypes"].length;for(var g in b._links["ozp:intentSubTypes"])a.util.ajax({href:b._links["ozp:intentSubTypes"][g].href,method:"GET"}).success(function(b){e.subTypes.received++,e.actions.total+=b._links["ozp:intentActions"].length;for(var g in b._links["ozp:intentActions"])a.util.ajax({href:b._links["ozp:intentActions"][g].href,method:"GET"}).success(function(a){e.actions.received++;var b={packet:{resource:a._links.self.href.replace(f,""),entity:a}};c.parseResource(b);var g=c.getDefinition(b.packet);g.set(b.packet),e.actions.received===e.actions.total&&e.subTypes.received===e.subTypes.total&&e.types.received==e.types.total&&d.resolve("success")})})})}),d},a.IntentsApiCapabilityValue=a.util.extend(a.CommonApiValue,function(){a.CommonApiValue.apply(this,arguments)}),a.IntentsApiCapabilityValue.prototype.pushDefinition=function(a){this.entity.definitions=this.entity.definitions||[],this.entity.definitions.push(a),this.version++},a.IntentsApiCapabilityValue.prototype.unshiftDefinition=function(a){this.entity.definitions=this.entity.definitions||[],this.entity.definitions.unshift(a),this.version++},a.IntentsApiCapabilityValue.prototype.popDefinition=function(){return this.entity.definitions&&this.entity.definitions.length>0?(this.version++,this.entity.definitions.pop()):void 0},a.IntentsApiCapabilityValue.prototype.shiftDefinition=function(){return this.entity.definitions&&this.entity.definitions.length>0?(this.version++,this.entity.definitions.shift()):void 0},a.IntentsApiCapabilityValue.prototype.listDefinitions=function(){return this.entity.definitions},a.IntentsApiDefinitionValue=a.util.extend(a.CommonApiValue,function(){a.CommonApiValue.apply(this,arguments)}),a.IntentsApiDefinitionValue.prototype.pushHandler=function(a){this.entity.handlers=this.entity.handlers||[],this.entity.handlers.push(a),this.version++},a.IntentsApiDefinitionValue.prototype.unshiftHandler=function(a){this.entity.handlers=this.entity.handlers||[],this.entity.handlers.unshift(a),this.version++},a.IntentsApiDefinitionValue.prototype.popHandler=function(){return this.entity.handlers&&this.entity.handlers.length>0?(this.version++,this.entity.handlers.pop()):void 0},a.IntentsApiDefinitionValue.prototype.shiftHandler=function(){return this.entity.handlers&&this.entity.handlers.length>0?(this.version++,this.entity.handlers.shift()):void 0},a.IntentsApiDefinitionValue.prototype.listHandlers=function(){return this.entity.handlers},a.IntentsApiHandlerValue=a.util.extend(a.CommonApiValue,function(){a.CommonApiValue.apply(this,arguments)}),a.IntentsApiHandlerValue.prototype.invoke=function(a){this.set(a)};var a=a||{};a.NamesApi=a.util.extend(a.CommonApiBase,function(){a.CommonApiBase.apply(this,arguments)}),a.NamesApi.prototype.makeValue=function(b){return new a.NamesApiValue({resource:b.resource,contentType:b.contentType,namesApi:this})},a.NamesApi.prototype.findOrMakeValue=function(b){return"/me"===b.resource&&(b.resource="/address/"+b.src),a.CommonApiBase.prototype.findOrMakeValue.call(this,b)},a.NamesApiValue=a.util.extend(a.CommonApiValue,function(b){a.CommonApiValue.apply(this,arguments),b=b||{},this.namesApi=b.namesApi||a.namesApi,this.pInfoMap={},this.pInfoMap.postMessageProxy=["origin","credentials","securityAttributes"],this.pInfoMap.multicast=["members","securityAttributes"],this.pInfoMap.leaderGroupMember=["electionAddress","priority","electionTimeout","leaderState","electionQueue","leader","leaderPriority","securityAttributes"]}),a.NamesApiValue.prototype.set=function(a){if(this.isValidContentType(a.contentType)&&(this.permissions=a.permissions||this.permissions,this.contentType=a.contentType,"/me"===a.resource&&a.src&&(this.resource="/address/"+a.src),this.resource)){if(0===this.resource.indexOf("/address")){var b=this.addressId();if(b){if("undefined"===b)return;this.entity={participantType:a.entity.participantType,address:a.entity.address,name:a.entity.name},this.augmentParticipantInfo(a.entity);var c=this.namesApi.findOrMakeValue({resource:"/address"});c.set({entity:b})}else this.entity=this.entity||[],this.entity.indexOf(a.entity)<0&&this.entity.push(a.entity)}else if(0===this.resource.indexOf("/multicast")){var b=this.addressId();if(this.entity=this.entity||[],b){if("undefined"===b)return;this.entity.indexOf(a.entity)<0&&this.entity.push(a.entity);var c=this.namesApi.findOrMakeValue({resource:"/multicast"});c.set({entity:b})}else this.entity.indexOf(a.entity)<0&&this.entity.push(a.entity)}else this.entity=a.entity;this.version++}},a.NamesApiValue.prototype.deleteData=function(b){if(b&&"/me"===b.resource&&b.src&&(this.resource="/address/"+b.src),this.resource){if(0===this.resource.indexOf("/address")||0===this.resource.indexOf("/multicast")){var c=this.addressId();if(c){var d=this.entity;if(a.CommonApiValue.prototype.deleteData.apply(this,arguments),d){var e=this.namesApi.findOrMakeValue({resource:this.resourceRoot()});e.deleteData({entity:c})}}else{if(!this.entity)return;var f=!1;if(this.entity=this.entity.filter(function(a){var c=a!==b.entity;return c||(f=!0),this.version=0,c}),f){var e=this.namesApi.findOrMakeValue({resource:this.resourceRoot()+"/"+b.entity});e.deleteData()}}}else a.CommonApiValue.prototype.deleteData.apply(this,arguments);this.version=0}},a.NamesApiValue.prototype.augmentParticipantInfo=function(a){var b=this.pInfoMap[a.participantType],c=this;b&&b.forEach(function(b){c.entity[b]=a[b]})},a.NamesApiValue.prototype.addressId=function(){var a=/(\/address|\/multicast)\/(.*)/,b=a.exec(this.resource);return b&&b.length>2?b[2]:null},a.NamesApiValue.prototype.resourceRoot=function(){var a=/(\/address|\/multicast)\/.*/,b=a.exec(this.resource);return b&&b.length>1?b[1]:null};var a=a||{};return a.SystemApi=a.util.extend(a.CommonApiBase,function(b){a.CommonApiBase.apply(this,arguments),this.participant.securityAttributes=b.securityAttributes,b.userHref&&this.loadServerDataEmbedded({href:b.userHref,resource:"/user"}).success(function(){}),b.systemHref&&this.loadServerDataEmbedded({href:b.systemHref,resource:"/system"}).success(function(){})}),a.SystemApi.prototype.makeValue=function(b){return new a.SystemApiValue({resource:b.resource,contentType:b.contentType,systemApi:this})},a.SystemApi.prototype.isPermitted=function(b,c){var d=b,e=c;"set"===c.packet.action||"delete"===c.packet.action?(b.permissions.modifyAuthority="apiLoader",c.packet.securityAttributes&&(c.srcSubject=c.srcSubject||{},Object.keys(c.packet.securityAttributes).forEach(function(a){c.srcSubject[a]=c.packet.securityAttributes[a]}))):delete b.permissions.modifyAuthority;for(var f in arguments)arguments[f]===d?arguments[f]=b:arguments[f]===e&&(arguments[f]=c);var g=a.CommonApiBase.prototype.isPermitted.apply(this,arguments);return delete b.permissions.modifyAuthority,g},a.SystemApi.prototype.loadServerDataEmbedded=function(b){var c=this,d=new a.AsyncAction;return a.util.ajax({href:b.href,method:"GET"}).success(function(a){var e=c.findOrMakeValue({resource:b.resource});e.set({entity:a}),d.resolve("success")}).failure(function(a){console.log("AJAX failure response: "+a),d.resolve("failure",a)}),d},a.SystemApiValue=a.util.extend(a.CommonApiValue,function(b){a.CommonApiValue.apply(this,arguments),b=b||{},this.systemApi=b.systemApi||a.systemApi}),a.SystemApiValue.prototype.set=function(a){if(this.isValidContentType(a.contentType)&&(this.permissions=a.permissions||this.permissions,this.contentType=a.contentType,this.resource)){if(0===this.resource.indexOf("/application")){var b=this.applicationId();if(b){this.entity=a.entity;var c=this.systemApi.findOrMakeValue({resource:"/application"});c.set({entity:b})}else this.entity=this.entity||[],this.entity.indexOf(a.entity)<0&&this.entity.push(a.entity)}else this.entity=a.entity;this.version++}},a.SystemApiValue.prototype.deleteData=function(b){if(this.resource){if(0===this.resource.indexOf("/application")){var c=this.applicationId();if(c){var d=this.entity;if(a.CommonApiValue.prototype.deleteData.apply(this,arguments),d){var e=this.systemApi.findOrMakeValue({resource:"/application"});e.deleteData({entity:c})}}else{if(!this.entity)return;var f=!1;if(this.entity=this.entity.filter(function(a){var c=a!==b.entity;return c||(f=!0),this.version=0,c}),f){var e=this.systemApi.findOrMakeValue({resource:"/application/"+b.entity});e.deleteData()}}}else a.CommonApiValue.prototype.deleteData.apply(this,arguments);this.version=0}},a.SystemApiValue.prototype.applicationId=function(){var a=/\/application\/(.*)/,b=a.exec(this.resource);return b&&b.length>1?b[1]:null},a});