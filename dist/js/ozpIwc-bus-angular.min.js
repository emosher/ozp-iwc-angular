angular.module("ozpIwcBus",[]).factory("iwcBus",function(){!function(a,b){"use strict";"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():a.returnExports=b()}(this,function(){function a(a){var b=typeof a;return null===a||"undefined"===b||"boolean"===b||"number"===b||"string"===b}var b,c=Array.prototype,d=Object.prototype,e=Function.prototype,f=String.prototype,g=Number.prototype,h=c.slice,i=c.splice,j=c.push,k=c.unshift,l=e.call,m=d.toString,n=Array.isArray||function(a){return"[object Array]"===m.call(a)},o="function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag,p=Function.prototype.toString,q=function(a){try{return p.call(a),!0}catch(b){return!1}},r="[object Function]",s="[object GeneratorFunction]";b=function(a){if("function"!=typeof a)return!1;if(o)return q(a);var b=m.call(a);return b===r||b===s};var t,u=RegExp.prototype.exec,v=function(a){try{return u.call(a),!0}catch(b){return!1}},w="[object RegExp]";t=function(a){return"object"!=typeof a?!1:o?v(a):m.call(a)===w};var x,y=String.prototype.valueOf,z=function(a){try{return y.call(a),!0}catch(b){return!1}},A="[object String]";x=function(a){return"string"==typeof a?!0:"object"!=typeof a?!1:o?z(a):m.call(a)===A};var B=function(a){var c=m.call(a),d="[object Arguments]"===c;return d||(d=!n(a)&&null!==a&&"object"==typeof a&&"number"==typeof a.length&&a.length>=0&&b(a.callee)),d},C=function(a){var b,c=Object.defineProperty&&function(){try{return Object.defineProperty({},"x",{}),!0}catch(a){return!1}}();return b=c?function(a,b,c,d){!d&&b in a||Object.defineProperty(a,b,{configurable:!0,enumerable:!1,writable:!0,value:c})}:function(a,b,c,d){!d&&b in a||(a[b]=c)},function(c,d,e){for(var f in d)a.call(d,f)&&b(c,f,d[f],e)}}(d.hasOwnProperty),D={ToInteger:function(a){var b=+a;return b!==b?b=0:0!==b&&b!==1/0&&b!==-(1/0)&&(b=(b>0||-1)*Math.floor(Math.abs(b))),b},ToPrimitive:function(c){var d,e,f;if(a(c))return c;if(e=c.valueOf,b(e)&&(d=e.call(c),a(d)))return d;if(f=c.toString,b(f)&&(d=f.call(c),a(d)))return d;throw new TypeError},ToObject:function(a){if(null==a)throw new TypeError("can't convert "+a+" to object");return Object(a)},ToUint32:function(a){return a>>>0}},E=function(){};C(e,{bind:function(a){var c=this;if(!b(c))throw new TypeError("Function.prototype.bind called on incompatible "+c);for(var d,e=h.call(arguments,1),f=function(){if(this instanceof d){var b=c.apply(this,e.concat(h.call(arguments)));return Object(b)===b?b:this}return c.apply(a,e.concat(h.call(arguments)))},g=Math.max(0,c.length-e.length),i=[],j=0;g>j;j++)i.push("$"+j);return d=Function("binder","return function ("+i.join(",")+"){ return binder.apply(this, arguments); }")(f),c.prototype&&(E.prototype=c.prototype,d.prototype=new E,E.prototype=null),d}});var F=l.bind(d.hasOwnProperty),G=function(){var a=[1,2],b=a.splice();return 2===a.length&&n(b)&&0===b.length}();C(c,{splice:function(){return 0===arguments.length?[]:i.apply(this,arguments)}},!G);var H=function(){var a={};return c.splice.call(a,0,0,1),1===a.length}();C(c,{splice:function(a,b){if(0===arguments.length)return[];var c=arguments;return this.length=Math.max(D.ToInteger(this.length),0),arguments.length>0&&"number"!=typeof b&&(c=h.call(arguments),c.length<2?c.push(this.length-a):c[1]=D.ToInteger(b)),i.apply(this,c)}},!H);var I=1!==[].unshift(0);C(c,{unshift:function(){return k.apply(this,arguments),this.length}},I),C(Array,{isArray:n});var J=Object("a"),K="a"!==J[0]||!(0 in J),L=function(a){var b=!0,c=!0;return a&&(a.call("foo",function(a,c,d){"object"!=typeof d&&(b=!1)}),a.call([1],function(){"use strict";c="string"==typeof this},"x")),!!a&&b&&c};C(c,{forEach:function(a){var c=D.ToObject(this),d=K&&x(this)?this.split(""):c,e=arguments[1],f=-1,g=d.length>>>0;if(!b(a))throw new TypeError;for(;++f<g;)f in d&&a.call(e,d[f],f,c)}},!L(c.forEach)),C(c,{map:function(a){var c=D.ToObject(this),d=K&&x(this)?this.split(""):c,e=d.length>>>0,f=Array(e),g=arguments[1];if(!b(a))throw new TypeError(a+" is not a function");for(var h=0;e>h;h++)h in d&&(f[h]=a.call(g,d[h],h,c));return f}},!L(c.map)),C(c,{filter:function(a){var c,d=D.ToObject(this),e=K&&x(this)?this.split(""):d,f=e.length>>>0,g=[],h=arguments[1];if(!b(a))throw new TypeError(a+" is not a function");for(var i=0;f>i;i++)i in e&&(c=e[i],a.call(h,c,i,d)&&g.push(c));return g}},!L(c.filter)),C(c,{every:function(a){var c=D.ToObject(this),d=K&&x(this)?this.split(""):c,e=d.length>>>0,f=arguments[1];if(!b(a))throw new TypeError(a+" is not a function");for(var g=0;e>g;g++)if(g in d&&!a.call(f,d[g],g,c))return!1;return!0}},!L(c.every)),C(c,{some:function(a){var c=D.ToObject(this),d=K&&x(this)?this.split(""):c,e=d.length>>>0,f=arguments[1];if(!b(a))throw new TypeError(a+" is not a function");for(var g=0;e>g;g++)if(g in d&&a.call(f,d[g],g,c))return!0;return!1}},!L(c.some));var M=!1;c.reduce&&(M="object"==typeof c.reduce.call("es5",function(a,b,c,d){return d})),C(c,{reduce:function(a){var c=D.ToObject(this),d=K&&x(this)?this.split(""):c,e=d.length>>>0;if(!b(a))throw new TypeError(a+" is not a function");if(!e&&1===arguments.length)throw new TypeError("reduce of empty array with no initial value");var f,g=0;if(arguments.length>=2)f=arguments[1];else for(;;){if(g in d){f=d[g++];break}if(++g>=e)throw new TypeError("reduce of empty array with no initial value")}for(;e>g;g++)g in d&&(f=a.call(void 0,f,d[g],g,c));return f}},!M);var N=!1;c.reduceRight&&(N="object"==typeof c.reduceRight.call("es5",function(a,b,c,d){return d})),C(c,{reduceRight:function(a){var c=D.ToObject(this),d=K&&x(this)?this.split(""):c,e=d.length>>>0;if(!b(a))throw new TypeError(a+" is not a function");if(!e&&1===arguments.length)throw new TypeError("reduceRight of empty array with no initial value");var f,g=e-1;if(arguments.length>=2)f=arguments[1];else for(;;){if(g in d){f=d[g--];break}if(--g<0)throw new TypeError("reduceRight of empty array with no initial value")}if(0>g)return f;do g in d&&(f=a.call(void 0,f,d[g],g,c));while(g--);return f}},!N);var O=Array.prototype.indexOf&&-1!==[0,1].indexOf(1,2);C(c,{indexOf:function(a){var b=K&&x(this)?this.split(""):D.ToObject(this),c=b.length>>>0;if(!c)return-1;var d=0;for(arguments.length>1&&(d=D.ToInteger(arguments[1])),d=d>=0?d:Math.max(0,c+d);c>d;d++)if(d in b&&b[d]===a)return d;return-1}},O);var P=Array.prototype.lastIndexOf&&-1!==[0,1].lastIndexOf(0,-3);C(c,{lastIndexOf:function(a){var b=K&&x(this)?this.split(""):D.ToObject(this),c=b.length>>>0;if(!c)return-1;var d=c-1;for(arguments.length>1&&(d=Math.min(d,D.ToInteger(arguments[1]))),d=d>=0?d:c-Math.abs(d);d>=0;d--)if(d in b&&a===b[d])return d;return-1}},P);var Q=!{toString:null}.propertyIsEnumerable("toString"),R=function(){}.propertyIsEnumerable("prototype"),S=!F("x","0"),T=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],U=T.length;C(Object,{keys:function(a){var c=b(a),d=B(a),e=null!==a&&"object"==typeof a,f=e&&x(a);if(!e&&!c&&!d)throw new TypeError("Object.keys called on a non-object");var g=[],h=R&&c;if(f&&S||d)for(var i=0;i<a.length;++i)g.push(String(i));if(!d)for(var j in a)h&&"prototype"===j||!F(a,j)||g.push(String(j));if(Q)for(var k=a.constructor,l=k&&k.prototype===a,m=0;U>m;m++){var n=T[m];l&&"constructor"===n||!F(a,n)||g.push(n)}return g}});var V=Object.keys&&function(){return 2===Object.keys(arguments).length}(1,2),W=Object.keys;C(Object,{keys:function(a){return W(B(a)?c.slice.call(a):a)}},!V);var X=-621987552e5,Y="-000001",Z=Date.prototype.toISOString&&-1===new Date(X).toISOString().indexOf(Y);C(Date.prototype,{toISOString:function(){var a,b,c,d,e;if(!isFinite(this))throw new RangeError("Date.prototype.toISOString called on non-finite value.");for(d=this.getUTCFullYear(),e=this.getUTCMonth(),d+=Math.floor(e/12),e=(e%12+12)%12,a=[e+1,this.getUTCDate(),this.getUTCHours(),this.getUTCMinutes(),this.getUTCSeconds()],d=(0>d?"-":d>9999?"+":"")+("00000"+Math.abs(d)).slice(d>=0&&9999>=d?-4:-6),b=a.length;b--;)c=a[b],10>c&&(a[b]="0"+c);return d+"-"+a.slice(0,2).join("-")+"T"+a.slice(2).join(":")+"."+("000"+this.getUTCMilliseconds()).slice(-3)+"Z"}},Z);var $=!1;try{$=Date.prototype.toJSON&&null===new Date(0/0).toJSON()&&-1!==new Date(X).toJSON().indexOf(Y)&&Date.prototype.toJSON.call({toISOString:function(){return!0}})}catch(_){}$||(Date.prototype.toJSON=function(){var a,b=Object(this),c=D.ToPrimitive(b);if("number"==typeof c&&!isFinite(c))return null;if(a=b.toISOString,"function"!=typeof a)throw new TypeError("toISOString property is not callable");return a.call(b)});var ab=1e15===Date.parse("+033658-09-27T01:46:40.000Z"),bb=!isNaN(Date.parse("2012-04-04T24:00:00.500Z"))||!isNaN(Date.parse("2012-11-31T23:59:59.000Z")),cb=isNaN(Date.parse("2000-01-01T00:00:00.000Z"));(!Date.parse||cb||bb||!ab)&&(Date=function(a){function b(c,d,e,f,g,h,i){var j=arguments.length;if(this instanceof a){var k=1===j&&String(c)===c?new a(b.parse(c)):j>=7?new a(c,d,e,f,g,h,i):j>=6?new a(c,d,e,f,g,h):j>=5?new a(c,d,e,f,g):j>=4?new a(c,d,e,f):j>=3?new a(c,d,e):j>=2?new a(c,d):j>=1?new a(c):new a;return k.constructor=b,k}return a.apply(this,arguments)}function c(a,b){var c=b>1?1:0;return f[b]+Math.floor((a-1969+c)/4)-Math.floor((a-1901+c)/100)+Math.floor((a-1601+c)/400)+365*(a-1970)}function d(b){return Number(new a(1970,0,1,0,0,0,b))}var e=new RegExp("^(\\d{4}|[+-]\\d{6})(?:-(\\d{2})(?:-(\\d{2})(?:T(\\d{2}):(\\d{2})(?::(\\d{2})(?:(\\.\\d{1,}))?)?(Z|(?:([-+])(\\d{2}):(\\d{2})))?)?)?)?$"),f=[0,31,59,90,120,151,181,212,243,273,304,334,365];for(var g in a)b[g]=a[g];return b.now=a.now,b.UTC=a.UTC,b.prototype=a.prototype,b.prototype.constructor=b,b.parse=function(b){var f=e.exec(b);if(f){var g,h=Number(f[1]),i=Number(f[2]||1)-1,j=Number(f[3]||1)-1,k=Number(f[4]||0),l=Number(f[5]||0),m=Number(f[6]||0),n=Math.floor(1e3*Number(f[7]||0)),o=Boolean(f[4]&&!f[8]),p="-"===f[9]?1:-1,q=Number(f[10]||0),r=Number(f[11]||0);return(l>0||m>0||n>0?24:25)>k&&60>l&&60>m&&1e3>n&&i>-1&&12>i&&24>q&&60>r&&j>-1&&j<c(h,i+1)-c(h,i)&&(g=60*(24*(c(h,i)+j)+k+q*p),g=1e3*(60*(g+l+r*p)+m)+n,o&&(g=d(g)),g>=-864e13&&864e13>=g)?g:0/0}return a.parse.apply(this,arguments)},b}(Date)),Date.now||(Date.now=function(){return(new Date).getTime()});var db=g.toFixed&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==0xde0b6b3a7640080.toFixed(0)),eb={base:1e7,size:6,data:[0,0,0,0,0,0],multiply:function(a,b){for(var c=-1;++c<eb.size;)b+=a*eb.data[c],eb.data[c]=b%eb.base,b=Math.floor(b/eb.base)},divide:function(a){for(var b=eb.size,c=0;--b>=0;)c+=eb.data[b],eb.data[b]=Math.floor(c/a),c=c%a*eb.base},numToString:function(){for(var a=eb.size,b="";--a>=0;)if(""!==b||0===a||0!==eb.data[a]){var c=String(eb.data[a]);""===b?b=c:b+="0000000".slice(0,7-c.length)+c}return b},pow:function qb(a,b,c){return 0===b?c:b%2===1?qb(a,b-1,c*a):qb(a*a,b/2,c)},log:function(a){for(var b=0;a>=4096;)b+=12,a/=4096;for(;a>=2;)b+=1,a/=2;return b}};C(g,{toFixed:function(a){var b,c,d,e,f,g,h,i;if(b=Number(a),b=b!==b?0:Math.floor(b),0>b||b>20)throw new RangeError("Number.toFixed called with invalid number of decimals");if(c=Number(this),c!==c)return"NaN";if(-1e21>=c||c>=1e21)return String(c);if(d="",0>c&&(d="-",c=-c),e="0",c>1e-21)if(f=eb.log(c*eb.pow(2,69,1))-69,g=0>f?c*eb.pow(2,-f,1):c/eb.pow(2,f,1),g*=4503599627370496,f=52-f,f>0){for(eb.multiply(0,g),h=b;h>=7;)eb.multiply(1e7,0),h-=7;for(eb.multiply(eb.pow(10,h,1),0),h=f-1;h>=23;)eb.divide(1<<23),h-=23;eb.divide(1<<h),eb.multiply(1,1),eb.divide(2),e=eb.numToString()}else eb.multiply(0,g),eb.multiply(1<<-f,0),e=eb.numToString()+"0.00000000000000000000".slice(2,2+b);return b>0?(i=e.length,e=b>=i?d+"0.0000000000000000000".slice(0,b-i+2)+e:d+e.slice(0,i-b)+"."+e.slice(i-b)):e=d+e,e}},db);var fb=f.split;2!=="ab".split(/(?:ab)*/).length||4!==".".split(/(.?)(.?)/).length||"t"==="tesst".split(/(s)*/)[1]||4!=="test".split(/(?:)/,-1).length||"".split(/.?/).length||".".split(/()()/).length>1?!function(){var a="undefined"==typeof/()??/.exec("")[1];f.split=function(b,c){var d=this;if("undefined"==typeof b&&0===c)return[];if(!t(b))return fb.call(this,b,c);var e,f,g,h,i=[],k=(b.ignoreCase?"i":"")+(b.multiline?"m":"")+(b.extended?"x":"")+(b.sticky?"y":""),l=0;for(b=new RegExp(b.source,k+"g"),d+="",a||(e=new RegExp("^"+b.source+"$(?!\\s)",k)),c="undefined"==typeof c?-1>>>0:D.ToUint32(c),f=b.exec(d);f&&(g=f.index+f[0].length,!(g>l&&(i.push(d.slice(l,f.index)),!a&&f.length>1&&f[0].replace(e,function(){for(var a=1;a<arguments.length-2;a++)"undefined"==typeof arguments[a]&&(f[a]=void 0)}),f.length>1&&f.index<d.length&&j.apply(i,f.slice(1)),h=f[0].length,l=g,i.length>=c)));)b.lastIndex===f.index&&b.lastIndex++,f=b.exec(d);return l===d.length?(h||!b.test(""))&&i.push(""):i.push(d.slice(l)),i.length>c?i.slice(0,c):i}}():"0".split(void 0,0).length&&(f.split=function(a,b){return"undefined"==typeof a&&0===b?[]:fb.call(this,a,b)});var gb=f.replace,hb=function(){var a=[];return"x".replace(/x(.)?/g,function(b,c){a.push(c)}),1===a.length&&"undefined"==typeof a[0]}();hb||(f.replace=function(a,c){var d=b(c),e=t(a)&&/\)[*?]/.test(a.source);if(d&&e){var f=function(b){var d=arguments.length,e=a.lastIndex;a.lastIndex=0;var f=a.exec(b)||[];return a.lastIndex=e,f.push(arguments[d-2],arguments[d-1]),c.apply(this,f)};return gb.call(this,a,f)}return gb.call(this,a,c)});var ib=f.substr,jb="".substr&&"b"!=="0b".substr(-1);C(f,{substr:function(a,b){return ib.call(this,0>a&&(a=this.length+a)<0?0:a,b)}},jb);var kb="	\n\f\r   ᠎             　\u2028\u2029﻿",lb="​",mb="["+kb+"]",nb=new RegExp("^"+mb+mb+"*"),ob=new RegExp(mb+mb+"*$"),pb=f.trim&&(kb.trim()||!lb.trim());C(f,{trim:function(){if("undefined"==typeof this||null===this)throw new TypeError("can't convert "+this+" to object");return String(this).replace(nb,"").replace(ob,"")}},pb),(8!==parseInt(kb+"08")||22!==parseInt(kb+"0x16"))&&(parseInt=function(a){var b=/^0[xX]/;return function(c,d){return c=String(c).trim(),Number(d)||(d=b.test(c)?16:10),a(c,d)}}(parseInt))}),function(a,b){"use strict";"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():a.returnExports=b()}(this,function(){function a(a){try{return a.sentinel=0,0===Object.getOwnPropertyDescriptor(a,"sentinel").value}catch(b){}}function b(a){try{return Object.defineProperty(a,"sentinel",{}),"sentinel"in a}catch(b){}}var c,d,e,f,g=Function.prototype.call,h=Object.prototype,i=g.bind(h.hasOwnProperty),j=i(h,"__defineGetter__");if(j&&(c=g.bind(h.__defineGetter__),d=g.bind(h.__defineSetter__),e=g.bind(h.__lookupGetter__),f=g.bind(h.__lookupSetter__)),Object.getPrototypeOf||(Object.getPrototypeOf=function(a){var b=a.__proto__;return b||null===b?b:a.constructor?a.constructor.prototype:h}),Object.defineProperty){var k=a({}),l="undefined"==typeof document||a(document.createElement("div"));if(!l||!k)var m=Object.getOwnPropertyDescriptor}if(!Object.getOwnPropertyDescriptor||m){var n="Object.getOwnPropertyDescriptor called on a non-object: ";Object.getOwnPropertyDescriptor=function(a,b){if("object"!=typeof a&&"function"!=typeof a||null===a)throw new TypeError(n+a);if(m)try{return m.call(Object,a,b)}catch(c){}var d;if(!i(a,b))return d;if(d={enumerable:!0,configurable:!0},j){var g=a.__proto__,k=a!==h;k&&(a.__proto__=h);var l=e(a,b),o=f(a,b);if(k&&(a.__proto__=g),l||o)return l&&(d.get=l),o&&(d.set=o),d}return d.value=a[b],d.writable=!0,d}}if(Object.getOwnPropertyNames||(Object.getOwnPropertyNames=function(a){return Object.keys(a)}),!Object.create){var o,p=!({__proto__:null}instanceof Object);o=p||"undefined"==typeof document?function(){return{__proto__:null}}:function(){function a(){}var b=document.createElement("iframe"),c=document.body||document.documentElement;b.style.display="none",c.appendChild(b),b.src="javascript:";var d=b.contentWindow.Object.prototype;return c.removeChild(b),b=null,delete d.constructor,delete d.hasOwnProperty,delete d.propertyIsEnumerable,delete d.isPrototypeOf,delete d.toLocaleString,delete d.toString,delete d.valueOf,d.__proto__=null,a.prototype=d,o=function(){return new a},new a},Object.create=function(a,b){function c(){}var d;if(null===a)d=o();else{if("object"!=typeof a&&"function"!=typeof a)throw new TypeError("Object prototype may only be an Object or null");c.prototype=a,d=new c,d.__proto__=a}return void 0!==b&&Object.defineProperties(d,b),d}}if(Object.defineProperty){var q=b({}),r="undefined"==typeof document||b(document.createElement("div"));if(!q||!r)var s=Object.defineProperty,t=Object.defineProperties}if(!Object.defineProperty||s){var u="Property description must be an object: ",v="Object.defineProperty called on non-object: ",w="getters & setters can not be defined on this javascript engine";Object.defineProperty=function(a,b,g){if("object"!=typeof a&&"function"!=typeof a||null===a)throw new TypeError(v+a);if("object"!=typeof g&&"function"!=typeof g||null===g)throw new TypeError(u+g);if(s)try{return s.call(Object,a,b,g)}catch(i){}if("value"in g)if(j&&(e(a,b)||f(a,b))){var k=a.__proto__;a.__proto__=h,delete a[b],a[b]=g.value,a.__proto__=k}else a[b]=g.value;else{if(!j)throw new TypeError(w);"get"in g&&c(a,b,g.get),"set"in g&&d(a,b,g.set)}return a}}(!Object.defineProperties||t)&&(Object.defineProperties=function(a,b){if(t)try{return t.call(Object,a,b)}catch(c){}for(var d in b)i(b,d)&&"__proto__"!==d&&Object.defineProperty(a,d,b[d]);return a}),Object.seal||(Object.seal=function(a){if(Object(a)!==a)throw new TypeError("Object.seal can only be called on Objects.");return a}),Object.freeze||(Object.freeze=function(a){if(Object(a)!==a)throw new TypeError("Object.freeze can only be called on Objects.");return a});try{Object.freeze(function(){})}catch(x){Object.freeze=function(a){return function(b){return"function"==typeof b?b:a(b)}}(Object.freeze)}Object.preventExtensions||(Object.preventExtensions=function(a){if(Object(a)!==a)throw new TypeError("Object.preventExtensions can only be called on Objects.");return a}),Object.isSealed||(Object.isSealed=function(a){if(Object(a)!==a)throw new TypeError("Object.isSealed can only be called on Objects.");return!1}),Object.isFrozen||(Object.isFrozen=function(a){if(Object(a)!==a)throw new TypeError("Object.isFrozen can only be called on Objects.");return!1}),Object.isExtensible||(Object.isExtensible=function(a){if(Object(a)!==a)throw new TypeError("Object.isExtensible can only be called on Objects.");for(var b="";i(a,b);)b+="?";a[b]=!0;var c=i(a,b);return delete a[b],c})}),function(){var a,b,c,d;!function(){var e={},f={};a=function(a,b,c){e[a]={deps:b,callback:c}},d=c=b=function(a){function c(b){if("."!==b.charAt(0))return b;for(var c=b.split("/"),d=a.split("/").slice(0,-1),e=0,f=c.length;f>e;e++){var g=c[e];if(".."===g)d.pop();else{if("."===g)continue;d.push(g)}}return d.join("/")}if(d._eak_seen=e,f[a])return f[a];if(f[a]={},!e[a])throw new Error("Could not find module "+a);for(var g,h=e[a],i=h.deps,j=h.callback,k=[],l=0,m=i.length;m>l;l++)k.push("exports"===i[l]?g={}:b(c(i[l])));var n=j.apply(this,k);return f[a]=g||n}}(),a("promise/all",["./utils","exports"],function(a,b){"use strict";function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to all.");return new b(function(b,c){function d(a){return function(b){f(a,b)}}function f(a,c){h[a]=c,0===--i&&b(h)}var g,h=[],i=a.length;0===i&&b([]);for(var j=0;j<a.length;j++)g=a[j],g&&e(g.then)?g.then(d(j),c):f(j,g)})}var d=a.isArray,e=a.isFunction;b.all=c}),a("promise/asap",["exports"],function(a){"use strict";function b(){return function(){process.nextTick(e)}}function c(){var a=0,b=new i(e),c=document.createTextNode("");return b.observe(c,{characterData:!0}),function(){c.data=a=++a%2}}function d(){return function(){j.setTimeout(e,1)}}function e(){for(var a=0;a<k.length;a++){var b=k[a],c=b[0],d=b[1];c(d)}k=[]}function f(a,b){var c=k.push([a,b]);1===c&&g()}var g,h="undefined"!=typeof window?window:{},i=h.MutationObserver||h.WebKitMutationObserver,j="undefined"!=typeof global?global:void 0===this?window:this,k=[];g="undefined"!=typeof process&&"[object process]"==={}.toString.call(process)?b():i?c():d(),a.asap=f}),a("promise/config",["exports"],function(a){"use strict";function b(a,b){return 2!==arguments.length?c[a]:void(c[a]=b)}var c={instrument:!1};a.config=c,a.configure=b}),a("promise/polyfill",["./promise","./utils","exports"],function(a,b,c){"use strict";function d(){var a;a="undefined"!=typeof global?global:"undefined"!=typeof window&&window.document?window:self;var b="Promise"in a&&"resolve"in a.Promise&&"reject"in a.Promise&&"all"in a.Promise&&"race"in a.Promise&&function(){var b;return new a.Promise(function(a){b=a}),f(b)}();b||(a.Promise=e)}var e=a.Promise,f=b.isFunction;c.polyfill=d}),a("promise/promise",["./config","./utils","./all","./race","./resolve","./reject","./asap","exports"],function(a,b,c,d,e,f,g,h){"use strict";function i(a){if(!v(a))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof i))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this._subscribers=[],j(a,this)}function j(a,b){function c(a){o(b,a)}function d(a){q(b,a)}try{a(c,d)}catch(e){d(e)}}function k(a,b,c,d){var e,f,g,h,i=v(c);if(i)try{e=c(d),g=!0}catch(j){h=!0,f=j}else e=d,g=!0;n(b,e)||(i&&g?o(b,e):h?q(b,f):a===D?o(b,e):a===E&&q(b,e))}function l(a,b,c,d){var e=a._subscribers,f=e.length;e[f]=b,e[f+D]=c,e[f+E]=d}function m(a,b){for(var c,d,e=a._subscribers,f=a._detail,g=0;g<e.length;g+=3)c=e[g],d=e[g+b],k(b,c,d,f);a._subscribers=null}function n(a,b){var c,d=null;try{if(a===b)throw new TypeError("A promises callback cannot return that same promise.");if(u(b)&&(d=b.then,v(d)))return d.call(b,function(d){return c?!0:(c=!0,void(b!==d?o(a,d):p(a,d)))},function(b){return c?!0:(c=!0,void q(a,b))}),!0}catch(e){return c?!0:(q(a,e),!0)}return!1}function o(a,b){a===b?p(a,b):n(a,b)||p(a,b)}function p(a,b){a._state===B&&(a._state=C,a._detail=b,t.async(r,a))}function q(a,b){a._state===B&&(a._state=C,a._detail=b,t.async(s,a))}function r(a){m(a,a._state=D)}function s(a){m(a,a._state=E)}var t=a.config,u=(a.configure,b.objectOrFunction),v=b.isFunction,w=(b.now,c.all),x=d.race,y=e.resolve,z=f.reject,A=g.asap;t.async=A;var B=void 0,C=0,D=1,E=2;i.prototype={constructor:i,_state:void 0,_detail:void 0,_subscribers:void 0,then:function(a,b){var c=this,d=new this.constructor(function(){});if(this._state){var e=arguments;t.async(function(){k(c._state,d,e[c._state-1],c._detail)})}else l(this,d,a,b);return d},"catch":function(a){return this.then(null,a)}},i.all=w,i.race=x,i.resolve=y,i.reject=z,h.Promise=i}),a("promise/race",["./utils","exports"],function(a,b){"use strict";function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to race.");return new b(function(b,c){for(var d,e=0;e<a.length;e++)d=a[e],d&&"function"==typeof d.then?d.then(b,c):b(d)})}var d=a.isArray;b.race=c}),a("promise/reject",["exports"],function(a){"use strict";function b(a){var b=this;return new b(function(b,c){c(a)})}a.reject=b}),a("promise/resolve",["exports"],function(a){"use strict";function b(a){if(a&&"object"==typeof a&&a.constructor===this)return a;var b=this;return new b(function(b){b(a)})}a.resolve=b}),a("promise/utils",["exports"],function(a){"use strict";function b(a){return c(a)||"object"==typeof a&&null!==a}function c(a){return"function"==typeof a}function d(a){return"[object Array]"===Object.prototype.toString.call(a)}var e=Date.now||function(){return(new Date).getTime()};a.objectOrFunction=b,a.isFunction=c,a.isArray=d,a.now=e}),b("promise/polyfill").polyfill()}();var a=a||{};a.apiMap={"data.api":{address:"data.api",actions:["get","set","delete","watch","unwatch","list","bulkGet","addChild","removeChild"]},"intents.api":{address:"intents.api",actions:["get","set","delete","watch","unwatch","list","bulkGet","register","invoke","broadcast"]},"names.api":{address:"names.api",actions:["get","set","delete","watch","unwatch","list","bulkGet"]},"system.api":{address:"system.api",actions:["get","set","delete","watch","unwatch","list","bulkGet","launch"]},"locks.api":{address:"locks.api",actions:["get","watch","unwatch","list","lock","unlock"]}},a.ApiPromiseMixin=function(b,c){c="undefined"==typeof c||c,b.address=b.address||"$nobody",b.connect=b.connect||function(){return b.connectPromise=Promise.resolve(),b.connectPromise},b.events||(b.events=new a.Event,b.events.mixinOnOff(b));var d=a.ApiPromiseMixin.getCore();for(var e in d)b[e]=d[e];b.readLaunchParams(window.name),b.readLaunchParams(window.location.search),b.readLaunchParams(window.location.hash),a.ApiPromiseMixin.registerEvents(b),b.constructApiFunctions(),c&&b.connect()},a.ApiPromiseMixin.registerEvents=function(a){a.on("disconnect",function(){a.promiseCallbacks={},a.registeredCallbacks={},window.removeEventListener("message",a.postMessageHandler,!1),a.connectPromise=null})},a.ApiPromiseMixin.getCore=function(){return{promiseCallbacks:{},msgIdSequence:0,receivedPackets:0,receivedBytes:0,sentPackets:0,sentBytes:0,startTime:a.util.now(),apiMap:a.apiMap||{},wrapperMap:{},preconnectionQueue:[],launchParams:{},watchMsgMap:{},registeredCallbacks:{},launchedIntents:[],isConnected:function(){return"$nobody"!==this.address},readLaunchParams:function(a){for(var b,c=/ozpIwc.(\w+)=([^&#]+)/g;null!==(b=c.exec(a));){var d=decodeURIComponent(b[2]);try{d=JSON.parse(d)}catch(e){}this.launchParams[b[1]]=d}},receiveFromRouterImpl:function(a){var b=!1,c=a.packet||a;if("$transport"===c.src||c.replyTo&&this.promiseCallbacks[c.replyTo]){var d=!1,e=function(){d=!0};this.promiseCallbacks[c.replyTo](c,e),d&&(this.cancelPromiseCallback(c.replyTo),b=!0)}if(!b&&c.replyTo&&this.registeredCallbacks[c.replyTo]){var f=!1,g=function(){f=!0};b=this.registeredCallbacks[c.replyTo](c,g),f&&(this.watchMsgMap[c.replyTo]&&"watch"===this.watchMsgMap[c.replyTo].action&&this.api(this.watchMsgMap[c.replyTo].dst).unwatch(this.watchMsgMap[c.replyTo].resource),this.cancelRegisteredCallback(c.replyTo))}b||this.events.trigger("receive",a)},constructApiFunctions:function(){for(var a in this.apiMap){var b=this.apiMap[a],c=b.address.replace(".api","");this.hasOwnProperty(c)&&this.apiMap[a].functionName!==c||!function(a,b){a[c]=function(){return a.api(b)},a.apiMap[b]=a.apiMap[b]||{},a.apiMap[b].functionName=c,a.updateApi(b)}(this,b.address)}},gatherApiInformation:function(){var a=this;return this.send({dst:"names.api",action:"get",resource:"/api"}).then(function(a){if("ok"===a.response)return a.entity;throw a.response}).then(function(b){var c=[];return b.forEach(function(b){var d=a.send({dst:"names.api",action:"get",resource:b}).then(function(c){if("ok"!==c.response)throw c.response;var d=b.replace("/api/","");a.apiMap[d]=a.apiMap[d]||{},a.apiMap[d].address=d,a.apiMap[d].actions=c.entity.actions});c.push(d)}),Promise.all(c)})},cancelPromiseCallback:function(a){var b=!1;return a&&(delete this.promiseCallbacks[a],b=!0),b},cancelRegisteredCallback:function(a){var b=!1;return a&&(delete this.registeredCallbacks[a],delete this.watchMsgMap[a],b=!0),b},on:function(a,b){return"connected"===a&&this.isConnected()?void b(this):this.events.on.apply(this.events,arguments)},off:function(){return this.events.off.apply(this.events,arguments)},intentInvocationHandling:function(a,b,c,d){var e,f,g=this;return d=d||function(){},f=c?Promise.resolve(c):g.send({dst:"intents.api",action:"get",resource:b}).then(function(a){return a.entity}),f.then(function(c){return e=c,g.send({dst:"intents.api",contentType:c.contentType,action:"set",resource:b,entity:{handler:{resource:a,address:g.address},state:"running"}})}).then(function(){return d(e)}).then(function(a){return g.send({dst:"intents.api",contentType:e.contentType,action:"set",resource:b,entity:{reply:{entity:a||{},contentType:e.intent.type},state:"complete"}})})["catch"](function(a){console.log("Error in handling intent: ",a," -- Clearing in-flight intent node:",b),g.send({dst:"intents.api",resource:b,action:"delete"})})},api:function(a){return this.wrapperMap[a]||this.updateApi(a)},updateApi:function(a){var b=function(a,b,c){return function(d,e,f){"function"==typeof e&&(f=e,e={});var g={dst:a,action:b,resource:d,entity:{}};for(var h in e)g[h]=e[h];if("intents.api"===a&&"register"===b)for(var i in c.launchedIntents){var j="/"+c.launchedIntents[i].entity.intent.type+"/"+c.launchedIntents[i].entity.intent.action;d===j&&(c.intentInvocationHandling(d,c.launchedIntents[i].resource,f),delete c.launchedIntents[i])}return c.send(g,f)}},c=this.wrapperMap[a]||{};if(this.apiMap.hasOwnProperty(a)){var d=this.apiMap[a];c={};for(var e=0;e<d.actions.length;++e){var f=d.actions[e];c[f]=b(d.address,f,this)}this.wrapperMap[a]=c}return c.apiName=a,c},send:function(a,b,c,d){var e=c,f=d,g=new Promise(function(a,b){e||f||(e=a,f=b)});if(!this.isConnected()&&"$transport"!==a.dst)return this.preconnectionQueue.push({fields:a,callback:b,promiseRes:e,promiseRej:f}),g;var h=(new Date).getTime(),i="p:"+this.msgIdSequence++,j={ver:1,src:this.address,msgId:i,time:h};for(var k in a)j[k]=a[k];var l=this;return b&&(this.registeredCallbacks[i]=function(a,c){return"$transport"===a.src||/(ok).*/.test(a.response)||/(bad|no).*/.test(a.response)?!1:(a.entity&&a.entity.inFlightIntent?l.intentInvocationHandling(j.resource,a.entity.inFlightIntent,a.entity.inFlightIntentEntity,b):b(a,c),!0)}),this.promiseCallbacks[i]=function(a,b){"$transport"===a.src||/(ok).*/.test(a.response)?(b(),e(a)):/(bad|no).*/.test(a.response)&&(b(),f(a))},this.sendImpl(j),this.sentBytes+=j.length,this.sentPackets++,"watch"===j.action?this.watchMsgMap[i]=j:"unwatch"===j.action&&j.replyTo&&this.cancelRegisteredCallback(j.replyTo),g},afterConnected:function(){var a=this;return a.preconnectionQueue.forEach(function(b){a.send(b.fields,b.callback,b.promiseRes,b.promiseRej)}),a.preconnectionQueue=[],!a.launchParams.inFlightIntent||a.internal?(a.events.trigger("connected"),Promise.resolve()):a.intents().get(a.launchParams.inFlightIntent).then(function(b){if(b&&b.entity&&b.entity.intent){a.launchedIntents.push(b);var c=b.entity.entity||{};if("ok"===b.response)for(var d in c)a.launchParams[d]=c[d];a.intents().set(a.launchParams.inFlightIntent,{entity:{state:"complete"}})}a.events.trigger("connected")})["catch"](function(b){console.log(a.launchParams.inFlightIntent," not handled, reason: ",b),a.events.trigger("connected")})}}};var a=a||{};a.Event=function(){this.events={}},a.Event.prototype.on=function(a,b,c){var d=b;return c&&(d=function(){b.apply(c,arguments)},d.ozpIwcDelegateFor=b),this.events[a]=this.events[a]||[],this.events[a].push(d),d},a.Event.prototype.off=function(a,b){this.events[a]=(this.events[a]||[]).filter(function(a){return a!==b&&a.ozpIwcDelegateFor!==b})},a.Event.prototype.trigger=function(b){var c=Array.prototype.slice.call(arguments,1);c.length<1&&c.push(new a.CancelableEvent);var d=this.events[b]||[];return d.forEach(function(a){a.apply(this,c)}),c[0]},a.Event.prototype.mixinOnOff=function(a){var b=this;a.on=function(){return b.on.apply(b,arguments)},a.off=function(){return b.off.apply(b,arguments)}},a.CancelableEvent=function(a){a=a||{};for(var b in a)this[b]=a[b];this.canceled=!1,this.cancelReason=null},a.CancelableEvent.prototype.cancel=function(a){return a=a||"Unknown",this.canceled=!0,this.cancelReason=a,this},window.console&&console.log||(console={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){}}),a.object={eachEntry:function(a,b,c){var d=[];for(var e in a)d.push(b.call(c,e,a[e],a.hasOwnProperty(e)));return d},values:function(a,b){b=b||function(){return!0};var c=[];for(var d in a)b(d,a[d])&&c.push(a[d]);return c}},a.packetRouter=a.packetRouter||{},a.packetRouter.uriTemplate=function(a){var b=[],c="^"+a.replace(/\{.+?\}|[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,function(a){if(1===a.length)return"\\"+a;var c=a.indexOf(":");return c>0?(b.push(a.slice(1,c)),"("+a.slice(c+1,-1)+")"):(b.push(a.slice(1,-1)),"([^/]+)")})+"$",d=new RegExp(c);return function(a){var c=d.exec(a);if(!c)return null;for(var e={},f=1;f<c.length;++f)e[b[f-1]]=c[f];return e}},a.PacketRouter=function(){this.routes={},this.defaultRoute=function(){return!1
},this.defaultSelf=this},a.PacketRouter.prototype.declareRoute=function(b,c,d){if(!b||!b.action||!b.resource)throw new Error("Bad route declaration: "+JSON.stringify(b,null,2));b.handler=c,b.filters=b.filters||[],b.handlerSelf=d,b.uriTemplate=a.packetRouter.uriTemplate(b.resource);var e=a.util.ensureArray(b.action);return e.forEach(function(a){this.routes.hasOwnProperty(a)||(this.routes[a]=[]),this.routes[a].push(b)},this),this},a.PacketRouter.prototype.filterChain=function(b,c,d,e,f,g){if(!g.length)return e.handler.call(f,b,c,d);var h=g.shift(),i=this,j=!1,k=h.call(f,b,c,d,function(){return j=!0,i.filterChain(b,c,d,e,f,g)});return j?a.log.debug("Filter returned ",k):a.log.info("Filter did not call next() and did not throw an exception",h),k},a.PacketRouter.prototype.routePacket=function(a,b,c,d){d=d||{};var e=d.action||a.action,f=d.resource||a.resource;if(!e||!f)return b.defaultRouteCause="nonRoutablePacket",this.defaultRoute.call(c,a,b,{});if(b=b||{},c=c||this.defaultSelf,!this.routes.hasOwnProperty(e))return b.defaultRouteCause="noAction",this.defaultRoute.call(c,a,b,{});for(var g=this.routes[e],h=0;h<g.length;++h){var i=g[h];if(i){var j=i.uriTemplate(f);if(j){c=i.handlerSelf||c;var k=i.filters.slice();return this.filterChain(a,b,j,i,c,k)}}}return b.defaultRouteCause="noResource",this.defaultRoute.call(c,a,b,{})},a.PacketRouter.prototype.declareDefaultRoute=function(a){this.defaultRoute=a},a.PacketRouter.mixin=function(b){var c=new a.PacketRouter,d=Object.getPrototypeOf(b.prototype);c.defaultRoute=d&&d.routePacket?function(){return d.routePacket.apply(this,arguments)}:function(){return this.defaultRoute?this.defaultRoute.apply(this,arguments):!1},b.declareRoute=function(a,b){c.declareRoute(a,b)},b.prototype.routePacket=function(a,b){return c.routePacket(a,b,this)}},a.util=a.util||{},a.util.now=function(){return(new Date).getTime()},a.util.resolveUriTemplate=function(a,b,c){var d={"+":function(a){return a},"":function(a){return encodeURIComponent(a)}},e=a.replace(/\{([\+\#\.\/\;\?\&]?)(.+?)\}/g,function(a,e,f){return d[e](b[f]||c[f])}),f=e.indexOf("://");return f>0&&(f+=3),e.replace(/\/\//g,function(a,b){return b>f?"/":a})},a.util.eventListeners={},a.util.addEventListener=function(b,c){var d=a.util.eventListeners[b];d||(d=a.util.eventListeners[b]=[]),d.push(c),window.addEventListener(b,c)},a.util.removeEventListener=function(b,c){var d=a.util.eventListeners[b];d&&(a.util.eventListeners[b]=d.filter(function(a){return a!==c})),window.removeEventListener(b,c)},a.util.purgeEventListeners=function(){a.object.eachEntry(a.util.eventListeners,function(a,b){b.forEach(function(b){window.removeEventListener(a,b)})}),a.util.eventListeners={}},a.util.extend=function(b,c){if(!b||!b.prototype)throw a.log.error("Cannot create a new class for ",c," due to invalid baseclass:",b),new Error("Cannot create a new class due to invalid baseClass.  Dependency not loaded first?");return c.prototype=Object.create(b.prototype),c.prototype.constructor=c,c},a.util.safePostMessage=function(b,c,d){try{var e=c;a.util.structuredCloneSupport()||"string"==typeof e||(e=JSON.stringify(c)),b.postMessage(e,d)}catch(f){try{b.postMessage(JSON.stringify(c),d)}catch(f){a.log.debug("Invalid call to window.postMessage: "+f.message)}}},a.util.structuredCloneSupport=function(){if(a.util=a.util||{},void 0!==a.util.structuredCloneSupportCache)return a.util.structuredCloneSupportCache;var b="postMessage"in window;try{window.postMessage({toString:function(){b=!1}},"*")}catch(c){}return a.util.structuredCloneSupportCache=b,a.util.structuredCloneSupportCache},a.util.structuredCloneSupport.cache=void 0,a.util.clone=function(b){if(!Array.isArray(b)&&"object"!=typeof b)return b;try{return JSON.parse(JSON.stringify(b))}catch(c){a.log.log(c)}},a.util.parseQueryParams=function(a){a=a||window.location.search;for(var b,c={},d=/\??([^&=]+)=?([^&]*)/g;null!==(b=d.exec(a));)c[b[1]]=decodeURIComponent(b[2]);return c},a.util.addQueryParams=function(b,c){if("string"!=typeof b)throw new Error("url should be a string.");var d={};switch(typeof c){case"object":if(Array.isArray(c)){if(0===c.length)return b;for(var e in c)if("string"==typeof c[e]){var f=a.util.parseQueryParams(c[e]);for(var g in f)d[g]=f[g]}}else{if(0===Object.keys(c).length)return b;d=c}break;case"undefined":return b;default:if(0===c.length)return b;d=a.util.parseQueryParams(c)}var h="",i=b.split("#");if(i.length>2)throw new Error("Invalid url.");b=i[0],h=i[1]||"",b+=-1===b.indexOf("?")?"?":"&";var j="";for(var k in d)b+=j+k+"="+d[k],j="&";return h.length>0&&(b+="#"+h),b},a.util.protocolPorts={"http:":"80","https:":"443","ws:":"80","wss:":"443"},a.util.determineOrigin=function(b){var c=document.createElement("a");if(c.href=b,c.origin)return c.origin;var d=c.protocol+"//"+c.hostname;return c.port&&a.util.protocolPorts[c.protocol]!==c.port&&(d+=":"+c.port),d},a.util.escapeRegex=function(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},a.util.parseOzpUrl=function(a){var b=/^(?:(?:web\+ozp|ozp):\/\/)?([0-9a-zA-Z](?:[-.\w])*)(\/[^?#]*)(\?[^#]*)?(#.*)?$/.exec(decodeURIComponent(a));if(b){var c={dst:b[1],resource:b[2],action:"get"};return c}return null},a.util.isIWCPacket=function(a){return"string"!=typeof a.src||"string"!=typeof a.dst||"number"!=typeof a.ver||"string"!=typeof a.msgId?!1:!0},a.util.getInternetExplorerVersion=function(){var a=-1;if("Microsoft Internet Explorer"===navigator.appName){var b=navigator.userAgent,c=/MSIE ([0-9]{1,}[\.0-9]{0,})/;null!==c.exec(b)&&(a=parseFloat(RegExp.$1))}return a};var a=a||{};a.metricsStats=a.metricsStats||{},a.metricsStats.DEFAULT_POOL_SIZE=1028,a.metricsStats.Sample=function(){this.clear()},a.metricsStats.Sample.prototype.update=function(a){this.values.push(a)},a.metricsStats.Sample.prototype.clear=function(){this.values=[],this.count=0},a.metricsStats.Sample.prototype.size=function(){return this.values.length},a.metricsStats.Sample.prototype.getValues=function(){return this.values},a.metricsStats.UniformSample=a.util.extend(a.metricsStats.Sample,function(b){a.metricsStats.Sample.apply(this),this.limit=b||a.metricsStats.DEFAULT_POOL_SIZE}),a.metricsStats.UniformSample.prototype.update=function(a){if(this.count++,this.size()<this.limit)this.values.push(a);else{var b=parseInt(Math.random()*this.count);b<this.limit&&(this.values[b]=a)}};var a=a||{};a.metricsStats=a.metricsStats||{},a.metricsStats.BinaryHeap=function(a){this.content=[],this.scoreFunction=a},a.metricsStats.BinaryHeap.prototype={clone:function(){var b=new a.metricsStats.BinaryHeap(this.scoreFunction);return b.content=JSON.parse(JSON.stringify(this.content)),b},push:function(a){this.content.push(a),this.bubbleUp(this.content.length-1)},peek:function(){return this.content[0]},pop:function(){var a=this.content[0],b=this.content.pop();return this.content.length>0&&(this.content[0]=b,this.sinkDown(0)),a},remove:function(a){for(var b=this.content.length,c=0;b>c;c++)if(this.content[c]===a){var d=this.content.pop();return c!==b-1&&(this.content[c]=d,this.scoreFunction(d)<this.scoreFunction(a)?this.bubbleUp(c):this.sinkDown(c)),!0}throw new Error("Node not found.")},size:function(){return this.content.length},bubbleUp:function(a){for(var b=this.content[a];a>0;){var c=Math.floor((a+1)/2)-1,d=this.content[c];if(!(this.scoreFunction(b)<this.scoreFunction(d)))break;this.content[c]=b,this.content[a]=d,a=c}},sinkDown:function(a){for(var b=this.content.length,c=this.content[a],d=this.scoreFunction(c);;){var e=2*(a+1),f=e-1,g=null,h=null;if(b>f){var i=this.content[f];h=this.scoreFunction(i),d>h&&(g=f)}if(b>e){var j=this.content[e],k=this.scoreFunction(j);(null===g?d:h)>k&&(g=e)}if(null===g)break;this.content[a]=this.content[g],this.content[g]=c,a=g}}};var a=a||{};a.metricsStats=a.metricsStats||{},a.metricsStats.DEFAULT_RESCALE_THRESHOLD=36e5,a.metricsStats.DEFAULT_DECAY_ALPHA=.015,a.metricsStats.ExponentiallyDecayingSample=a.util.extend(a.metricsStats.Sample,function(b,c){a.metricsStats.Sample.apply(this),this.limit=b||a.metricsStats.DEFAULT_POOL_SIZE,this.alpha=c||a.metricsStats.DEFAULT_DECAY_ALPHA,this.rescaleThreshold=a.metricsStats.DEFAULT_RESCALE_THRESHOLD}),a.metricsStats.ExponentiallyDecayingSample.prototype.getValues=function(){for(var a,b=[],c=this.values.clone();void 0!==(a=c.pop());)b.push(a.val);return b},a.metricsStats.ExponentiallyDecayingSample.prototype.size=function(){return this.values.size()},a.metricsStats.ExponentiallyDecayingSample.prototype.newHeap=function(){return new a.metricsStats.BinaryHeap(function(a){return a.priority})},a.metricsStats.ExponentiallyDecayingSample.prototype.now=function(){return a.util.now()},a.metricsStats.ExponentiallyDecayingSample.prototype.tick=function(){return this.now()/1e3},a.metricsStats.ExponentiallyDecayingSample.prototype.clear=function(){this.values=this.newHeap(),this.count=0,this.startTime=this.tick(),this.nextScaleTime=this.now()+this.rescaleThreshold},a.metricsStats.ExponentiallyDecayingSample.prototype.update=function(a,b){void 0===b?b=this.tick():b/=1e3;var c=this.weight(b-this.startTime)/Math.random(),d={val:a,priority:c};if(this.count<this.limit)this.count+=1,this.values.push(d);else{var e=this.values.peek();e.priority<c&&(this.values.push(d),this.values.pop())}this.now()>this.nextScaleTime&&this.rescale()},a.metricsStats.ExponentiallyDecayingSample.prototype.weight=function(a){return Math.exp(this.alpha*a)},a.metricsStats.ExponentiallyDecayingSample.prototype.rescale=function(){this.nextScaleTime=this.now()+this.rescaleThreshold;var a=this.values.content,b=[],c=this.startTime;this.startTime=this.tick();for(var d=0;d<a.length;d++)b.push({val:a[d].val,priority:a[d].priority*Math.exp(-this.alpha*(this.startTime-c))});this.values.content=b};var a=a||{};a.metricsStats=a.metricsStats||{},a.metricsStats.M1_ALPHA=1-Math.exp(-5/60),a.metricsStats.M5_ALPHA=1-Math.exp(-5/60/5),a.metricsStats.M15_ALPHA=1-Math.exp(-5/60/15),a.metricsStats.ExponentiallyWeightedMovingAverage=function(b,c){this.alpha=b,this.interval=c||5e3,this.currentRate=null,this.uncounted=0,this.lastTick=a.util.now()},a.metricsStats.ExponentiallyWeightedMovingAverage.prototype.update=function(a){this.uncounted+=a||1,this.tick()},a.metricsStats.ExponentiallyWeightedMovingAverage.prototype.tick=function(){var b=a.util.now(),c=b-this.lastTick;if(c>this.interval){this.lastTick=b-c%this.interval;for(var d=Math.floor(c/this.interval),e=0;d>e;++e){var f=this.uncounted/this.interval;this.uncounted=0,null!==this.currentRate?this.currentRate+=this.alpha*(f-this.currentRate):this.currentRate=f}}},a.metricsStats.ExponentiallyWeightedMovingAverage.prototype.rate=function(){return 1e3*this.currentRate};var a=a||{};a.metricTypes=a.metricTypes||{},a.metricTypes.BaseMetric=function(){this.value=0,this.name="",this.unitName=""},a.metricTypes.BaseMetric.prototype.get=function(){return this.value},a.metricTypes.BaseMetric.prototype.unit=function(a){return a?(this.unitName=a,this):this.unitName},a.metricTypes.Counter=a.util.extend(a.metricTypes.BaseMetric,function(){a.metricTypes.BaseMetric.apply(this,arguments),this.value=0}),a.metricTypes.Counter.prototype.inc=function(a){return this.value+=a?a:1},a.metricTypes.Counter.prototype.dec=function(a){return this.value-=a?a:1},a.metricTypes=a.metricTypes||{},a.metricTypes.Gauge=a.util.extend(a.metricTypes.BaseMetric,function(b){a.metricTypes.BaseMetric.apply(this,arguments),this.callback=b}),a.metricTypes.Gauge.prototype.set=function(a){return this.callback=a,this},a.metricTypes.Gauge.prototype.get=function(){return this.callback?this.callback():void 0},a.metricTypes.Histogram=a.util.extend(a.metricTypes.BaseMetric,function(){a.metricTypes.BaseMetric.apply(this,arguments),this.sample=new a.metricsStats.ExponentiallyDecayingSample,this.clear()}),a.metricTypes.Histogram.prototype.clear=function(){this.sample.clear(),this.min=this.max=null,this.varianceMean=0,this.varianceM2=0,this.sum=0,this.count=0},a.metricTypes.Histogram.prototype.mark=function(b,c){c=c||a.util.now(),this.sample.update(b,c),this.max=null===this.max?b:Math.max(this.max,b),this.min=null===this.min?b:Math.min(this.min,b),this.sum+=b,this.count++;var d=b-this.varianceMean;return this.varianceMean+=d/this.count,this.varianceM2+=d*(b-this.varianceMean),this.count},a.metricTypes.Histogram.prototype.get=function(){var a=this.sample.getValues().map(function(a){return parseFloat(a)}).sort(function(a,b){return a-b}),b=function(b){var c=b*a.length;if(c>=a.length)return a[a.length-1];c=Math.max(0,c),c=Math.min(c,a.length+1);var d=a[Math.floor(c)-1],e=a[Math.floor(c)];return d+(c-Math.floor(c))*(e-d)};return{percentile10:b(.1),percentile25:b(.25),median:b(.5),percentile75:b(.75),percentile90:b(.9),percentile95:b(.95),percentile99:b(.99),percentile999:b(.999),variance:this.count<1?null:this.varianceM2/(this.count-1),mean:0===this.count?null:this.varianceMean,stdDev:this.count<1?null:Math.sqrt(this.varianceM2/(this.count-1)),count:this.count,sum:this.sum,max:this.max,min:this.min}},a.metricTypes.Meter=a.util.extend(a.metricTypes.BaseMetric,function(){a.metricTypes.BaseMetric.apply(this,arguments),this.m1Rate=new a.metricsStats.ExponentiallyWeightedMovingAverage(a.metricsStats.M1_ALPHA),this.m5Rate=new a.metricsStats.ExponentiallyWeightedMovingAverage(a.metricsStats.M5_ALPHA),this.m15Rate=new a.metricsStats.ExponentiallyWeightedMovingAverage(a.metricsStats.M15_ALPHA),this.startTime=a.util.now(),this.value=0}),a.metricTypes.Meter.prototype.mark=function(a){return a=a||1,this.value+=a,this.m1Rate.update(a),this.m5Rate.update(a),this.m15Rate.update(a),this.value},a.metricTypes.Meter.prototype.get=function(){return{rate1m:this.m1Rate.rate(),rate5m:this.m5Rate.rate(),rate15m:this.m15Rate.rate(),rateMean:this.value/(a.util.now()-this.startTime)*1e3,count:this.value}},a.metricTypes.Meter.prototype.tick=function(){this.m1Rate.tick(),this.m5Rate.tick(),this.m15Rate.tick()},a.metricTypes.Timer=a.util.extend(a.metricTypes.BaseMetric,function(){a.metricTypes.BaseMetric.apply(this,arguments),this.meter=new a.metricTypes.Meter,this.histogram=new a.metricTypes.Histogram}),a.metricTypes.Timer.prototype.mark=function(a,b){this.meter.mark(),this.histogram.mark(a,b)},a.metricTypes.Timer.prototype.start=function(){var b=this,c=a.util.now();return function(){var d=a.util.now();b.mark(d-c,d)}},a.metricTypes.Timer.prototype.time=function(b){var c=a.util.now();try{b()}finally{var d=a.util.now();this.mark(d-c,d)}},a.metricTypes.Timer.prototype.get=function(){var a=this.histogram.get(),b=this.meter.get();for(var c in b)a[c]=b[c];return a};var a=a||{};a.MetricsRegistry=function(){this.metrics={};var a=this;this.gauge("registry.metrics.types").set(function(){return Object.keys(a.metrics).length})},a.MetricsRegistry.prototype.findOrCreateMetric=function(a,b){var c=this.metrics[a];return c?c instanceof b?c:null:(c=this.metrics[a]=new b,c.name=a,c)},a.MetricsRegistry.prototype.makeName=function(a){return Array.prototype.slice.call(a).join(".")},a.MetricsRegistry.prototype.counter=function(){return this.findOrCreateMetric(this.makeName(arguments),a.metricTypes.Counter)},a.MetricsRegistry.prototype.meter=function(){return this.findOrCreateMetric(this.makeName(arguments),a.metricTypes.Meter)},a.MetricsRegistry.prototype.gauge=function(){return this.findOrCreateMetric(this.makeName(arguments),a.metricTypes.Gauge)},a.MetricsRegistry.prototype.histogram=function(){return this.findOrCreateMetric(this.makeName(arguments),a.metricTypes.Histogram)},a.MetricsRegistry.prototype.timer=function(){return this.findOrCreateMetric(this.makeName(arguments),a.metricTypes.Timer)},a.MetricsRegistry.prototype.register=function(a,b){return this.metrics[this.makeName(a)]=b,b},a.MetricsRegistry.prototype.toJson=function(){var a={};for(var b in this.metrics){for(var c=b.split("."),d=a;c.length>1;){var e=c.shift();d=d[e]=d[e]||{}}d[c[0]]=this.metrics[b].get()}return a},a.MetricsRegistry.prototype.allMetrics=function(){var a=[];for(var b in this.metrics)a.push(this.metrics[b]);return a},a.metrics=new a.MetricsRegistry,a.util=a.util||{},a.util.ajax=function(b){return new Promise(function(c,d){var e=["PUT","POST","PATCH"],f=new XMLHttpRequest;f.open(b.method,b.href,!0),f.withCredentials=!0;var g=!0;Array.isArray(b.headers)&&b.headers.forEach(function(a){"Content-Type"===a.name&&(g=!1),f.setRequestHeader(a.name,a.value)}),e.indexOf(b.method)>=0&&g&&f.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),f.onload=function(){if(2===Math.floor(this.status/100)){var b;try{b=JSON.parse(this.responseText)}catch(e){b=this.reponseText||this.responseXML}c({response:b,header:a.util.ajaxResponseHeaderToJSON(this.getAllResponseHeaders())})}else d(this)},f.onerror=function(){d(this)};try{"POST"===b.method||"PUT"===b.method?f.send(b.data):f.send()}catch(h){d(h)}})},a.util.ajaxResponseHeaderToJSON=function(a){var b={};return a.split("\n").forEach(function(a){var c=a.split(":");2===c.length&&(b[c[0].trim()]=c[1].trim())}),b},a.AjaxPersistenceQueue=function(a){a=a||{},this.poolSize=a.poolSize||1,this.syncPool=[];for(var b=0;b<this.poolSize;++b)this.syncPool.push(Promise.resolve());this.nextSlot=0,this.queuedSyncs={}},a.AjaxPersistenceQueue.prototype.doSync=function(b,c){var d=c.getSelfUri();if(!d)return Promise.resolve();if(c.deleted)return a.util.ajax({href:d,method:"DELETE"});var e=c.serializedEntity();return"string"!=typeof e&&(e=JSON.stringify(e)),a.log.debug("PUT "+d,e),a.util.ajax({href:d,method:"PUT",data:e,headers:{"Content-Type":c.serializedContentType()}}).then(function(b){a.log.debug("  saving to "+d,b)},function(b){a.log.error("  FAILED saving to "+d,b)})},a.AjaxPersistenceQueue.prototype.queueNode=function(a,b){var c=this;return this.queuedSyncs[a]||(this.nextSlot=(this.nextSlot+1)%this.poolSize,this.syncPool[this.nextSlot]=this.queuedSyncs[a]=this.syncPool[this.nextSlot].then(function(){return delete c.queuedSyncs[a],c.doSync(a,b)})),this.queuedSyncs[a]},a.AsyncAction=function(){this.callbacks={}},a.AsyncAction.prototype.when=function(a,b,c){return c=c||this,this.resolution===a?b.apply(c,this.value):this.callbacks[a]=function(){return b.apply(c,arguments)},this},a.AsyncAction.prototype.resolve=function(a){if(this.resolution)throw"Cannot resolve an already resolved AsyncAction";var b=this.callbacks[a];return this.resolution=a,this.value=Array.prototype.slice.call(arguments,1),b&&b.apply(this,this.value),this},a.AsyncAction.prototype.success=function(a,b){return this.when("success",a,b)},a.AsyncAction.prototype.failure=function(a,b){return this.when("failure",a,b)},a.AsyncAction.all=function(b){var c=new a.AsyncAction,d=b.length,e=this,f=[];return b.forEach(function(a,b){e.isAnAction(a)?a.success(function(a){f[b]=a,0===--d&&c.resolve("success",f)},e).failure(function(a){c.resolve("failure",a)},e):(f[b]=a,0===--d&&c.resolve("success",f))}),c},a.AsyncAction.isAnAction=function(b){return a.AsyncAction.prototype.isPrototypeOf(b)};a.log=a.log||{NONE:{logLevel:!0,severity:0,name:"NONE"},DEFAULT:{logLevel:!0,severity:1,name:"DEFAULT"},ERROR:{logLevel:!0,severity:3,name:"ERROR"},INFO:{logLevel:!0,severity:6,name:"INFO"},DEBUG:{logLevel:!0,severity:7,name:"DEBUG"},ALL:{logLevel:!0,severity:10,name:"ALL"},threshold:3,setThreshold:function(b){if("number"==typeof b)a.log.threshold=b;else{if("number"!=typeof b.severity)throw new TypeError("Threshold must be a number or one of the ozpIwc.log constants.  Instead got"+b);a.log.threshold=b.severity}},log:function(b){b.logLevel===!0&&"number"==typeof b.severity?a.log.logMsg(b,Array.prototype.slice.call(arguments,1)):a.log.logMsg(a.log.DEFAULT,Array.prototype.slice.call(arguments,0))},logMsg:function(b,c){if(!(b.severity>a.log.threshold)&&console&&console.log){var d=c.reduce(function(a,b){return b instanceof Error?a+b.toString()+(b.stack?" -- "+b.stack:""):"object"==typeof b?a+JSON.stringify(b,null,2):a+b},"["+b.name+"] ");console.log(d)}},error:function(){a.log.logMsg(a.log.ERROR,Array.prototype.slice.call(arguments,0))},debug:function(){a.log.logMsg(a.log.DEBUG,Array.prototype.slice.call(arguments,0))},info:function(){a.log.logMsg(a.log.INFO,Array.prototype.slice.call(arguments,0))}},function(a,b){"use strict";function c(a){return o[n]=d.apply(b,a),n++}function d(a){var c=[].slice.call(arguments,1);return function(){"function"==typeof a?a.apply(b,c):new Function(""+a)()}}function e(a){if(p)setTimeout(d(e,a),0);else{var b=o[a];if(b){p=!0;try{b()}finally{f(a),p=!1}}}}function f(a){delete o[a]}function g(){m=function(){var a=c(arguments);return process.nextTick(d(e,a)),a}}function h(){if(a.postMessage&&!a.importScripts){var b=!0,c=a.onmessage;return a.onmessage=function(){b=!1},a.postMessage("","*"),a.onmessage=c,b}}function i(){var b="setImmediate$"+Math.random()+"$",d=function(c){c.source===a&&"string"==typeof c.data&&0===c.data.indexOf(b)&&e(+c.data.slice(b.length))};a.addEventListener?a.addEventListener("message",d,!1):a.attachEvent("onmessage",d),m=function(){var d=c(arguments);return a.postMessage(b+d,"*"),d}}function j(){var a=new MessageChannel;a.port1.onmessage=function(a){var b=a.data;e(b)},m=function(){var b=c(arguments);return a.port2.postMessage(b),b}}function k(){var a=q.documentElement;m=function(){var b=c(arguments),d=q.createElement("script");return d.onreadystatechange=function(){e(b),d.onreadystatechange=null,a.removeChild(d),d=null},a.appendChild(d),b}}function l(){m=function(){var a=c(arguments);return setTimeout(d(e,a),0),a}}if(!a.setImmediate){var m,n=1,o={},p=!1,q=a.document,r=Object.getPrototypeOf&&Object.getPrototypeOf(a);r=r&&r.setTimeout?r:a,"[object process]"==={}.toString.call(a.process)?g():h()?i():a.MessageChannel?j():q&&"onreadystatechange"in q.createElement("script")?k():l(),r.setImmediate=m,r.clearImmediate=f}}(new Function("return this")()),a.util=a.util||{},a.util.generateId=function(){return Math.floor(4294967295*Math.random()).toString(16)},a.util.setImmediate=function(a){window.setImmediate(a)},a.util.arrayContainsAll=function(a,b,c){return c=c||function(a,b){return a===b},b.every(function(b){return a.some(function(a){return c(a,b)})})},a.util.objectContainsAll=function(a,b,c){c=c||function(a,b){return a===b};for(var d in b)if(!c(a[d],b[d]))return!1;return!0},a.util.openWindow=function(a,b,c){if("object"==typeof b){var d="";for(var e in b)d+=e+"="+encodeURIComponent(b[e])+"&";b=d}try{window.open(a,b,c)}catch(f){window.open(a+"?"+b,null,c)}},function(){a.BUS_ROOT=window.location.protocol+"//"+window.location.host+window.location.pathname.replace(/[^\/]+$/,""),a.INTENT_CHOOSER_FEATURES="width=330,height=500"}(),a.util.alert=function(b,c){this.alerts=this.alerts||{},this.alerts[b]?this.alerts[b].error=c:this.alerts[b]={error:c,silence:!1},this.alerts[b].silence||(this.alerts[b].silence=!0,a.log.log(b,c))},a.util.ensureArray=function(a){return Array.isArray(a)?a:[a]},a=a||{},a.policyAuth=a.policyAuth||{},a.policyAuth.SecurityAttribute=function(a){a=a||{},this.attributes=a.attributes||{},this.comparator=a.comparator||this.comparator},a.policyAuth.SecurityAttribute.prototype.pushIfNotExist=function(b,c,d){if(d=d||this.comparator,c){var e=a.util.ensureArray(c);if(this.attributes[b])for(var f in this.attributes[b])for(var g in e)d(this.attributes[b][f],e[g])||this.attributes[b].push(c);else this.attributes[b]=[],this.attributes[b]=this.attributes[b].concat(e)}},a.policyAuth.SecurityAttribute.prototype.clear=function(a){delete this.attributes[a]},a.policyAuth.SecurityAttribute.prototype.clearAll=function(){this.attributes={}},a.policyAuth.SecurityAttribute.prototype.getAll=function(){return this.attributes},a.policyAuth.SecurityAttribute.prototype.comparator=function(a,b){return a===b},a=a||{},a.policyAuth=a.policyAuth||{},a.policyAuth.PDP=function(b){b=b||{},this.prp=b.prp||new a.policyAuth.PRP,this.pip=b.pip||new a.policyAuth.PIP,this.policySets=b.policySets||{connectSet:["policy://ozpIwc/connect"],apiSet:["policy://policy/apiNode"],readSet:["policy://policy/read"],receiveAsSet:["policy://policy/receiveAs"],sendAsSet:["policy://policy/sendAs"]}},a.policyAuth.PDP.prototype.isPermitted=function(b){var c=new a.AsyncAction,d=this;if(!b)return c.resolve("success",{result:"Permit"});var e=function(a){c.resolve("failure",a)};return this.formatRequest(b).success(function(f){d.prp.getPolicies(f.policies).success(function(d){var g=a.policyAuth.PolicyCombining[f.combiningAlgorithm](d,f.category),h={result:g,request:b,formattedRequest:f};"Permit"===g?c.resolve("success",h):e(h)}).failure(e)}).failure(e),c},a.policyAuth.PDP.prototype.formatAttributes=function(b,c){b=a.util.ensureArray(b);var d=new a.AsyncAction;c=c||this.pip;var e=[];for(var f in b)e.push(this.formatAttribute(b[f],c));return a.AsyncAction.all(e).success(function(a){var b={};for(var c in a)if(Object.keys(a[c]).length>0)for(var e in a[c])b[e]=a[c][e];d.resolve("success",b)}),d},a.policyAuth.PDP.prototype.formatAttribute=function(b,c){var d=new a.AsyncAction;if(c=c||this.pip,!b)return d.resolve("success");if(b)if("string"==typeof b)c.getAttributes(b).success(function(a){d.resolve("success",a)});else{if(Array.isArray(b))return this.formatAttributes(b,c);if("object"==typeof b){var e=Object.keys(b);for(var f in e){var g=b[e[f]];["string","number","boolean"].indexOf(typeof b[e[f]])>=0&&(b[e[f]]=[g]),b[e[f]]=b[e[f]]||[]}d.resolve("success",b)}}else d.resolve("success",{});return d},a.policyAuth.PDP.prototype.formatAction=function(a){var b=[],c=function(a,b){var c;return a["ozp:iwc:action"]&&(c=a["ozp:iwc:action"]),Array.isArray(c)?d(c,b):void(["string","number","boolean"].indexOf(typeof c)>=0&&b.indexOf(c)<0&&b.push(c))},d=function(a,b){for(var e in a)"string"==typeof a[e]?b.indexOf(a[e])<0&&b.push(a[e]):Array.isArray(a[e])?d(a[e],b):"object"==typeof a[e]&&c(a[e],b)};return a&&("string"==typeof a?b.push(a):Array.isArray(a)?d(a,b):"object"==typeof a&&c(a,b)),{"ozp:iwc:action":b}},a.policyAuth.PDP.prototype.formatRequest=function(b,c){var d=new a.AsyncAction;c=c||this.pip,b=b||{},b.subject=b.subject||{},b.resource=b.resource||{},b.action=b.action||{},b.combiningAlgorithm=b.combiningAlgorithm||this.defaultCombiningAlgorithm;var e=[],f=this.formatAttribute(b.subject,c),g=this.formatAttribute(b.resource,c),h=this.formatAction(b.action);return e.push(f,g,h),a.AsyncAction.all(e).success(function(a){var c=a[0],e=a[1],f=a[2];d.resolve("success",{category:{subject:c,resource:e,action:f},combiningAlgorithm:b.combiningAlgorithm,policies:b.policies})}).failure(function(a){d.resolve("failure",a)}),d},a.policyAuth.PDP.prototype.defaultCombiningAlgorithm="deny-overrides",a.policyAuth.PDP.prototype.formatCategory=function(b,c){var d=new a.AsyncAction;return b?(c=c||this.pip,this.formatAttribute(b,c).success(function(a){for(var b in a["ozp:iwc:permissions"])a[b]=a["ozp:iwc:permissions"][b];delete a["ozp:iwc:permissions"],d.resolve("success",a)}).failure(function(a){d.resolve("failure",a)}),d):d.resolve("success")},a.policyAuth.PDP.prototype.formatCategories=function(b,c){var d=new a.AsyncAction;c=c||this.pip;var e=[],f={};for(var g in b)e.push(this.formatCategory(b[g],c)),f[g]=e.length-1;return a.AsyncAction.all(e).success(function(a){var b={},c=Object.keys(f);for(var e in c)b[c[e]]=a[f[c[e]]]||{};d.resolve("success",b)}).failure(function(a){d.resolve("failure",a)}),d},a=a||{},a.policyAuth=a.policyAuth||{},a.policyAuth.PIP=a.util.extend(a.policyAuth.SecurityAttribute,function(){a.policyAuth.SecurityAttribute.apply(this,arguments)}),a.policyAuth.PIP.prototype.getAttributes=function(b){var c=new a.AsyncAction,d=this;return this.attributes[b]?c.resolve("success",d.attributes[b]):(a.util.ajax({href:b,method:"GET"}).then(function(e){if("object"!=typeof e)return c.resolve("failure","Invalid data loaded from the remote PIP");d.attributes[b]={};for(var f in e)d.attributes[b][f]=a.util.ensureArray(e[f]);c.resolve("success",d.attributes[b])})["catch"](function(a){c.resolve("failure",a)}),c)},a.policyAuth.PIP.prototype.grantAttributes=function(b,c){var d={};for(var e in c)d[e]=a.util.ensureArray(c[e]);this.attributes[b]=d},a.policyAuth.PIP.prototype.grantParent=function(b,c){var d=new a.AsyncAction;this.attributes[b]=this.attributes[b]||{};var e=this;if(e.attributes[c]){for(var f in e.attributes[c]){e.attributes[b][f]=e.attributes[b][f]||[];for(var g in e.attributes[c][f])e.attributes[b][f].indexOf(e.attributes[c][f][g])<0&&e.attributes[b][f].push(e.attributes[c][f][g])}return d.resolve("success",e.attributes[b])}return e.getAttributes(c).success(function(a){for(var c in a)e.attributes[b].indexOf(a[c])<0&&e.attributes[b].push(a[c]);d.resolve("success",e.attributes[b])}).failure(function(a){d.resolve("failure",a)}),d},a.policyAuth.PIP.prototype.combineAttributeValues=function(a,b,c){return[b,c]},a.policyAuth.PIP.prototype.attributeUnion=function(b,c){var d={};return a.object.eachEntry(b,function(a,b){d[a]=Array.isArray(b)?b.slice():b}),a.object.eachEntry(c,function(a,b){d[a]=a in d?Array.isArray(d[a])?d[a].concat(b):this.combineAttributeValues(d[a],b):b},this),d},a.ozpIwcPolicies={},a.ozpIwcPolicies.permitWhenObjectHasNoAttributes=function(a){return a.object&&0===Object.keys(a.object).length?"Permit":"Undetermined"},a.ozpIwcPolicies.subjectHasAllObjectAttributes=function(b){if(!b.object)return"Permit";var c=b.subject||{};return a.util.objectContainsAll(c,b.object,this.implies)?"Permit":"Deny"},a.ozpIwcPolicies.permitAll=function(){return"Permit"},a.ozpIwcPolicies.denyAll=function(){return"Deny"},a.ozpIwcPolicies.implies=function(b,c){return void 0===c||null===c?!0:void 0===b||null===b?!1:(b=a.util.ensureArray(b),c=a.util.ensureArray(c),a.util.arrayContainsAll(b,c))},a.ozpIwcPolicies.defaultPolicy=function(b,c){return c=a.util.ensureArray(c),a.util.arrayContainsAll(c,b.action["ozp:iwc:action"])?a.util.objectContainsAll(b.subject,b.resource,a.ozpIwcPolicies.implies)?"Permit":"Deny":"NotApplicable"},a.ozpIwcPolicies.defaultPolicies={},a.ozpIwcPolicies.defaultPolicies["policy://ozpIwc/connect"]=function(b){var c=["connect"];return a.util.arrayContainsAll(c,b.action["ozp:iwc:action"])?"Permit":"NotApplicable"},a.ozpIwcPolicies.defaultPolicies["policy://policy/sendAs"]=function(b){return a.ozpIwcPolicies.defaultPolicy(b,"sendAs")},a.ozpIwcPolicies.defaultPolicies["policy://policy/receiveAs"]=function(b){return a.ozpIwcPolicies.defaultPolicy(b,"receiveAs")},a.ozpIwcPolicies.defaultPolicies["policy://policy/read"]=function(b){return a.ozpIwcPolicies.defaultPolicy(b,"read")},a.ozpIwcPolicies.defaultPolicies["policy://policy/apiNode"]=function(b){return a.ozpIwcPolicies.defaultPolicy(b,"access")},a=a||{},a.policyAuth=a.policyAuth||{},a.policyAuth.PolicyCombining=a.policyAuth.PolicyCombining||{},a.policyAuth.PolicyCombining["deny-overrides"]=function(a,b){var c,d,e,f=!1;for(var g in a){var h=a[g](b);switch(h){case"Deny":return"Deny";case"Permit":f=!0;break;case"NotApplicable":continue;case"Indeterminate{D}":c=!0;break;case"Indeterminate{P}":d=!0;break;case"Indeterminate{DP}":e=!0;break;default:continue}}return e?"Indeterminate{DP}":c&&(d||f)?"Indeterminate{DP}":c?"Indeterminate{D}":f?"Permit":d?"Indeterminate{P}":"NotApplicable"},a.policyAuth.PolicyCombining["permit-overrides"]=function(){},a.policyAuth.PolicyCombining["first-applicable"]=function(){},a.policyAuth.PolicyCombining["only-one-applicable"]=function(){},a.policyAuth.PolicyCombining["ordered-deny-overrides"]=function(){},a.policyAuth.PolicyCombining["ordered-permit-overrides"]=function(){},a.policyAuth.PolicyCombining["deny-unless-permit"]=function(){},a.policyAuth.PolicyCombining["permit-unless-deny"]=function(){},a=a||{},a.policyAuth=a.policyAuth||{},a.policyAuth.PRP=function(b){b=b||{},this.persistentPolicies=b.persistentPolicies||[],this.policyCache=b.policyCache||a.ozpIwcPolicies.defaultPolicies},a.policyAuth.PRP.prototype.getPolicies=function(b){var c=new a.AsyncAction;b=b||[],b=a.util.ensureArray(b);var d=[],e=this.persistentPolicies.concat(b);for(var f in e)if(this.policyCache[e[f]])d.push(a.util.clone(this.policyCache[e[f]]));else{var g=this.fetchPolicy(e[f]);d.push(g)}return 0===d.length?c.resolve("success",[a.ozpIwcPolicies.permitAll]):a.AsyncAction.all(d)},a.policyAuth.PRP.prototype.defaultCombiningAlgorithm="urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-overrides",a.policyAuth.PRP.prototype.fetchPolicy=function(b){var c=new a.AsyncAction,d=this;
return a.util.ajax({method:"GET",href:b}).then(function(e){d.policyCache[b]=d.formatPolicy(e.response),c.resolve("success",a.util.clone(d.policyCache[b]))})["catch"](function(){c.resolve("success",d.getDenyall(b))}),c},a.policyAuth.PRP.prototype.formatPolicy=function(b){return new a.policyAuth.Policy(b)},a.policyAuth.PRP.prototype.getDenyall=function(b){return this.policyCache[b]?this.policyCache[b]:(this.policyCache[b]=a.ozpIwcPolicies.denyAll,this.policyCache[b])},a.KeyBroadcastLocalStorageLink=function(b){b=b||{},this.prefix=b.prefix||"ozpIwc",this.peer=b.peer||a.defaultPeer,this.selfId=b.selfId||this.peer.selfId,this.metricsPrefix="keyBroadcastLocalStorageLink."+this.selfId,this.droppedFragmentsCounter=a.metrics.counter(this.metricsPrefix,"fragmentsDropped"),this.fragmentsReceivedCounter=a.metrics.counter(this.metricsPrefix,"fragmentsReceived"),this.packetsSentCounter=a.metrics.counter(this.metricsPrefix,"packetsSent"),this.packetsReceivedCounter=a.metrics.counter(this.metricsPrefix,"packetsReceived"),this.packetParseErrorCounter=a.metrics.counter(this.metricsPrefix,"packetsParseError"),this.packetsFailedCounter=a.metrics.counter(this.metricsPrefix,"packetsFailed"),this.latencyInTimer=a.metrics.timer(this.metricsPrefix,"latencyIn"),this.latencyOutTimer=a.metrics.timer(this.metricsPrefix,"latencyOut"),this.myKeysTimeout=b.myKeysTimeout||5e3,this.otherKeysTimeout=b.otherKeysTimeout||12e4,this.maxRetries=b.maxRetries||6,this.queueSize=b.queueSize||1024,this.sendQueue=this.sendQueue||[],this.fragments=this.fragments||[],this.fragmentSize=b.fragmentSize||1310720,this.fragmentTimeout=b.fragmentTimeout||1e3,String.prototype.chunk=function(a){for(var b=[],c=0;c<this.length;c+=a)b.push(this.slice(c,c+a));return b};var c,d=this,e=function(b){if(b.newValue){try{c=JSON.parse(b.newValue)}catch(e){return a.log.log("Parse error on "+b.newValue),void d.packetParseErrorCounter.inc()}c.data.fragment?d.handleFragment(c):d.forwardToPeer(c)}};a.util.getInternetExplorerVersion()>=0?window.setTimeout(function(){a.util.addEventListener("storage",e)},500):a.util.addEventListener("storage",e),this.peer.on("send",function(a){d.send(a.packet)}),this.peer.on("beforeShutdown",function(){a.util.removeEventListener("storage",e)},this)},a.KeyBroadcastLocalStorageLink.prototype.forwardToPeer=function(b){this.peer.receive(this.linkId,b),this.packetsReceivedCounter.inc(),b.data.time&&this.latencyInTimer.mark(a.util.now()-b.data.time)},a.KeyBroadcastLocalStorageLink.prototype.handleFragment=function(a){if(!this.peer.haveSeen(a)){var b=a.data.msgId;this.storeFragment(a);var c=this.defragmentPacket(this.fragments[b]);if(c){window.clearTimeout(this.fragments[b].fragmentTimer);var d=this.peer.packetsSeen[c.srcPeer].indexOf(c.sequence);delete this.peer.packetsSeen[c.srcPeer][d],this.forwardToPeer(c),delete this.fragments[b]}}},a.KeyBroadcastLocalStorageLink.prototype.storeFragment=function(a){if(!a.data.fragment)return null;var b=a.sequence,c=a.srcPeer,d=a.data.msgId,e=a.data.id,f=a.data.chunk,g=a.data.total;if(void 0===d||void 0===e)return null;if(!this.fragments[d]){this.fragments[d]={},this.fragments[d].chunks=[];var h=this;h.key=d,h.total=g,this.fragments[d].timeoutFunc=function(){h.droppedFragmentsCounter.inc(h.total),delete h.fragments[h.key]}}return window.clearTimeout(this.fragments[d].fragmentTimer),this.fragments[d].fragmentTimer=window.setTimeout(this.fragments[d].timeoutFunc,this.fragmentTimeout),this.fragments[d].total=g||this.fragments[d].total,this.fragments[d].sequence=void 0!==b?b:this.fragments[d].sequence,this.fragments[d].srcPeer=c||this.fragments[d].srcPeer,this.fragments[d].chunks[e]=f,void 0===this.fragments[d].total||void 0===this.fragments[d].sequence||void 0===this.fragments[d].srcPeer?null:(this.fragmentsReceivedCounter.inc(),!0)},a.KeyBroadcastLocalStorageLink.prototype.defragmentPacket=function(a){if(a.total!==a.chunks.length)return null;try{var b=JSON.parse(a.chunks.join(""));return{defragmented:!0,sequence:a.sequence,srcPeer:a.srcPeer,data:b}}catch(c){return null}},a.KeyBroadcastLocalStorageLink.prototype.send=function(b){var c;try{c=JSON.stringify(b.data)}catch(d){this.packetsFailedCounter.inc();var e=b.msgId||"unknown";return void a.log.error("Failed to write packet(msgId="+e+"):"+d.message)}if(c.length<this.fragmentSize)this.queueSend(b);else{var f=c.chunk(this.fragmentSize),g=this;g.data=b.data,delete b.data;for(var h=function(a,b){return b.sequence=g.peer.sequenceCounter++,b.data={fragment:!0,msgId:g.data.msgId,id:i,total:f.length,chunk:a},b},i=0;i<f.length;i++)this.queueSend(h(f[i],b))}},a.KeyBroadcastLocalStorageLink.prototype.queueSend=function(b){if(this.sendQueue.length<this.queueSize)for(this.sendQueue=this.sendQueue.concat(b);this.sendQueue.length>0;)this.attemptSend(this.sendQueue.shift());else this.packetsFailedCounter.inc(),a.log.error("Failed to write packet(len="+b.length+"): Send queue full.")},a.KeyBroadcastLocalStorageLink.prototype.attemptSend=function(b,c){var d=this.sendImpl(b);if(d){var e=this;c=c||0;var f=Math.max(1,Math.pow(2,c-1))-1;if(!(c<e.maxRetries))return this.packetsFailedCounter.inc(),a.log.error("Failed to write packet(len="+b.length+"):"+d),d;c++,window.setTimeout(function(){e.attemptSend(b,c)},f)}},a.KeyBroadcastLocalStorageLink.prototype.sendImpl=function(b){var c;try{var d=JSON.stringify(b);localStorage.setItem("x",d),this.packetsSentCounter.inc(),b.data.time&&this.latencyOutTimer.mark(a.util.now()-b.data.time),localStorage.removeItem("x"),c=null}catch(e){"localStorage is null"===e.message?a.util.alert("Cannot locate localStorage. Contact your system administrator.",e):18===e.code?a.util.alert("Ozone requires your browser to accept cookies. Contact your system administrator.",e):c=e}finally{return c}},a.Peer=function(){this.selfId=a.util.generateId(),this.metricPrefix="peer."+this.selfId,this.sequenceCounter=0,this.packetsSeen={},this.knownPeers={},this.events=new a.Event,this.events.mixinOnOff(this);var b=this;this.unloadListener=function(){b.shutdown()},a.util.addEventListener("beforeunload",this.unloadListener)},a.Peer.maxSeqIdPerSource=500,a.Peer.prototype.haveSeen=function(b){if(b.srcPeer===this.selfId)return a.metrics.counter(this.metricPrefix,"droppedOwnPacket").inc(),!0;var c=this.packetsSeen[b.srcPeer];return c||(c=this.packetsSeen[b.srcPeer]=[]),c.indexOf(b.sequence)>=0?!0:(c.unshift(b.sequence),c.length>=a.Peer.maxSeqIdPerSource&&(c.length=a.Peer.maxSeqIdPerSource),!1)},a.Peer.prototype.send=function(b){var c={srcPeer:this.selfId,sequence:this.sequenceCounter++,data:b},d=new a.CancelableEvent({packet:c});this.events.trigger("preSend",d),d.canceled?a.metrics.counter(this.metricPrefix,"sendRejected").inc():(a.metrics.counter(this.metricPrefix,"sent").inc(),b.time&&a.metrics.timer(this.metricPrefix,"latencyOut").mark(a.util.now()-b.time),this.events.trigger("send",{packet:c}))},a.Peer.prototype.receive=function(b,c){return this.haveSeen(c)?void a.metrics.counter(this.metricPrefix,"dropped").inc():(a.metrics.counter(this.metricPrefix,"received").inc(),c.data.time&&a.metrics.timer(this.metricPrefix,"latencyIn").mark(a.util.now()-c.data.time),void this.events.trigger("receive",{packet:c,linkId:b}))},a.Peer.prototype.shutdown=function(){this.events.trigger("beforeShutdown"),a.util.removeEventListener("beforeunload",this.unloadListener)},a.Participant=function(){this.events=new a.Event,this.events.mixinOnOff(this),this.permissions=new a.policyAuth.SecurityAttribute,this.msgId=0,this.sentPacketsMeter=new a.metricTypes.Meter,this.receivedPacketsMeter=new a.metricTypes.Meter,this.forbiddenPacketsMeter=new a.metricTypes.Meter,this.latencyInTimer=new a.metricTypes.Meter,this.latencyOutTimer=new a.metricTypes.Meter,this.participantType=this.constructor.name,this.heartBeatContentType="application/vnd.ozp-iwc-address-v1+json",this.heartBeatStatus={name:this.name,type:this.participantType||this.constructor.name},this.replyCallbacks={};var b=this;a.util.addEventListener("beforeunload",function(){b.send=function(c,d){var e=this.fixPacket(c);return d&&(b.replyCallbacks[e.msgId]=d),a.Participant.prototype.send.call(b,e),e},b.leaveEventChannel()})},a.Participant.prototype.receiveFromRouter=function(b){var c=this,d={subject:this.permissions.getAll(),resource:{"ozp:iwc:receiveAs":b.packet.dst},action:{"ozp:iwc:action":"receiveAs"},policies:a.authorization.policySets.receiveAsSet},e=function(b){c.forbiddenPacketsMeter.mark(),a.metrics.counter("transport.packets.forbidden").inc(),console.error("failure",b)};a.authorization.isPermitted(d,this).success(function(){a.authorization.formatCategory(b.packet.permissions).success(function(d){var f={subject:c.permissions.getAll(),resource:d||{},action:{"ozp:iwc:action":"read"},policies:a.authorization.policySets.readSet};a.authorization.isPermitted(f,c).success(function(){c.receivedPacketsMeter.mark(),b.packet.time&&c.latencyInTimer.mark(a.util.now()-b.packet.time),c.receiveFromRouterImpl(b)}).failure(e)}).failure(e)}).failure(e)},a.Participant.prototype.receiveFromRouterImpl=function(a){return!a},a.Participant.prototype.connectToRouter=function(b,c){this.address=c,this.router=b,this.msgId=0,this.metricRoot=this.name?"participants."+this.name+"."+this.address.split(".").reverse().join("."):"participants."+this.address.split(".").reverse().join("."),this.sentPacketsMeter=a.metrics.meter(this.metricRoot,"sentPackets").unit("packets"),this.receivedPacketsMeter=a.metrics.meter(this.metricRoot,"receivedPackets").unit("packets"),this.forbiddenPacketsMeter=a.metrics.meter(this.metricRoot,"forbiddenPackets").unit("packets"),this.latencyInTimer=a.metrics.timer(this.metricRoot,"latencyIn").unit("packets"),this.latencyOutTimer=a.metrics.timer(this.metricRoot,"latencyOut").unit("packets"),this.namesResource="/address/"+this.address,this.heartBeatStatus.address=this.address,this.heartBeatStatus.name=this.name,this.heartBeatStatus.type=this.participantType||this.constructor.name,this.events.trigger("connectedToRouter"),this.joinEventChannel()},a.Participant.prototype.fixPacket=function(b){return b.src=b.src||this.address,b.ver=b.ver||1,b.msgId=b.msgId||this.generateMsgId(),b.time=b.time||a.util.now(),b},a.Participant.prototype.send=function(b){var c=this,d={subject:this.permissions.getAll(),resource:{"ozp:iwc:sendAs":b.src},action:{"ozp:iwc:action":"sendAs"},policies:a.authorization.policySets.sendAsSet};return b=c.fixPacket(b),a.authorization.isPermitted(d,c).success(function(){c.sentPacketsMeter.mark(),b.time&&c.latencyOutTimer.mark(a.util.now()-b.time),c.router.send(b,c)}).failure(function(a){console.error("Participant "+c.address+" failed to send a packet:",a,b)}),b},a.Participant.prototype.generateMsgId=function(){return"i:"+this.msgId++},a.Participant.prototype.heartbeat=function(){this.router&&this.send({dst:"names.api",resource:this.namesResource,action:"set",entity:this.heartBeatStatus,contentType:this.heartBeatContentType})},a.Participant.prototype.joinEventChannel=function(){return this.router?(this.router.registerMulticast(this,["$bus.multicast"]),this.send({dst:"$bus.multicast",action:"connect",entity:{address:this.address,participantType:this.participantType}}),!0):!1},a.Participant.prototype.leaveEventChannel=function(){return this.router?(this.send({dst:"$bus.multicast",action:"disconnect",entity:{address:this.address,participantType:this.participantType,namesResource:this.namesResource}}),!0):!1},a.InternalParticipant=a.util.extend(a.Participant,function(b){b=b||{},a.Participant.apply(this,arguments),this.replyCallbacks={},this.participantType="internal",this.name=b.name;var c=this;this.on("connectedToRouter",function(){c.permissions.pushIfNotExist("ozp:iwc:address",c.address),c.permissions.pushIfNotExist("ozp:iwc:sendAs",c.address),c.permissions.pushIfNotExist("ozp:iwc:receiveAs",c.address),a.metrics.gauge(c.metricRoot,"registeredCallbacks").set(function(){return c.getCallbackCount()})})}),a.InternalParticipant.prototype.getCallbackCount=function(){return this.replyCallbacks&&Object.keys(this.replyCallbacks)?Object.keys(this.replyCallbacks).length:0},a.InternalParticipant.prototype.receiveFromRouterImpl=function(a){var b=a.packet;if(b.replyTo&&this.replyCallbacks[b.replyTo]){var c=!1,d=function(){c=!0};this.replyCallbacks[b.replyTo](b,d),c&&this.cancelCallback(b.replyTo)}else"$bus.multicast"===b.dst?this.events.trigger("receiveEventChannelPacket",a):this.events.trigger("receive",a)},a.InternalParticipant.prototype.send=function(b,c){var d=this.fixPacket(b);c&&(this.replyCallbacks[d.msgId]=c);var e=this,f=a.Participant.prototype.send;return a.util.setImmediate(function(){f.call(e,d)}),d},a.InternalParticipant.prototype.cancelCallback=function(a){var b=!1;return a&&(delete this.replyCallbacks[a],b=!0),b},a.TransportPacketContext=function(a){for(var b in a)this[b]=a[b]},a.TransportPacketContext.prototype.makeReplyTo=function(a){var b=(new Date).getTime();return a.ver=a.ver||1,a.time=a.time||b,a.replyTo=a.replyTo||this.packet.msgId,a.src=a.src||this.packet.dst,a.dst=a.dst||this.packet.src,a},a.TransportPacketContext.prototype.replyTo=function(b){return b=this.makeReplyTo(b),this.dstParticipant?this.dstParticipant.send(b):(b.msgId=b.msgId||a.util.now(),this.router.send(b)),b},a.Router=function(b){b=b||{},this.peer=b.peer||a.defaultPeer;var c=this;this.selfId=a.util.generateId(),this.participants={},a.metrics.gauge("transport.participants").set(function(){return Object.keys(c.participants).length}),this.events=new a.Event,this.events.mixinOnOff(this),this.peer.on("receive",function(a){c.receiveFromPeer(a.packet)});var d=function(b){var c=b.packet;1!==c.ver&&b.cancel("badVersion"),c.src||b.cancel("nullSource"),c.dst||b.cancel("nullDestination"),b.canceled&&a.metrics.counter("transport.packets.invalidFormat").inc()};this.events.on("preSend",d),b.disableBus||(this.participants["$bus.multicast"]=new a.MulticastParticipant("$bus.multicast")),this.watchdog=new a.RouterWatchdog({router:this,heartbeatFrequency:b.heartbeatFrequency}),this.registerParticipant(this.watchdog),this.recursionDepth=0,a.metrics.gauge("transport.router.participants").set(function(){return c.getParticipantCount()})},a.Router.prototype.getParticipantCount=function(){return this.participants&&Object.keys(this.participants)?Object.keys(this.participants).length:0},a.Router.prototype.shutdown=function(){this.watchdog.shutdown()},a.Router.prototype.registerParticipant=function(b,c){c=c||{};var d;do d=a.util.generateId()+"."+this.selfId;while(this.participants.hasOwnProperty(d));var e=new a.CancelableEvent({packet:c,registration:c.entity,participant:b});if(this.events.trigger("preRegisterParticipant",e),e.canceled)return a.log.log("registeredParticipant[DENIED] origin:"+b.origin+" because "+e.cancelReason),null;this.participants[d]=b,b.connectToRouter(this,d);var f=new a.CancelableEvent({packet:c,participant:b});return this.events.trigger("registeredParticipant",f),d},a.Router.prototype.deliverLocal=function(b,c){if(!b)throw"Cannot deliver a null packet!";var d=this.participants[b.dst];if(d){this.recursionDepth++,this.recursionDepth>10&&console.log("Recursing more than 10 levels deep on ",b);try{var e=new a.TransportPacketContext({packet:b,router:this,srcParticipant:c,dstParticipant:d}),f=new a.CancelableEvent({packet:b,dstParticipant:d,srcParticipant:c});if(this.events.trigger("preDeliver",f).canceled)return void a.metrics.counter("transport.packets.rejected").inc();a.metrics.counter("transport.packets.delivered").inc(),d.receiveFromRouter(e)}finally{this.recursionDepth--}}},a.Router.prototype.registerMulticast=function(b,c){var d=this;return c.forEach(function(c){var e=d.participants[c];if(e||(e=d.participants[c]=new a.MulticastParticipant(c)),e.addMember(b),b.address){var f=new a.CancelableEvent({entity:{group:c,address:b.address}});b.permissions.pushIfNotExist("ozp:iwc:sendAs",c),b.permissions.pushIfNotExist("ozp:iwc:receiveAs",c),d.events.trigger("registeredMulticast",f)}else a.log.log("no address for "+b.participantType+" "+b.name+"with address "+b.address+" for group "+c)}),c},a.Router.prototype.send=function(b,c){var d=new a.CancelableEvent({packet:b,participant:c});return this.events.trigger("preSend",d),d.canceled?void a.metrics.counter("transport.packets.sendCanceled"):(a.metrics.counter("transport.packets.sent").inc(),this.deliverLocal(b,c),this.events.trigger("send",{packet:b}),void this.peer.send(b))},a.Router.prototype.receiveFromPeer=function(b){a.metrics.counter("transport.packets.receivedFromPeer").inc();var c=Date.now();a.metrics.histogram("transport.packets.latency").mark(c-b.data.time,c);var d=new a.CancelableEvent({packet:b.data,rawPacket:b});this.events.trigger("prePeerReceive",d),d.canceled||this.deliverLocal(b.data)},a.ClientParticipant=a.util.extend(a.Participant,function(b){b=b||{},a.Participant.apply(this,arguments),this.participantType="internalClient",this.internal=b.internal||!1,this.name=b.name,this.router=b.router||a.defaultRouter;var c=this;this.on("connectedToRouter",function(){c.permissions.pushIfNotExist("ozp:iwc:address",c.address),c.permissions.pushIfNotExist("ozp:iwc:sendAs",c.address),c.permissions.pushIfNotExist("ozp:iwc:receiveAs",c.address),a.metrics.gauge(c.metricRoot,"registeredCallbacks").set(function(){return c.replyCallbacks&&Object.keys(c.replyCallbacks)?Object.keys(c.replyCallbacks).length:0})}),a.ApiPromiseMixin(this,b.autoConnect)}),a.ClientParticipant.prototype.connect=function(){if(!this.connectPromise){var a=this;this.connectPromise=new Promise(function(b){b(a.router.registerParticipant(a))}).then(function(b){return a.afterConnected(b)})}return this.connectPromise},a.ClientParticipant.prototype.sendImpl=a.Participant.prototype.send,a.LeaderGroupParticipant=a.util.extend(a.InternalParticipant,function(b){if(a.InternalParticipant.apply(this,arguments),b.states=b.states||{},this.getStateData=b.getStateData||function(){return{}},!b.name)throw"Config must contain a name value";this.name=b.name,this.electionAddress=b.electionAddress||this.name+".election",this.priority=b.priority||a.defaultLeaderPriority||-a.util.now(),this.priorityLessThan=b.priorityLessThan||function(a,b){return b>a},this.electionTimeout=b.electionTimeout||1e3,this.leaderState="connecting",this.electionQueue=[],this.states=b.states,this.states.leader=this.states.leader||[],this.states.leader=this.states.leader.concat(["leader"]),this.states.member=this.states.member||[],this.states.member=this.states.member.concat(["member"]),this.states.election=this.states.election||[],this.states.election=this.states.election.concat(["election"]),this.states.queueing=this.states.queueing||[],this.states.queueing=this.states.queueing.concat(["connecting","election"]),this.activeStates=b.activeStates||{leader:!1,member:!1,election:!1,queueing:!0},this.changeState("connecting"),this.leader=null,this.leaderPriority=null,this.participantType="leaderGroup",this.name=b.name,this.toggleDrop=!1,this.victoryTS=-Number.MAX_VALUE,this.on("startElection",function(){this.toggleDrop=!1},this),this.on("becameLeader",function(){this.leader=this.address,this.leaderPriority=this.priority,this.electionQueue.forEach(function(a){this.forwardToTarget(a)},this),this.electionQueue=[]},this),this.on("newLeader",function(){this.electionQueue=[]},this);var c=this;a.util.addEventListener("beforeunload",function(){if(c.priority=-Number.MAX_VALUE,c.activeStates.leader)for(var a in c.router.participants){var b=c.router.participants[a];b.address&&c.events.trigger("receive",{packet:c.fixPacket({dst:"$bus.multicast",action:"disconnect",entity:{address:b.address,participantType:b.participantType,namesResource:b.namesResource}})})}c.events.trigger("unloadState"),c.startElection()}),a.metrics.gauge("transport.leaderGroup.election").set(function(){var a=c.getElectionQueue();return{queue:a?a.length:0}}),this.on("connectedToRouter",function(){this.router.registerMulticast(this,[this.electionAddress,this.name]);var b=this;a.util.setImmediate(function(){b.startElection()})},this),this.on("receive",this.routePacket,this)}),a.LeaderGroupParticipant.prototype.getElectionQueue=function(){return this.electionQueue},a.LeaderGroupParticipant.prototype.inElection=function(){return!!this.electionTimer||this.activeStates.election},a.LeaderGroupParticipant.prototype.isLeader=function(){return this.leader===this.address},a.LeaderGroupParticipant.prototype.sendElectionMessage=function(b,c,d){c=c||{};var e=c.state||{},f=c.previousLeader||this.leader,g=c.opponent||"";try{JSON.stringify(e)}catch(h){a.log.error(this.name,this.address,"failed to send state.",h),e={}}this.send({src:this.address,dst:this.electionAddress,action:b,entity:{priority:this.priority,state:e,previousLeader:f,opponent:g}},d)},a.LeaderGroupParticipant.prototype.sendVictoryMessage=function(){return this.activeStates.leader||this.activeStates.election?this.send({src:this.address,dst:this.electionAddress,action:"victory",entity:{priority:this.priority}}):!1},a.LeaderGroupParticipant.prototype.leaderQuery=function(){if(!this.inElection()){this.leaderQueryTimer=window.setTimeout(function(){a.cancelElection(),a.startElection()},this.electionTimeout);var a=this;this.sendElectionMessage("leaderQuery",{},function(b){window.clearTimeout(a.leaderQueryTimer),b.entity.priority>a.priority&&(this.leader=b.src,this.leaderPriority=b.entity.priority,this.victoryTS=b.time,a.events.trigger("newLeaderEvent"),this.stateStore={})})}},a.LeaderGroupParticipant.prototype.startElection=function(a){a=a||{};var b=a.state||{},c=a.opponent||"";if(!this.inElection()){this.events.trigger("startElection");var d=this;this.electionTimer=window.setTimeout(function(){d.cancelElection(),d.events.trigger("becameLeaderEvent")},this.electionTimeout),this.sendElectionMessage("election",{state:b,previousLeader:this.leader,opponent:c})}},a.LeaderGroupParticipant.prototype.cancelElection=function(){this.electionTimer&&(window.clearTimeout(this.electionTimer),this.electionTimer=null,this.events.trigger("endElection"))},a.LeaderGroupParticipant.prototype.routePacket=function(a){var b=a.packet;if(a.leaderState=this.leaderState,b.src!==this.address)if(b.dst===this.electionAddress){if(b.src===this.address)return;"leaderQuery"===b.action?this.handleLeaderQueryMessage(a):"election"===b.action?this.handleElectionMessage(b):"victory"===b.action&&this.handleVictoryMessage(b)}else this.forwardToTarget(a)},a.LeaderGroupParticipant.prototype.forwardToTarget=function(a){return this.activeStates.queueing?void this.electionQueue.push(a):(a.leaderState=this.leaderState,void this.events.trigger("receiveApiPacket",a))},a.LeaderGroupParticipant.prototype.handleLeaderQueryMessage=function(a){this.activeStates.leader&&a.replyTo({action:"leaderResponse",entity:{priority:this.priority}})},a.LeaderGroupParticipant.prototype.handleElectionMessage=function(a){Object.keys(a.entity.state).length>0&&(this.stateStore=a.entity.state,this.events.trigger("receivedState",a.entity.state)),a.entity.previousLeader&&a.entity.previousLeader!==this.address&&(this.previousLeader=a.entity.previousLeader),this.priorityLessThan(a.entity.priority,this.priority)&&this.victoryTS<a.time?(a.entity.priority===-Number.MAX_VALUE?(this.cancelElection(),this.activeStates.election=!1):this.inElection()||(this.electionQueue=[]),this.startElection({opponent:a.src,state:this.getStateData()})):this.activeStates.leader?this.sendElectionMessage("election",{previousLeader:this.address}):(this.cancelElection(),this.toggleDrop&&(this.toggleDrop=!1,this.events.trigger("newLeaderEvent")))},a.LeaderGroupParticipant.prototype.handleVictoryMessage=function(a){this.priorityLessThan(a.entity.priority,this.priority)?this.startElection({opponent:a.src+"USURPER"}):(this.leader=a.src,this.leaderPriority=a.entity.priority,this.victoryTS=a.time,this.cancelElection(),this.events.trigger("newLeaderEvent"),this.stateStore={})},a.LeaderGroupParticipant.prototype.heartbeatStatus=function(){var b=a.Participant.prototype.heartbeatStatus.apply(this,arguments);return b.leaderState=this.leaderState,b.leaderPriority=this.priority,b},a.LeaderGroupParticipant.prototype.changeState=function(a,b){if(a!==this.leaderState&&this._validateState(a)){for(var c in b)this[c]=b[c];return!0}return!1},a.LeaderGroupParticipant.prototype._validateState=function(b){var c={},d=!1;for(var e in this.states)a.util.arrayContainsAll(this.states[e],[b])?(c[e]=!0,d=!0):c[e]=!1;return d?(this.activeStates=c,this.leaderState=b,!0):(a.log.error(this.address,this.name,"does not have state:",b),!1)},a.MulticastParticipant=a.util.extend(a.Participant,function(b){this.address=b,this.name=b,this.participantType="multicast",a.Participant.apply(this,arguments),this.members=[],this.namesResource="/multicast/"+this.name,this.heartBeatContentType="application/vnd.ozp-iwc-multicast-address-v1+json",this.heartBeatStatus.members=[],this.on("connectedToRouter",function(){this.namesResource="/multicast/"+this.name},this),this.permissions.pushIfNotExist("ozp:iwc:address",b),this.permissions.pushIfNotExist("ozp:iwc:sendAs",b),this.permissions.pushIfNotExist("ozp:iwc:receiveAs",b)}),a.MulticastParticipant.prototype.receiveFromRouterImpl=function(a){return this.receivedPacketsMeter.mark(),this.members.forEach(function(b){a.dstParticipant=b,b.receiveFromRouter(a)}),!1},a.MulticastParticipant.prototype.addMember=function(a){this.members.push(a),this.heartBeatStatus.members.push(a.address)};var a=a||{};a.PostMessageParticipant=a.util.extend(a.Participant,function(b){a.Participant.apply(this,arguments),this.origin=this.name=b.origin,this.sourceWindow=b.sourceWindow,this.credentials=b.credentials,this.participantType="postMessageProxy",this.permissions.pushIfNotExist("ozp:iwc:origin",this.origin),this.on("connectedToRouter",function(){this.permissions.pushIfNotExist("ozp:iwc:address",this.address),this.permissions.pushIfNotExist("ozp:iwc:sendAs",this.address),this.permissions.pushIfNotExist("ozp:iwc:receiveAs",this.address)},this),this.heartBeatStatus.origin=this.origin}),a.PostMessageParticipant.prototype.receiveFromRouterImpl=function(a){this.sendToRecipient(a.packet)},a.PostMessageParticipant.prototype.sendToRecipient=function(b){a.util.safePostMessage(this.sourceWindow,b,this.origin)},a.PostMessageParticipant.prototype.handleTransportPacket=function(a){var b={ver:1,dst:this.address,src:"$transport",replyTo:a.msgId,msgId:this.generateMsgId(),entity:{address:this.address}};this.sendToRecipient(b)},a.PostMessageParticipant.prototype.forwardFromPostMessage=function(b,c){return"object"!=typeof b?void a.log.error("Unknown packet received: "+JSON.stringify(b)):c.origin!==this.origin?void a.metrics.counter("transport."+this.address+".invalidSenderOrigin").inc():(b=this.fixPacket(b),void("$transport"===b.dst?this.handleTransportPacket(b):this.router.send(b,this)))},a.PostMessageParticipantListener=function(b){b=b||{},this.participants=[],this.router=b.router||a.defaultRouter;var c=this;a.util.addEventListener("message",function(a){c.receiveFromPostMessage(a)}),a.metrics.gauge("transport.postMessageListener.participants").set(function(){return c.getParticipantCount()})},a.PostMessageParticipantListener.prototype.getParticipantCount=function(){return this.participants?this.participants.length:0},a.PostMessageParticipantListener.prototype.findParticipant=function(a){for(var b=0;b<this.participants.length;++b)if(this.participants[b].sourceWindow===a)return this.participants[b]},a.PostMessageParticipantListener.prototype.receiveFromPostMessage=function(b){var c=this.findParticipant(b.source),d=b.data;if(b.source!==window){if("string"==typeof b.data)try{d=JSON.parse(b.data)}catch(e){return}var f=function(d){a.util.isIWCPacket(d)?c.forwardFromPostMessage(d,b):a.log.log("Packet does not meet IWC Packet criteria, dropping.",d)};if(c)f(d);else{var g=this,h={subject:{"ozp:iwc:origin":b.origin},action:{"ozp:iwc:action":"connect"},policies:a.authorization.policySets.connectSet};a.authorization.isPermitted(h).success(function(){c=new a.PostMessageParticipant({origin:b.origin,sourceWindow:b.source,credentials:d.entity}),g.router.registerParticipant(c,d),g.participants.push(c),f(d)}).failure(function(a){console.error("Failed to connect. Could not authorize:",a)})}}},a.RouterWatchdog=a.util.extend(a.InternalParticipant,function(b){a.InternalParticipant.apply(this,arguments),this.participantType="routerWatchdog",this.on("connected",function(){this.name=this.router.selfId},this),this.heartbeatFrequency=b.heartbeatFrequency||1e4,this.on("connectedToRouter",this.setupWatches,this)}),a.RouterWatchdog.prototype.leaveEventChannel=function(){return this.router?(this.send({dst:"$bus.multicast",action:"disconnect",entity:{address:this.address,participantType:this.participantType,namesResource:this.namesResource}}),this.send({dst:"$bus.multicast",action:"disconnect",entity:{address:this.router.selfId,namesResource:"/router/"+this.router.selfId}}),!0):!1},a.RouterWatchdog.prototype.setupWatches=function(){this.name=this.router.selfId;var b=this,c=function(){b.send({dst:"names.api",action:"set",resource:"/router/"+b.router.selfId,contentType:"application/vnd.ozp-iwc-router-v1+json",entity:{address:b.router.selfId,participants:b.router.getParticipantCount(),time:a.util.now()}});for(var c in b.router.participants){var d=b.router.participants[c];d.heartBeatStatus.time=a.util.now(),d instanceof a.MulticastParticipant?d.members.forEach(function(a){b.send({dst:"names.api",resource:d.namesResource+"/"+a.address,action:"set",entity:a.heartBeatStatus,contentType:d.heartBeatContentType})}):d.heartbeat()}};this.timer=window.setInterval(c,this.heartbeatFrequency)},a.RouterWatchdog.prototype.shutdown=function(){window.clearInterval(this.timer)},a.CommonApiValue=function(b){b=b||{},this.watchers=b.watchers||[],this.resource=b.resource,this.allowedContentTypes=b.allowedContentTypes,this.entity=b.entity,this.contentType=b.contentType,this.permissions=new a.policyAuth.SecurityAttribute;for(var c in b.permissions)this.permissions.pushIfNotExist(c,b.permissions[c]);this.version=b.version||0,this.persist=!1,this.deleted=!0},a.CommonApiValue.prototype.set=function(a){if(this.isValidContentType(a.contentType)){if(!Array.isArray(a.permissions))for(var b in a.permissions)this.permissions.clear(b),this.permissions.pushIfNotExist(b,a.permissions[b]);this.contentType=a.contentType,this.entity=a.entity,this.version++}},a.CommonApiValue.prototype.watch=function(a){this.watchers.push({src:a.src,msgId:a.msgId})},a.CommonApiValue.prototype.unwatch=function(a){this.watchers=this.watchers.filter(function(b){return a.replyTo!==b.msgId&&a.src!==b.src})},a.CommonApiValue.prototype.eachWatcher=function(a,b){return b=b||this,this.watchers.map(a,b)},a.CommonApiValue.prototype.deleteData=function(){this.entity=void 0,this.contentType=void 0,this.permissions.clearAll(),this.version=0,this.deleted=!0},a.CommonApiValue.prototype.toPacket=function(b){return b=b||{},b.entity=a.util.clone(this.entity),b.contentType=this.contentType,b.permissions=a.util.clone(this.permissions.getAll()),b.eTag=this.version,b.resource=this.resource,b},a.CommonApiValue.prototype.isValidContentType=function(b){if(this.allowedContentTypes&&this.allowedContentTypes.indexOf(b)<0)throw new a.ApiError("badContent","Bad contentType "+b+", expected "+this.allowedContentTypes.join(","));return!0},a.CommonApiValue.prototype.snapshot=function(){return this.toPacket()},a.CommonApiValue.prototype.changesSince=function(b){return b.eTag===this.version?null:{newValue:a.util.clone(this.entity),oldValue:b.entity}},a.CommonApiValue.prototype.isUpdateNeeded=function(){return!1},a.CommonApiValue.prototype.updateContent=function(){return null},a.CommonApiValue.prototype.deserialize=function(b){var c=a.util.clone(b);this.entity=c.entity||{},this.contentType=c.contentType||this.contentType;for(var d in c.permissions)this.permissions.pushIfNotExist(d,c.permissions[d]);this.version=c.version||this.version,this.watchers=b.watchers||this.watchers},a.CommonApiValue.prototype.serialize=function(){var a={};return a.entity=this.entity,a.contentType=this.contentType,a.permissions=this.permissions.getAll(),a.version=this.version,a.watchers=this.watchers,a
},a.CommonApiCollectionValue=a.util.extend(a.CommonApiValue,function(b){a.CommonApiValue.apply(this,arguments),this.persist=!1,this.pattern=b.pattern||"",this.pattern.toJSON=RegExp.prototype.toString,this.entity=[]}),a.CommonApiCollectionValue.prototype.isUpdateNeeded=function(a){return a.resource.match(this.pattern)},a.CommonApiCollectionValue.prototype.updateContent=function(a){this.version++,this.entity=a.map(function(a){return a.resource})},a.CommonApiCollectionValue.prototype.set=function(){throw new a.ApiError("noPermission","This resource cannot be modified.")},a.CommonApiCollectionValue.prototype.deserialize=function(b){a.CommonApiValue.prototype.deserialize.apply(this,arguments);var c=a.util.clone(b);this.pattern="string"==typeof c.pattern?new RegExp(c.pattern.replace(/^\/|\/$/g,"")):this.pattern,this.pattern.toJSON=RegExp.prototype.toString},a.CommonApiCollectionValue.prototype.serialize=function(){var a={};return a.entity=this.entity,a.pattern=this.pattern,a.contentType=this.contentType,a.permissions=this.permissions.getAll(),a.version=this.version,a.watchers=this.watchers,a},a.ApiError=a.util.extend(Error,function(a,b){Error.call(this,b),this.name="ApiError",this.errorAction=a,this.message=b}),a.ApiError.prototype.toString=function(){return this.name+":"+JSON.stringify(this.message)},a.ApiError.subclass=function(b){return a.util.extend(a.ApiError,function(c){a.ApiError.call(this,b,c),this.name=b+"Error"})},a.BadActionError=a.ApiError.subclass("badAction"),a.BadResourceError=a.ApiError.subclass("badResource"),a.BadRequestError=a.ApiError.subclass("badRequest"),a.BadContentError=a.ApiError.subclass("badContent"),a.BadStateError=a.ApiError.subclass("badState"),a.NoActionError=a.ApiError.subclass("noAction"),a.NoResourceError=a.ApiError.subclass("noResource"),a.NoMatchError=a.ApiError.subclass("noMatch"),a.NoPermissionError=a.ApiError.subclass("noPermission"),a.CommonApiBase=function(b){b=b||{},this.participant=b.participant,this.participant.on("receiveApiPacket",this.routePacket,this),this.participant.on("becameLeaderEvent",this.becameLeader,this),this.participant.on("newLeaderEvent",this.newLeader,this),this.participant.on("startElection",this.startElection,this),this.participant.on("receiveEventChannelPacket",this.routeEventChannel,this),this.participant.on("receivedState",this.receiveState,this),this.events=new a.Event,this.events.mixinOnOff(this),this.dynamicNodes=[],this.data={},this.expectedBranches=1,this.retrievedBranches=0,this.endpointUrls=[],this.electionQueue=[]},a.CommonApiBase.prototype.receiveState=function(a){a=a||this.participant.stateStore,this.setState(a)},a.CommonApiBase.prototype.findNodeForServerResource=function(b,c,d){var e="/";switch(d.name){case a.linkRelPrefix+":intent":b.type&&(e+=b.type,b.action&&(e+="/"+b.action,b.handler&&(e+="/"+b.handler)));break;case a.linkRelPrefix+":application":b.id&&(e+="application/"+b.id);break;case a.linkRelPrefix+":system":e+="system";break;case a.linkRelPrefix+":user":e+="user";break;case a.linkRelPrefix+":user-data":b.key&&(e+=b.key);break;default:e+="FIXME_UNKNOWN_ENDPOINT_"+d.name}return"/"===e?null:this.findOrMakeValue({resource:e,entity:{},contentType:b.contentType,children:b.children})},a.CommonApiBase.prototype.loadFromServer=function(){return new Promise(function(a){a()})},a.CommonApiBase.prototype.loadFromEndpoint=function(b,c){this.expectedBranches=1,this.retrievedBranches=0;var d,e,f=a.endpoint(b),g=new Promise(function(a,b){d=a,e=b}),h=this;return f.get("/").then(function(a){var b=a.response,e=a.header;h.loadLinkedObjectsFromServer(f,b,d,c,e),h.updateResourceFromServer(b,b._links.self.href,f,d,e),h.dynamicNodes.forEach(function(a){h.updateDynamicNode(h.data[a])})})["catch"](function(c){a.log.error("Could not load from api ("+b+"): "+c.message,c),e("Could not load from api ("+b+"): "+c.message+c)}),g},a.CommonApiBase.prototype.loadFromEndpointIterative=function(b,c){var d=a.endpoint(b),e=this;return d.get("/").then(function(b){var f={},g=[];if(b.response._embedded&&b.response._embedded.item){var h=a.util.ensureArray(b.response._embedded.item);for(var i in h)h[i]._links&&h[i]._links.self&&h[i]._links.self.href?f[h[i]._links.self.href]=h[i]:a.log.info("Unable to load embedded item "+JSON.stringify(h[i]));for(var j in f)e.updateResourceFromServerIterative(f[j],j,d,c)}if(b.response._links&&b.response._links.item){var k=a.util.ensureArray(b.response._links.item);k.forEach(function(b){void 0===f[b.href]&&g.push(d.get(b.href,c).then(function(c){return c&&c.header&&c.response?c:(a.log.info("Unable to load link item "+b.href),null)}))})}return Promise.all(g)}).then(function(a){a.forEach(function(a){if(null!==a){var b=a.header,c=a.response;e.updateResourceFromServerIterative(c,c._links.self.href,d,b)}}),e.dynamicNodes.forEach(function(a){e.updateDynamicNode(e.data[a])})})},a.CommonApiBase.prototype.updateResourceFromServerIterative=function(b,c,d,e){var f=e||{};b.contentType=b.contentType||f["Content-Type"]||"application/json";var g;if("string"==typeof b.entity)try{g=JSON.parse(b.entity),b.entity=g}catch(h){}var i=this.findNodeForServerResource(b,c,d);if(i){var j=i.snapshot(),k=a.util.clone(b);delete k._links,delete k._embedded,i.deserialize(this.formatServerData(k)),this.notifyWatchers(i,i.changesSince(j))}},a.CommonApiBase.prototype.updateResourceFromServer=function(b,c,d,e,f){var g=f||{};b.contentType=b.contentType||g["Content-Type"]||"application/json";var h;if("string"==typeof b.entity)try{h=JSON.parse(b.entity),b.entity=h}catch(i){}var j=this.findNodeForServerResource(b,c,d);if(j){var k=j.snapshot(),l=a.util.clone(b);delete l._links,delete l._embedded,j.deserialize(this.formatServerData(l)),this.notifyWatchers(j,j.changesSince(k)),this.loadLinkedObjectsFromServer(d,b,e)}},a.CommonApiBase.prototype.formatServerData=function(a){return{entity:a}},a.CommonApiBase.prototype.loadLinkedObjectsFromServer=function(b,c,d,e){if(c){var f=this,g=!0,h=!0,i=0,j=0;if(c._embedded&&c._embedded.item&&(c._embedded.item=a.util.ensureArray(c._embedded.item),g=!1,j=Array.isArray(c._embedded.item)?c._embedded.item.length:1,i+=j),c._links&&c._links.item&&(c._links.item=a.util.ensureArray(c._links.item),h=!1,j=Array.isArray(c._links.item)?c._links.item.length:1,i+=j),g&&h)this.retrievedBranches++,this.retrievedBranches>=this.expectedBranches&&d("RESOLVING");else{if(this.expectedBranches+=i-1,c._embedded&&c._embedded.item){var k={};if(Array.isArray(c._embedded.item))for(var l in c._embedded.item)k=c._embedded.item[l],this.updateResourceFromServer(k,k._links.self.href,b,d);else k=c._embedded.item,this.updateResourceFromServer(k,k._links.self.href,b,d)}if(c._links&&c._links.item)if(Array.isArray(c._links.item))c._links.item.forEach(function(c){var g=c.href;b.get(g,e).then(function(a){var c=a.response,e=a.header;f.updateResourceFromServer(c,g,b,d,e)})["catch"](function(b){a.log.info("unable to load "+c.href+" because: ",b)})});else{var m=c._links.item.href;b.get(m,e).then(function(a){var c=a.response,e=a.header;f.updateResourceFromServer(c,m,b,d,e)})["catch"](function(b){a.log.info("unable to load "+k.href+" because: ",b)})}}}},a.CommonApiBase.prototype.makeValue=function(){throw new Error("Subclasses of CommonApiBase must implement the makeValue(packet) function.")},a.CommonApiBase.prototype.isPermitted=function(b,c){var d=new a.AsyncAction;return a.authorization.formatCategory(b.packet.permissions).success(function(b){var e={subject:c.permissions.getAll(),resource:b||{},action:{"ozp:iwc:action":"access"},policies:a.authorization.policySets.apiSet};a.authorization.isPermitted(e,c).success(function(a){d.resolve("success",a)}).failure(function(a){console.error("Api could not perform action:",a),d.resolve("failure",a)})}).failure(function(a){console.error("Api could not format permission check on packet",a),d.resolve("failure",a)}),d},a.CommonApiBase.prototype.notifyWatchers=function(a,b){this.participant.activeStates.leader&&b&&(this.events.trigger("changedNode",a,b),a.eachWatcher(function(c){var d={dst:c.src,src:this.participant.name,replyTo:c.msgId,response:"changed",resource:a.resource,permissions:a.permissions.getAll(),entity:b};this.participant.send(d)},this))},a.CommonApiBase.prototype.findOrMakeValue=function(b){if(null===b.resource||void 0===b.resource)return new a.CommonApiValue;var c=this.data[b.resource];return c||(c=this.data[b.resource]=this.makeValue(b)),c},a.CommonApiBase.prototype.hasKey=function(a){return a in this.data},a.CommonApiBase.prototype.createKey=function(b){b=b||"";var c;do c=b+a.util.generateId();while(this.hasKey(c));return c},a.CommonApiBase.prototype.isLeader=function(){return this.participant.activeStates.leader},a.CommonApiBase.prototype.isElecting=function(){return this.participant.activeStates.election},a.CommonApiBase.prototype.routePacket=function(b){var c=b.packet;this.events.trigger("receive",b);var d=this,e=function(c){try{c.apply(d)}catch(e){e.errorAction||a.log.error("Unexpected error:",e),d.isLeader()&&b.replyTo({response:e.errorAction||"unknownError",entity:e.message})}};if(!c.response||c.action){var f;e(function(){var a=this.findHandler(b);this.validateResource(f,b),f=this.findOrMakeValue(b.packet),this.isPermitted(b,f).success(function(){e(function(){this.validatePreconditions(f,b);var c=f.snapshot();a.call(this,f,b),this.notifyWatchers(f,f.changesSince(c)),this.dynamicNodes.forEach(function(a){this.updateDynamicNode(this.data[a])},this)})},this).failure(function(){b.replyTo({response:"noPerm"}),console.log("failure")})})}},a.CommonApiBase.prototype.routeEventChannel=function(b){var c=b.packet;switch(c.action){case"connect":this.handleEventChannelConnect(b);break;case"disconnect":this.handleEventChannelDisconnect(b);break;default:a.log.error(this.participant.name,"No handler found for corresponding event channel action: ",c.action)}},a.CommonApiBase.prototype.handleEventChannelDisconnect=function(a){for(var b in this.data)for(var c in this.data[b].watchers)this.data[b].watchers[c].src===a.packet.entity.address&&this.data[b].watchers.splice(c,1);this.handleEventChannelDisconnectImpl(a)},a.CommonApiBase.prototype.handleEventChannelConnect=function(a){this.handleEventChannelConnectImpl(a)},a.CommonApiBase.prototype.handleEventChannelDisconnectImpl=function(){},a.CommonApiBase.prototype.handleEventChannelConnectImpl=function(){},a.CommonApiBase.prototype.findHandler=function(a){var b,c=a.packet.action,d=a.packet.resource;return b=null===d||void 0===d?"rootHandle":"handle",c?b+=c.charAt(0).toUpperCase()+c.slice(1).toLowerCase():b="defaultHandler",b&&"function"==typeof this[b]||(b="defaultHandler"),this[b]},a.CommonApiBase.prototype.validateResource=function(){return!0},a.CommonApiBase.prototype.validatePreconditions=function(b,c){if(c.packet.ifTag&&c.packet.ifTag!==b.version)throw new a.ApiError("noMatch","Latest version is "+b.version)},a.CommonApiBase.prototype.validateContentType=function(){return!0},a.CommonApiBase.prototype.updateDynamicNode=function(a){if(a){var b=[];for(var c in this.data)a.isUpdateNeeded(this.data[c])&&b.push(this.data[c]);if(b){var d=a.snapshot();a.updateContent(b),this.notifyWatchers(a,a.changesSince(d))}}},a.CommonApiBase.prototype.addDynamicNode=function(a){this.data[a.resource]=a,this.dynamicNodes.push(a.resource),this.updateDynamicNode(a)},a.CommonApiBase.prototype.defaultHandler=function(a,b){b.replyTo({response:"badAction",entity:{action:b.packet.action,originalRequest:b.packet}})},a.CommonApiBase.prototype.handleGet=function(a,b){this.isLeader()&&b.replyTo(a.toPacket({response:"ok"}))},a.CommonApiBase.prototype.handleBulkget=function(a,b){if(this.isLeader()){var c=[];if(this.data!=={})for(var d in this.data)0===this.data[d].resource.indexOf(b.packet.resource)&&c.push(this.data[d].toPacket());b.replyTo({response:"ok",entity:c})}},a.CommonApiBase.prototype.handleSet=function(a,b){a.set(b.packet),this.isLeader()&&b.replyTo({response:"ok"})},a.CommonApiBase.prototype.handleDelete=function(a,b){a.deleteData(),this.isLeader()&&b.replyTo({response:"ok"})},a.CommonApiBase.prototype.handleWatch=function(a,b){a.watch(b.packet),this.isLeader()&&b.replyTo({response:"ok"})},a.CommonApiBase.prototype.handleUnwatch=function(a,b){a.unwatch(b.packet),this.isLeader()&&b.replyTo({response:"ok"})},a.CommonApiBase.prototype.unloadState=function(){if(this.isLeader()){var a={};for(var b in this.data)a[b]=this.data[b].serialize();this.participant.sendElectionMessage("election",{state:{data:a,dynamicNodes:this.dynamicNodes},previousLeader:this.participant.address}),this.data={}}else this.participant.sendElectionMessage("election")},a.CommonApiBase.prototype.setState=function(b){this.data={},this.dynamicNodes=b.dynamicNodes||[];for(var c in b.data){var d,e=this.dynamicNodes.indexOf(c);e>-1?(d=this.data[c]=new a.CommonApiCollectionValue({resource:c}),d.deserialize(b.data[c]),this.updateDynamicNode(d)):(d=this.findOrMakeValue({resource:c,contentType:b.data[c].contentType}),d.deserialize(b.data[c]))}this.dynamicNodes.forEach(function(a){this.updateDynamicNode(this.data[a])},this)},a.CommonApiBase.prototype.rootHandleList=function(a,b){this.isLeader()&&b.replyTo({response:"ok",entity:Object.keys(this.data)})},a.CommonApiBase.prototype.startElection=function(){this.isLeader()?this.participant.changeState("actingLeader"):"leaderSync"===this.participant.leaderState||this.participant.changeState("election")},a.CommonApiBase.prototype.becameLeader=function(){this.participant.sendElectionMessage("victory"),"actingLeader"===this.participant.leaderState||"leader"===this.participant.leaderState?this.setToLeader():"election"===this.participant.leaderState&&this.leaderSync()},a.CommonApiBase.prototype.newLeader=function(){"actingLeader"===this.participant.leaderState&&this.participant.sendElectionMessage("election",{previousLeader:this.participant.address,state:this.data}),this.electionQueue=[],this.participant.changeState("member"),this.participant.events.trigger("newLeader")},a.CommonApiBase.prototype.setToLeader=function(){var b=this;a.util.setImmediate(function(){b.participant.changeState("leader"),b.participant.events.trigger("becameLeader"),b.electionQueue.forEach(function(a){b.participant.send(a)},this),b.electionQueue=[]})},a.CommonApiBase.prototype.leaderSync=function(){this.participant.changeState("leaderSync",{toggleDrop:!0});var b=this;a.util.setImmediate(function(){"leaderSync"===b.participant.leaderState&&(b.participant.stateStore&&Object.keys(b.participant.stateStore).length>0?(b.setState(b.participant.stateStore),b.participant.stateStore={},b.setToLeader()):b.participant.previousLeader?(b.receiveStateTimer=null,b.receiveStateTimer=window.setTimeout(function(){b.participant.stateStore&&Object.keys(b.participant.stateStore).length>0?b.receiveState(b.participant.stateStore):(b.loadFromServer(),a.log.debug(b.participant.name,"New leader(",b.participant.address,") failed to retrieve state from previous leader(",b.participant.previousLeader,"), so is loading data from server.")),b.setToLeader()},250)):(a.log.debug(b.participant.name,"New leader(",b.participant.address,") is loading data from server."),b.loadFromServer().then(function(){b.setToLeader()},function(c){a.log.debug(b.participant.name,"New leader(",b.participant.address,") could not load data from server. Error:",c),b.setToLeader()})))})},a.CommonApiBase.prototype.persistNodes=function(){throw new a.ApiError("noImplementation","Base class persistence call not implemented.  Use DataApi to persist nodes.")},a.Endpoint=function(a){this.endpointRegistry=a},a.Endpoint.prototype.get=function(b,c){var d=this;return b=b||"",this.endpointRegistry.loadPromise.then(function(){if(!d.endpointRegistry.loaded)throw Error("Endpoint "+d.endpointRegistry.apiRoot+" could not be reached. Skipping GET of "+b);return("/"===b||""===b)&&(b=d.baseUrl),a.util.ajax({href:b,method:"GET",headers:c})})},a.Endpoint.prototype.put=function(b,c,d){var e=this;return this.endpointRegistry.loadPromise.then(function(){return 0!==b.indexOf(e.baseUrl)&&(b=e.baseUrl+b),a.util.ajax({href:b,method:"PUT",data:c,headers:d})})},a.Endpoint.prototype["delete"]=function(b,c,d){var e=this;return this.endpointRegistry.loadPromise.then(function(){if(!e.baseUrl)throw Error("The server did not define a relation of type "+this.name+" for retrivieving "+b);return 0!==b.indexOf(e.baseUrl)&&(b=e.baseUrl+b),a.util.ajax({href:b,method:"DELETE",headers:d})})},a.Endpoint.prototype.saveNodes=function(a){var b="/data";for(var c in a){var d=JSON.stringify(a[c]);this.put(a[c].self||b,d)}},a.EndpointRegistry=function(b){b=b||{};var c=b.apiRoot||"/api";this.apiRoot=c,this.endPoints={},this.template={};var d=this;this.loadPromise=a.util.ajax({href:c,method:"GET"}).then(function(a){d.loaded=!0;var b=a.response||{};b._links=b._links||{},b._embedded=b._embedded||{};for(var c in b._links)if("self"!==c){var e=b._links[c];Array.isArray(b._links[c])&&(e=b._links[c][0].href),e.templated?d.template[c]=e.href:d.endpoint(c).baseUrl=e.href}for(var f in b._embedded){var g=b._embedded[f]._links.self.href;d.endpoint(f).baseUrl=g}d.template["ozp:data-item"]||(d.template["ozp:data-item"]=d.endpoint("ozp:user-data").baseUrl+"/{+resource}")})["catch"](function(b){a.log.debug(Error("Endpoint "+d.apiRoot+" "+b.statusText+". Status: "+b.status)),d.loaded=!1})},a.EndpointRegistry.prototype.endpoint=function(b){var c=this.endPoints[b];return c||(c=this.endPoints[b]=new a.Endpoint(this),c.name=b),c},a.initEndpoints=function(b){var c=new a.EndpointRegistry({apiRoot:b});a.endpoint=function(a){return c.endpoint(a)},a.uriTemplate=function(a){return c.template[a]}},a.LocksApi=a.util.extend(a.CommonApiBase,function(){a.CommonApiBase.apply(this,arguments)}),a.LocksApi.prototype.validateResource=function(b,c){if(c.packet.resource&&!c.packet.resource.match(/^\/mutex/))throw new a.ApiError("badResource","Invalid resource for locks.api: "+c.packet.resource)},a.LocksApi.prototype.makeValue=function(b){return new a.LocksApiValue({resource:b.resource})},a.LocksApi.prototype.updateLock=function(a,b){if(b){console.log("[locks.api] Unlocking a new lock owner on "+a.resource+": ",b);var c={dst:b.src,src:this.participant.name,replyTo:b.msgId,response:"ok",resource:a.resource};this.isLeader()?this.participant.send(c):this.isElecting()&&this.electionQueue.push(c)}},a.LocksApi.prototype.handleLock=function(a,b){this.updateLock(a,a.lock({src:b.packet.src,msgId:b.packet.msgId}))},a.LocksApi.prototype.handleUnlock=function(a,b){this.updateLock(a,a.unlock({src:b.packet.src,msgId:b.packet.msgId}))},a.LocksApi.prototype.handleEventChannelDisconnectImpl=function(a){for(var b in this.data){var c=this.data[b];this.updateLock(c,c.unlock({src:a.packet.entity.address}))}},a.LocksApi.prototype.handleSet=function(a,b){this.isLeader()&&b.replyTo({response:"badAction",entity:{action:b.packet.action,originalRequest:b.packet}})},a.LocksApi.prototype.handleDelete=function(a,b){this.isLeader()&&b.replyTo({response:"badAction",entity:{action:b.packet.action,originalRequest:b.packet}})},a.LocksApiValue=a.util.extend(a.CommonApiValue,function(){a.CommonApiValue.apply(this,arguments),this.entity={owner:null,queue:[]}}),a.LocksApiValue.prototype.lock=function(b){return this.entity.queue.push(b),this.entity.owner=this.entity.owner||{},a.util.objectContainsAll(this.entity.owner,this.entity.queue[0])?null:(this.entity.owner=this.entity.queue[0],this.entity.owner)},a.LocksApiValue.prototype.unlock=function(b){return this.entity.queue=this.entity.queue.filter(function(c){return!a.util.objectContainsAll(c,b)}),a.util.objectContainsAll(this.entity.owner,this.entity.queue[0])?null:(this.entity.owner=this.entity.queue[0],this.entity.owner)},a.apiFilter={createResource:function(a){return a?function(b,c,d,e){return c.node||(c.node=this.data[b.resource]=new a({resource:b.resource,pattern:b.pattern,src:b.src})),e()}:function(a,b,c,d){return b.node||(b.node=this.createNode({resource:a.resource,pattern:a.pattern,src:a.src})),d()}},markAsCollector:function(){return function(a,b,c,d){return this.addCollector(b.node),d()}},requireResource:function(){return function(b,c,d,e){if(!c.node||c.node.deleted)throw new a.NoResourceError(b);return e()}},checkAuthorization:function(a){return function(b,c,d,e){return this.checkAuthorization(c.node,c,b,a||b.action),e()}},nullFilter:function(a,b,c,d){return d()},checkContentType:function(b){return b?(b=a.util.ensureArray(b),function(c,d,e,f){if(!b.some(function(a){return a===c.contentType||"[object RegExp]"===Object.prototype.toString.call(b)&&a.test(c.contentType)}))throw new a.BadContentError({provided:c.contentType,allowedTypes:b});return f()}):a.apiFilter.nullFilter},markResourceAsChanged:function(){return function(a,b,c,d){return this.markForChange(a),d()}},fixPattern:function(){return function(a,b,c,d){var e;return b.node&&(e=b.node.pattern),a.resource&&(a.pattern=a.pattern||e||a.resource+"/"),d()}},checkVersion:function(){return function(b,c,d,e){if(b.ifTag&&b.ifTag!==c.node.version)throw new a.NoMatchError({expectedVersion:b.ifTag,actualVersion:c.node.version});return e()}}},a.standardApiFilters={forAction:function(b){return a.standardApiFilters[b+"Filters"]},setFilters:function(b,c){return[a.apiFilter.createResource(b),a.apiFilter.checkAuthorization(),a.apiFilter.checkContentType(c),a.apiFilter.checkVersion(),a.apiFilter.markResourceAsChanged()]},deleteFilters:function(){return[a.apiFilter.checkAuthorization(),a.apiFilter.checkVersion(),a.apiFilter.markResourceAsChanged()]},getFilters:function(){return[a.apiFilter.requireResource(),a.apiFilter.checkAuthorization()]},createAndCollectFilters:function(b,c){return[a.apiFilter.fixPattern(),a.apiFilter.createResource(b),a.apiFilter.checkAuthorization(),a.apiFilter.checkContentType(c),a.apiFilter.checkVersion()]}},a.ApiNode=function(b){if(b=b||{},this.resource=b.resource,this.allowedContentTypes=b.allowedContentTypes,this.entity=b.entity,this.contentType=b.contentType,b.uriTemplate&&(this.uriTemplate=b.uriTemplate),this.permissions={},this.version=b.version||1,this.lifespan=new a.Lifespan.Ephemeral,this.deleted=!1,this.pattern=b.pattern,this.collection=[],this.self=b.self,b.serializedEntity&&this.deserializedEntity(b.serializedEntity,b.serializedContentType),!this.resource)throw new Error("ApiNode requires a resource")},a.ApiNode.prototype.getSelfUri=function(){if(this.self)return this.self;if(this.uriTemplate&&a.uriTemplate){var b=a.uriTemplate(this.uriTemplate);b&&(this.self=a.util.resolveUriTemplate(b,this))}return this.self},a.ApiNode.prototype.serializeLive=function(){return this.toPacket({deleted:this.deleted,pattern:this.pattern,collection:this.collection,lifespan:this.lifespan,allowedContentTypes:this.allowedContentTypes,_links:{self:{href:this.self}}})},a.ApiNode.prototype.deserializeLive=function(a,b){a.contentType=a.contentType||b,this.set(a),a._links&&a._links.self&&(this.self=a._links.self.href),this.resource||(this.resource=a.resource||this.resourceFallback(a)),this.deleted=a.deleted,this.lifespan=a.lifespan,this.allowedContentTypes=a.allowedContentTypes,this.pattern=a.pattern,this.collection=a.collection},a.ApiNode.prototype.deserializeResourceFromContentType=function(b){b._links&&b._links.self&&(this.resource=b._links.self.href.replace(a.apiRootUrl,""))},a.ApiNode.prototype.serializedEntity=function(){return JSON.stringify(this.entity)},a.ApiNode.prototype.serializedContentType=function(){return this.contentType},a.ApiNode.prototype.deserializedEntity=function(a,b){if("string"==typeof a&&(a=JSON.parse(a)),this.entity=a,this.contentType=b,this.entity&&this.entity._links){var c=this.entity._links;!this.self&&c.self&&(this.self=c.self.href),this.resource||(this.resource=c["ozp:iwcSelf"]?c["ozp:iwcSelf"].href.replace(/web\+ozp:\/\/[^/]+/,""):this.resourceFallback(a))}},a.ApiNode.prototype.resourceFallback=function(){},a.ApiNode.prototype.toPacket=function(b){return b=b||{},b.entity=a.util.clone(this.entity),b.lifespan=this.lifespan,b.contentType=this.contentType,b.permissions=this.permissions,b.eTag=this.version,b.resource=this.resource,b.pattern=this.pattern,b.collection=this.collection,b},a.ApiNode.prototype.set=function(b){if(!Array.isArray(b.permissions))for(var c in b.permissions)this.permissions.clear(c),this.permissions.pushIfNotExist(c,b.permissions[c]);this.lifespan=a.Lifespan.getLifespan(b.lifespan)||this.lifespan,this.contentType=b.contentType,this.entity=b.entity,this.pattern=b.pattern||this.pattern,this.deleted=!1,b.eTag?this.version=b.eTag:this.version++},a.ApiNode.prototype.markAsDeleted=function(){this.version++,this.deleted=!0,this.entity=null,this.pattern=null,this.collection=null},a.ApiNode.prototype.addWatch=function(a){this.watchers.push(a)},a.ApiNode.prototype.removeWatch=function(a){this.watchers=this.watchers.filter(a)},a.ApiNode.prototype.snapshot=function(){return this.toPacket()},a.ApiNode.prototype.changesSince=function(a){return a.eTag===this.version?null:{newValue:this.toPacket(),oldValue:a}},a.DataNode=a.util.extend(a.ApiNode,function(){a.ApiNode.apply(this,arguments),this.lifespan=new a.Lifespan.Persistent}),a.DataNode.prototype.uriTemplate="ozp:data-item",a.DataNode.prototype.serializedEntity=function(){return JSON.stringify({key:this.resource,entity:this.entity,collection:this.collection,pattern:this.pattern,contentType:this.contentType,permissions:this.permissions,version:this.version,_links:{self:{href:this.self}}})},a.DataNode.prototype.serializedContentType=function(){return"application/vnd.ozp-iwc-data-object+json"},a.DataNode.prototype.deserializedEntity=function(a){var b;b="string"==typeof a.entity?JSON.parse(a.entity):a.entity,this.entity=b.entity,this.collection=b.collection,this.pattern=b.pattern,this.contentType=b.contentType,this.permissions=b.permissions,this.version=b.version,b._links=b._links||{},b._links.self&&(this.self=b._links.self.href),this.resource||(this.resource=b._links["ozp:iwcSelf"]?b._links["ozp:iwcSelf"].href.replace(/web\+ozp:\/\/[^/]+/,""):this.resourceFallback(b))},a.DataNode.prototype.resourceFallback=function(a){return a.key?("/"===a.key.charAt(0)?"":"/")+a.key:void 0},a.IntentsInFlightNode=a.util.extend(a.ApiNode,function(b){if(b=b||{},a.ApiNode.apply(this,arguments),this.lifespan=new a.Lifespan.Bound({addresses:[b.src]}),!b.invokePacket)throw new a.BadContentError("In flight intent requires an invocation packet");if(!Array.isArray(b.handlerChoices)||b.handlerChoices<1)throw new a.BadContentError("No handlers available");this.entity={intent:{type:b.type,action:b.action},invokePacket:b.invokePacket,contentType:b.invokePacket.contentType,entity:b.invokePacket.entity,state:"choosing",status:"ok",handlerChoices:b.handlerChoices,handlerChosen:{resource:null,reason:null},handler:{resource:null,address:null},reply:null},1===b.handlerChoices.length&&(this.entity.handlerChosen.resource=b.handlerChoices[0].resource,this.entity.handlerChosen.reason="onlyOne",this.entity.state="delivering")}),a.IntentsInFlightNode.prototype.setError=function(a){this.entity.reply=a.error,this.entity.state="error",this.version++},a.IntentsInFlightNode.prototype.setHandlerResource=function(b){if(!b.handlerChosen||!b.handlerChosen.resource||!b.handlerChosen.reason)throw new a.BadStateError("Choosing state requires a resource and reason");this.entity.handlerChosen=b.handlerChosen,this.entity.state="delivering",this.version++},a.IntentsInFlightNode.prototype.setHandlerParticipant=function(b){if(!b.handler||!b.handler.address)throw new a.BadContentError("Entity lacks a 'handler.address' field");this.entity.handler=b.handler,this.entity.state="running",this.version++},a.IntentsInFlightNode.prototype.setComplete=function(a){this.entity.reply=a.reply,this.entity.state="complete",this.version++},a.IntentsInFlightNode.stateTransitions={choosing:{error:a.IntentsInFlightNode.prototype.setError,delivering:a.IntentsInFlightNode.prototype.setHandlerResource,complete:a.IntentsInFlightNode.prototype.setComplete},delivering:{error:a.IntentsInFlightNode.prototype.setError,running:a.IntentsInFlightNode.prototype.setHandlerParticipant,complete:a.IntentsInFlightNode.prototype.setComplete},running:{error:a.IntentsInFlightNode.prototype.setError,complete:a.IntentsInFlightNode.prototype.setComplete},complete:{},error:{}},a.IntentsInFlightNode.prototype.set=function(b){if(!b.entity||!b.entity.state)throw new a.BadContentError("Entity lacks a 'state' field");if(this.deleted)throw new a.BadContentError("Already handled.");var c=a.IntentsInFlightNode.stateTransitions[this.entity.state];if(!c)return void this.setError("Inflight intent is in an invalid state.  Cannot proceed.");if(c=c[b.entity.state],!c)throw new a.BadStateError("In-flight intent cannot transition from "+this.entity.state+" to"+b.entity.state);c.call(this,b.entity)},a.IntentHandlerNode=a.util.extend(a.ApiNode,function(b){a.ApiNode.apply(this,arguments),this.lifespan=new a.Lifespan.Bound({addresses:[b.src]}),this.entity=b.entity||{}}),a.IntentHandlerNode.prototype.set=function(b){var c=b.src;if(b.entity&&b.entity.invokeIntent&&b.entity.invokeIntent.dst&&(c=b.entity.invokeIntent.dst),!c)throw a.log.error("Handler lacks a invokeIntent.dst",b),new a.BadContentError("Intent handler must supply invokeIntent.dst");a.ApiNode.prototype.set.apply(this,arguments),this.entity.invokeIntent=this.entity.invokeIntent||{},this.entity.invokeIntent.dst=c,this.entity.replyTo=b.msgId},a.IntentHandlerNode.prototype.resourceFallback=function(a){switch(this.contentType){case"application/vnd.ozp-intents-v1+json":return"/"+a.intent.type+"/"+a.intent.action}},a.Lifespan=a.Lifespan||{},a.Lifespan.getLifespan=function(a){if(a){if("string"==typeof a){var b=a;a={type:b}}if(a.type)return a.type=a.type.charAt(0).toUpperCase()+a.type.slice(1),a}},a.Lifespan.getLifespanFunctionality=function(b){switch(b.type){case"Ephemeral":return a.Lifespan.ephemeralFunctionality;case"Persistent":return a.Lifespan.persistentFunctionality;case"Bound":return a.Lifespan.boundFunctionality;default:a.Error("Received a malformed Lifespan, resource will be dropped: ",b)}},a.Lifespan.ephemeralFunctionality={shouldPersist:function(){return!1},shouldDelete:function(){return!1}},a.Lifespan.persistentFunctionality={shouldPersist:function(){return!0},shouldDelete:function(){return!1}},a.Lifespan.boundFunctionality={shouldPersist:function(){return!1},shouldDelete:function(a,b){var c=b.length;for(var d in a.addresses)if(a.addresses[d].substr(-c)===b)return!0;return!1}},a.Lifespan.Persistent=function(){this.type="Persistent"},a.Lifespan.Ephemeral=function(){this.type="Ephemeral"},a.Lifespan.Bound=function(a){a=a||{},this.type="Bound",this.addresses=a.addresses||[]},a.NamesNode=a.util.extend(a.ApiNode,function(b){a.ApiNode.apply(this,arguments),this.lifespan=new a.Lifespan.Bound({addresses:[b.src]}),this.entity=b.entity||{}}),a.SystemNode=a.util.extend(a.ApiNode,function(){a.ApiNode.apply(this,arguments)}),a.SystemNode.prototype.resourceFallback=function(a){switch(this.contentType){case"application/vnd.ozp-application-v1+json":return"/application/"+a.id}},a.ApiBase=function(b){if(!b.name)throw Error("API must be configured with a name");this.participant=b.participant||new a.ClientParticipant({internal:!0}),this.name=b.name,this.coordinationAddress="coord."+this.name,this.events=new a.Event,this.events.mixinOnOff(this),this.endpoints=[],this.data={},this.watchers={},this.collectors=[],this.changeList={},this.leaderState="member";var c=b.router||a.defaultRouter;c.registerParticipant(this.participant),c.registerMulticast(this.participant,[this.name,this.coordinationAddress]);var d=this;this.participant.on("receive",function(a){d.receivePacketContext(a)}),this.transitionToMemberReady(),this.logPrefix="["+this.name+"/"+this.participant.address+"] ",this.leaderPromise=this.participant.send({dst:"locks.api",resource:"/mutex/"+this.name,action:"lock"}).then(function(){var a,b=new Promise(function(b){a=b});return window.setTimeout(function(){a()},1e3),b}).then(function(){d.transitionToLoading()}),this.leaderPromise["catch"](function(a){console.error("Error registering for leader mutex [address="+d.participant.address+",api="+d.name+"]",a)
}),a.util.addEventListener("beforeunload",function(){d.shutdown()})},a.ApiBase.prototype.createKey=function(b){b=b||"";var c;do c=b+a.util.generateId();while(c in this.data);return c},a.ApiBase.prototype.createdHandler=function(){this.updateCollections()},a.ApiBase.prototype.changedHandler=function(b){var c=a.Lifespan.getLifespanFunctionality(b.lifespan);c.shouldPersist()&&this.persistenceQueue.queueNode(this.name+"/"+b.resource,b)},a.ApiBase.prototype.disconnectHandler=function(b){var c=this;a.object.eachEntry(c.data,function(d,e){var f=a.Lifespan.getLifespanFunctionality(e.lifespan);f.shouldDelete(e.lifespan,b)&&(c.markForChange(e),e.markAsDeleted())}),c.resolveChangedNodes()},a.ApiBase.prototype.createDeathScream=function(){return{watchers:this.watchers,collectors:this.collectors,data:a.object.eachEntry(this.data,function(a,b){return b.serializeLive()})}},a.ApiBase.prototype.getPreference=function(a){return this.participant.send({dst:"data.api",resource:"/ozp/iwc/"+this.name+"/"+a,action:"get"}).then(function(a){return a.entity})},a.ApiBase.prototype.initializeData=function(b){if(b=b||{watchers:{},collectors:[],data:[]},this.watchers=b.watchers,this.collectors=b.collectors,b.data.forEach(function(a){this.createNode({resource:a.resource}).deserializeLive(a)},this),this.updateCollections(),this.endpoints){var c=this;return Promise.all(this.endpoints.map(function(b){var d=a.endpoint(b.link);return c.loadFromEndpoint(d,b.headers)["catch"](function(b){a.log.error(c.logPrefix,"load from endpoint ",b," failed: ",b)})}))}return Promise.resolve()},a.ApiBase.prototype.createNode=function(a,b){var c=this.createNodeObject(a,b);return this.data[c.resource]=c,this.events.trigger("createdNode",c),c},a.ApiBase.prototype.createNodeObject=function(b,c){return c?new c(b):new a.ApiNode(b)},a.ApiBase.prototype.transitionToLoading=function(){var b=this;return"member"!==this.leaderState?(a.log.error(this.logPrefix+"transition to loading called in an invalide state:",this.leaderState),Promise.reject(this.logPrefix+"transition to loading called in an invalide state:",this.leaderState)):(a.log.debug(this.logPrefix+"transitioning to loading"),this.leaderState="loading",this.initializeData(this.deathScream).then(function(){b.transitionToLeader()},function(c){a.log.error(b.logPrefix+"Failed to load data due to ",c),b.shutdown()}))},a.ApiBase.prototype.transitionToLeader=function(){return"loading"!==this.leaderState?void a.log.error(this.logPrefix+"transition to leader called in an invalid state:",this.leaderState):(a.log.debug(this.logPrefix+"transitioning to leader"),this.leaderState="leader",this.broadcastLeaderReady(),this.deliverRequestQueue(),this.on("createdNode",this.createdHandler,this),this.on("changed",this.changedHandler,this),void this.on("addressDisconnects",this.disconnectHandler,this))},a.ApiBase.prototype.shutdown=function(){"leader"===this.leaderState&&this.broadcastDeathScream(this.createDeathScream()),this.participant.send({dst:"locks.api",resource:"/mutex/"+this.name,action:"unlock"})},a.ApiBase.prototype.transitionToMemberReady=function(a){return"member"===this.leaderState?(this.deathScream=a,this.off("createdNode",this.createdHandler),this.off("changed",this.changedHandler),this.off("addressDisconnects",this.disconnectHandler),this.enableRequestQueue(),Promise.resolve()):void 0},a.ApiBase.prototype.transitionToMemberDormant=function(){return"member"===this.leaderState?(this.deathScream=null,this.flushRequestQueue(),Promise.resolve()):void 0},a.ApiBase.prototype.checkAuthorization=function(){return!0},a.ApiBase.prototype.matchingNodes=function(b){return a.object.values(this.data,function(a,c){return 0===c.resource.indexOf(b)&&!c.deleted})},a.ApiBase.prototype.markForChange=function(){for(var a=0;a<arguments.length;++a)if(Array.isArray(arguments[a]))this.markForChange(arguments[a]);else{var b=arguments[a].resource||""+arguments[a];if(this.changeList.hasOwnProperty(b))continue;var c=this.data[b];this.changeList[b]=c?c.snapshot():{}}},a.ApiBase.prototype.addWatcher=function(a,b){var c=this.watchers[a];Array.isArray(c)||(c=this.watchers[a]=[]),c.push(b)},a.ApiBase.prototype.removeWatcher=function(a,b){var c=this.watchers[a];c&&(this.watchers[a]=c.filter(function(a){return a.src===b.src&&a.replyTo===b.msgId}))},a.ApiBase.prototype.addCollector=function(a){function b(a){return a&&a.pattern&&a.collection}if(b(a)){var c=this.collectors.indexOf(a.resource);0>c&&(this.collectors.push(a.resource),this.updateCollectionNode(a))}},a.ApiBase.prototype.removeCollector=function(a){var b=this.collectors.indexOf(a.resource);b>-1&&this.collectors.splice(b,1)},a.ApiBase.prototype.resolveChangedNode=function(b,c,d){var e=this.data[b],f=this.watchers[b]||[];if(e){var g=e.changesSince(c);if(g){var h=a.authorization.pip.attributeUnion(g.oldValue.permissions,g.newValue.permissions),i={oldValue:g.oldValue.entity,newValue:g.newValue.entity,oldCollection:g.oldValue.collection,newCollection:g.newValue.collection,deleted:e.deleted};this.events.trigger("changed",e,i,d),f.forEach(function(a){this.participant.send({src:this.participant.name,dst:a.src,replyTo:a.replyTo,response:"changed",resource:e.resource,permissions:h,contentType:e.contentType,entity:i})},this)}}},a.ApiBase.prototype.resolveChangedNodes=function(b){this.updateCollections(),a.object.eachEntry(this.changeList,function(a,c){this.resolveChangedNode(a,c,b)},this),this.changeList={}},a.ApiBase.prototype.updateCollections=function(){for(var a in this.collectors){var b=this.data[this.collectors[a]];this.updateCollectionNode(b)}},a.ApiBase.prototype.updateCollectionNode=function(b){if(b.deleted)return void this.removeCollector(b);var c=this.matchingNodes(b.pattern).filter(function(a){return!a.deleted}).map(function(a){return a.resource});a.util.arrayContainsAll(b.collection,c)&&a.util.arrayContainsAll(c,b.collection)||(this.markForChange(b),b.collection=c,b.version++)},a.ApiBase.prototype.send=function(a){return a.src=this.name,this.participant.send(a)},a.ApiBase.prototype.receivePacketContext=function(a){return a.packet.src===this.participant.address?Promise.resolve():a.packet.dst===this.coordinationAddress?this.receiveCoordinationPacket(a):"$bus.multicast"===a.packet.dst?this.receiveBusPacket(a):this.receiveRequestPacket(a)},a.ApiBase.prototype.receiveBusPacket=function(a){var b=a.packet;switch(b.action){case"connect":this.events.trigger("addressConnects",b.entity.address,b);break;case"disconnect":this.removeDeadWatchers(b.entity.address),this.events.trigger("addressDisconnects",b.entity.address,b)}return Promise.resolve()},a.ApiBase.prototype.removeDeadWatchers=function(b){var c=b.length;a.object.eachEntry(this.watchers,function(a,d){for(var e in d)d[e].src.substr(-c)===b&&d.splice(e,1)})},a.ApiBase.prototype.receiveRequestPacket=function(b){var c=b.packet;if(this.isRequestQueueing)return this.requestQueue.push(b),Promise.resolve();if("leader"!==this.leaderState)return Promise.resolve();var d=this;return new Promise(function(a,e){try{b.node=d.data[c.resource],a(d.routePacket(c,b))}catch(f){e(f)}}).then(function(a){a&&(a.response=a.response||"ok",b.replyTo(a)),d.resolveChangedNodes(b)},function(e){e&&e.errorAction||a.log.error(d.logPrefix,"Unexpected error: ",e," packet= ",c);var f={src:d.name,response:e.errorAction||"errorUnknown",entity:e.message};b.replyTo(f)})},a.ApiBase.prototype.defaultRoute=function(b,c){switch(c.defaultRouteCause){case"nonRoutablePacket":return;case"noAction":throw new a.BadActionError(b);case"noResource":throw new a.BadResourceError(b);default:throw new a.BadRequestError(b)}},a.ApiBase.prototype.enableRequestQueue=function(){this.isRequestQueueing=!0,this.requestQueue=[]},a.ApiBase.prototype.deliverRequestQueue=function(){this.isRequestQueueing=!1,this.requestQueue.forEach(this.receiveRequestPacket,this),this.requestQueue=[]},a.ApiBase.prototype.flushRequestQueue=function(){this.isRequestQueueing=!1,this.requestQueue=[]},a.ApiBase.prototype.broadcastLeaderReady=function(){this.participant.send({dst:this.coordinationAddress,action:"announceLeader"})},a.ApiBase.prototype.broadcastDeathScream=function(a){this.participant.send({dst:this.coordinationAddress,action:"deathScream",entity:a})},a.ApiBase.prototype.receiveCoordinationPacket=function(b){var c=b.packet;switch(c.action){case"announceLeader":return this.transitionToMemberDormant();case"deathScream":return this.transitionToMemberReady(c.entity);default:return a.log.error("Unknown coordination packet: ",c),Promise.reject(new Error("Unknown action: "+c.action+" in "+JSON.stringify(b)))}},a.ApiBase.prototype.loadFromEndpoint=function(b,c){var d=this;return a.log.debug(d.logPrefix+" loading from ",b.name," -- ",b.baseUrl),b.get("/").then(function(e){var f=e.response,g=a.util.ensureArray(f._embedded&&f._embedded.item||[]),h=a.util.ensureArray(f._links&&f._links.item||[]);g.forEach(function(a){d.createNode({serializedEntity:a})}),a.log.debug(d.logPrefix+" processed "+g.length+" items embedded in the endoint");var i=h.map(function(a){return a.href});return i=i.filter(function(b){return 0===a.object.values(d.data,function(a,c){return c.self===b}).length}),a.log.debug(d.logPrefix+" loading "+i.length+" linked items"),Promise.all(i.map(function(e){return b.get(e,c).then(function(a){d.createNode({serializedEntity:a.response,serializedContentType:a.header["Content-Type"]})})["catch"](function(b){a.log.info(d.logPrefix+"Could not load from "+e+" -- ",b)})}))})["catch"](function(c){a.log.info(d.logPrefix+" couldn't load from endpoint "+b.name+" -- ",c)})},a.ApiBase.prototype.getCollection=function(a){return a?this.matchingNodes(a).filter(function(a){return!a.deleted}).map(function(a){return a.resource}):[]},a.ApiBase.defaultHandler={get:function(a,b){var c=b.node.toPacket();return c.collection=this.getCollection(c.pattern),c},set:function(a,b){return b.node.set(a),{response:"ok"}},"delete":function(a,b){return b.node&&b.node.markAsDeleted(a),{response:"ok"}},list:function(a){var b=this.matchingNodes(a.resource).filter(function(a){return a.deleted?!1:!0}).map(function(a){return a.resource});return{contentType:"application/json",entity:b}},bulkGet:function(a){var b=this,c=this.matchingNodes(a.resource).map(function(a){var c=a.toPacket();return c.collection=b.getCollection(c.pattern),c});return{contentType:"application/json",entity:c}},watch:function(a,b){if(this.addWatcher(a.resource,{src:a.src,replyTo:a.msgId}),this.addCollector(b.node),b.node){var c=b.node.toPacket();return c.collection=this.getCollection(c.pattern),c}return{response:"ok"}},unwatch:function(a,b){return this.removeWatcher(a.resource,a),this.watchers[a.resource]&&0===this.watchers[a.resource].length&&this.removeCollector(b.node),{response:"ok"}}},a.ApiBase.allActions=Object.keys(a.ApiBase.defaultHandler),a.createApi=function(b){var c=a.util.extend(a.ApiBase,function(){return a.ApiBase.apply(this,arguments),b.apply(this,arguments)});return a.PacketRouter.mixin(c),c.useDefaultRoute=function(b,d){d=d||"{resource:.*}",b=a.util.ensureArray(b),b.forEach(function(b){var e=a.standardApiFilters.forAction(b);c.declareRoute({action:b,resource:d,filters:e?e():[]},a.ApiBase.defaultHandler[b])})},c},a.DataApi=a.createApi(function(b){this.persistenceQueue=b.persistenceQueue||new a.AjaxPersistenceQueue,this.endpoints=[{link:a.linkRelPrefix+":user-data",headers:[]}]}),a.DataApi.prototype.createNodeObject=function(b){return new a.DataNode(b)},a.DataApi.useDefaultRoute(a.ApiBase.allActions),a.DataApi.addChildFilters=function(){var b,c=a.standardApiFilters.createAndCollectFilters(a.DataNode);return c.unshift(function(a,c,d,e){return b=a.pattern,a.pattern=null,e()}),c.push(function(a,c,d,e){return c.node.set({pattern:a.pattern}),a.pattern=b,e()}),c},a.DataApi.declareRoute({action:["addChild"],resource:"{resource:.*}",filters:a.DataApi.addChildFilters()},function(b,c){var d=this.createKey(c.node.pattern);b.resource=d,b.pattern=b.pattern||d+"/";var e=this.createNode({resource:d},a.DataNode);return this.markForChange(e),e.set(b),{response:"ok",entity:{resource:e.resource}}}),a.DataApi.declareRoute({action:["removeChild"],resource:"{resource:.*}",filters:a.standardApiFilters.deleteFilters()},function(a,b){return a.entity&&a.entity.resource&&(a.resource=a.entity.resource,b.node=this.data[a.resource],b.node&&(this.markForChange(b.node),b.node.markAsDeleted(a))),{response:"ok"}}),a.IntentsApi=a.createApi(function(b){this.persistenceQueue=b.persistenceQueue||new a.AjaxPersistenceQueue,this.endpoints=[{link:a.linkRelPrefix+":intent",headers:[]}]}),a.IntentsApi.useDefaultRoute(["bulkGet","list"]),a.IntentsApi.useDefaultRoute(["watch","unwatch","delete"],"/inFlightIntent/{id}"),a.IntentsApi.prototype.invokeIntentHandler=function(b,c,d,e,f){var g=new a.IntentsInFlightNode({resource:this.createKey("/inFlightIntent/"),src:b.src,invokePacket:b,type:c,action:d,handlerChoices:e,pattern:f});return this.data[g.resource]=g,this.addCollector(g),this.addWatcher(g.resource,{src:b.src,replyTo:b.msgId}),this.handleInflightIntentState(g).then(function(){return{entity:{inFlightIntent:g.resource}}})},a.IntentsApi.prototype.handleInflightIntentState=function(b){var c,d=this;switch(b.entity.state){case"choosing":var e=function(c){console.log("Picking chooser because",c),a.util.openWindow(a.intentsChooserUri,{"ozpIwc.peer":a.BUS_ROOT,"ozpIwc.intentSelection":"intents.api"+b.resource},a.INTENT_CHOOSER_FEATURES)};return this.getPreference(b.entity.intent.type+"/"+b.entity.intent.action).then(function(a){a in d.data?b.setHandlerResource({state:"delivering",handlerChosen:{resource:a,reason:"remembered"}}):e()})["catch"](e);case"delivering":var f=this.data[b.entity.handlerChosen.resource];c=a.util.clone(f.entity.invokeIntent),c.entity=c.entity||{},c.replyTo=f.entity.replyTo,c.entity.inFlightIntent=b.resource,c.entity.inFlightIntentEntity=b.entity,console.log(this.logPrefix+"delivering intent:",c),this.send(c);break;case"complete":b.entity.invokePacket&&b.entity.invokePacket.src&&b.entity.reply&&(c={dst:b.entity.invokePacket.src,replyTo:b.entity.invokePacket.msgId,contentType:b.entity.reply.contentType,response:"complete",entity:b.entity.reply.entity},this.send(c)),b.markAsDeleted()}return Promise.resolve()},a.IntentsApi.declareRoute({action:"set",resource:"/inFlightIntent/{id}",filters:a.standardApiFilters.setFilters(a.IntentsInFlightNode)},function(a,b){return b.node.set(a),this.handleInflightIntentState(b.node).then(function(){return{response:"ok"}})}),a.IntentsApi.useDefaultRoute(["get","delete","watch","unwatch"],"/{major}/{minor}/{action}/{handlerId}"),a.IntentsApi.declareRoute({action:"invoke",resource:"/{major}/{minor}/{action}/{handlerId}",filters:[]},function(a,b,c){return this.invokeIntentHandler(a,c.major+"/"+c.minor,c.action,[b.node])}),a.IntentsApi.declareRoute({action:"set",resource:"/{major}/{minor}/{action}/{handlerId}",filters:a.standardApiFilters.setFilters(a.IntentHandlerNode,"application/vnd.ozp-iwc-intent-handler-v1+json")},function(a,b){return b.node.set(a),{response:"ok"}}),a.IntentsApi.registerDefinitionFilter=function(b,c){var d=function(a,b,c,d){return b.node.entity||b.node.set({entity:{type:c.major+"/"+c.minor,action:c.action}}),d()},e=a.standardApiFilters.setFilters(b,c);return e.unshift(a.apiFilter.fixPattern()),e.push(d),e},a.IntentsApi.registerHandlerFilter=function(b,c){var d=function(a,b,c,d){return a.resource="/"+c.major+"/"+c.minor+"/"+c.action,b.node=this.data[a.resource],d()},e=function(a,b,c,d){return a.resource="/"+c.major+"/"+c.minor+"/"+c.action+"/"+c.handlerId,b.node=this.data[a.resource],d()},f=a.IntentsApi.registerDefinitionFilter(null,"application/vnd.ozp-iwc-intent-handler-v1+json");f.unshift(d);var g=a.standardApiFilters.setFilters(b,c);return g.unshift(e),f.push.apply(f,g),f},a.IntentsApi.declareRoute({action:"register",resource:"/{major}/{minor}/{action}",filters:a.IntentsApi.registerDefinitionFilter(null,"application/vnd.ozp-iwc-intent-handler-v1+json")},function(b,c){var d=this.createNode({resource:this.createKey(c.node.resource+"/"),src:b.src},a.IntentHandlerNode);return d.set(b),a.log.debug(this.logPrefix+" registered ",c.node),{response:"ok",entity:{resource:d.resource}}}),a.IntentsApi.declareRoute({action:"register",resource:"/{major}/{minor}/{action}/{handlerId}",filters:a.IntentsApi.registerHandlerFilter(null,"application/vnd.ozp-iwc-intent-handler-v1+json")},function(b,c){return c.node.set(b),a.log.debug(this.logPrefix+" registered ",c.node),{response:"ok",entity:{resource:c.node.resource}}}),a.IntentsApi.declareRoute({action:"invoke",resource:"/{major}/{minor}/{action}",filters:a.standardApiFilters.getFilters()},function(a,b,c){return this.invokeIntentHandler(a,c.major+"/"+c.minor,c.action,this.matchingNodes(b.node.pattern),b.node.pattern)}),a.IntentsApi.useDefaultRoute(["delete","watch","unwatch","get"],"/{major}/{minor}/{action}"),a.IntentsApi.declareRoute({action:["set","delete"],resource:"/{major}/{minor}",filters:[]},function(b){throw new a.NoPermissionError(b)}),a.IntentsApi.declareRoute({action:"get",resource:"/{major}/{minor}",filters:[]},function(a,b,c){return b.node?b.node.toPacket():{response:"ok",entity:{type:c.major+"/"+c.minor,actions:this.matchingNodes(a.resource).map(function(a){return a.entity.action})}}}),a.IntentsApi.declareRoute({action:"broadcast",resource:"/{major}/{minor}/{action}",filters:a.standardApiFilters.getFilters()},function(a,b,c){for(var d in b.node.collection)this.invokeIntentHandler(a,c.major+"/"+c.minor,c.action,this.matchingNodes(b.node.collection[d]),b.node.collection[d]);return{response:"ok",entity:{handlers:b.node.collection}}}),a.NamesApi=a.createApi(function(){for(var b in a.apiMap){var c=a.apiMap[b],d="/api/"+c.address;this.data[d]=new a.ApiNode({resource:d,entity:{actions:c.actions},contentType:"application/vnd.ozp-iwc-api-v1+json"})}var e=this;this.on("addressDisconnects",function(b){var c=b.length;a.object.eachEntry(e.data,function(a,d){a.substr(-c)===b&&(e.markForChange(d),d.markAsDeleted())})})}),a.NamesApi.useDefaultRoute(["list","bulkGet"],"{c:/}"),a.NamesApi.useDefaultRoute(["list","bulkGet"],"{c:/(?:api|address|multicast|router).*}"),a.NamesApi.declareRoute({action:["set","delete"],resource:"/{collection:api|address|multicast|router}",filters:[]},function(b){throw new a.NoPermissionError(b)}),a.NamesApi.declareRoute({action:"get",resource:"/{collection:api|address|multicast|router}",filters:[]},function(a){return{contentType:"application/json",entity:this.matchingNodes(a.resource).map(function(a){return a.resource})}}),a.NamesApi.useDefaultRoute(["get","delete","watch","unwatch"],"/api/{addr}"),a.NamesApi.declareRoute({action:"set",resource:"/api/{addr}",filters:a.standardApiFilters.setFilters(a.ApiNode,"application/vnd.ozp-iwc-api-v1+json")},function(a,b){return b.node.set(a),{response:"ok"}}),a.NamesApi.useDefaultRoute(["get","delete","watch","unwatch"],"/address/{addr}"),a.NamesApi.declareRoute({action:"set",resource:"/address/{addr}",filters:a.standardApiFilters.setFilters(a.NamesNode,"application/vnd.ozp-iwc-address-v1+json")},function(a,b){return b.node.set(a),{response:"ok"}}),a.NamesApi.useDefaultRoute(["get","delete","watch","unwatch"],"/multicast/{group}"),a.NamesApi.useDefaultRoute(["get","delete","watch","unwatch"],"/multicast/{group}/{memberAddr}"),a.NamesApi.declareRoute({action:"set",resource:"/multicast/{addr}",filters:a.standardApiFilters.setFilters(a.ApiNode,"application/vnd.ozp-iwc-multicast-address-v1+json")},function(a,b){return b.node.set(a),{response:"ok"}}),a.NamesApi.declareRoute({action:"set",resource:"/multicast/{group}/{member}",filters:a.standardApiFilters.setFilters(a.NamesNode,"application/vnd.ozp-iwc-multicast-address-v1+json")},function(a,b){return b.node.set(a),{response:"ok"}}),a.NamesApi.useDefaultRoute(["get","delete","watch","unwatch"],"/router/{addr}"),a.NamesApi.declareRoute({action:"set",resource:"/router/{addr}",filters:a.standardApiFilters.setFilters(a.NamesNode,"application/vnd.ozp-iwc-router-v1+json")},function(a,b){return b.node.set(a),{response:"ok"}}),a.SystemApi=a.createApi(function(){this.endpoints=[{link:a.linkRelPrefix+":application",headers:[{name:"Accept",value:"application/vnd.ozp-application-v1+json"}]},{link:a.linkRelPrefix+":user",headers:[]},{link:a.linkRelPrefix+":system",headers:[]}];var b=this;this.on("createdNode",this.updateIntents,this),this.leaderPromise.then(function(){a.log.debug("System.api registering for the launch intent");var c={contentType:"application/vnd.ozp-iwc-intent-handler-v1+json",entity:{type:"application/vnd.ozp-iwc-launch-data-v1+json",action:"run",label:"Open in new tab",invokeIntent:{dst:"system.api",action:"invoke",resource:"/launchNewWindow"}}};b.participant.intents().register("/application/vnd.ozp-iwc-launch-data-v1+json/run/system.api",c)["catch"](function(b){a.log.error("System.api failed to register for launch intent: ",b)})})}),a.SystemApi.prototype.updateIntents=function(a){a.entity&&a.entity.intents&&a.entity.intents.forEach(function(b){var c=b.icon||a.entity&&a.entity.icons&&a.entity.icons.small?a.entity.icons.small:"",d=b.label||a.entity.name;this.participant.send({dst:"intents.api",src:"system.api",action:"set",resource:"/"+b.type+"/"+b.action+"/system.api"+a.resource.replace(/\//g,"."),contentType:"application/vnd.ozp-iwc-intent-handler-v1+json",entity:{type:b.type,action:b.action,icon:c,label:d,_links:a.entity._links,invokeIntent:{action:"launch",resource:a.resource}}})},this)},a.SystemApi.useDefaultRoute(["bulkGet","list"]),a.SystemApi.declareRoute({action:"get",resource:"/{collection:user|application|system}",filters:[]},function(a){return{contentType:"application/json",entity:this.matchingNodes(a.resource).map(function(a){return a.resource})}}),a.SystemApi.useDefaultRoute(["get","watch","unwatch"],"/user"),a.SystemApi.declareRoute({action:["set","delete"],resource:"/user",filters:[]},function(b){throw new a.BadActionError(b)}),a.SystemApi.useDefaultRoute(["get","watch","unwatch"],"/system"),a.SystemApi.declareRoute({action:["set","delete"],resource:"/system",filters:[]},function(b){throw new a.BadActionError(b)}),a.SystemApi.useDefaultRoute(["get","watch","unwatch"],"/application/{id}"),a.SystemApi.declareRoute({action:["set","delete"],resource:"/application/{id}",filters:[]},function(b){throw new a.BadActionError(b)}),a.SystemApi.declareRoute({action:["launch"],resource:"/application/{id}",filters:a.standardApiFilters.getFilters()},function(b,c){return a.log.info(this.logPrefix+" launching ",b.entity),this.participant.send({dst:"intents.api",contentType:"application/vnd.ozp-iwc-intent-handler-v1+json",action:"invoke",resource:"/application/vnd.ozp-iwc-launch-data-v1+json/run",entity:{url:c.node.entity.launchUrls["default"],applicationId:c.node.resource,launchData:b.entity,id:c.node.entity.id}}),{response:"ok"}}),a.SystemApi.declareRoute({action:["invoke"],resource:"/launchNewWindow",filters:[]},function(b){return a.log.info(this.logPrefix+" handling launchdata ",b.entity),b.entity&&b.entity.inFlightIntent?(a.util.openWindow(b.entity.inFlightIntentEntity.entity.url,{"ozpIwc.peer":a.BUS_ROOT,"ozpIwc.inFlightIntent":b.entity.inFlightIntent}),{response:"ok"}):{response:"badResource"}}),a.SystemApi.prototype.createNodeObject=function(b){return new a.SystemNode(b)};var a=a||{};return a.version="0.3",a.log.threshold=6,a.ELECTION_TIMEOUT=1e3,a.apiRootUrl=a.apiRootUrl||"/api",a.policyRootUrl=a.policyRootUrl||"/policy",a.basicAuthUsername=a.basicAuthUsername||"",a.basicAuthPassword=a.basicAuthPassword||"",a.linkRelPrefix=a.linkRelPrefix||"ozp",a.intentsChooserUri="intentsChooser.html",function(){var b=a.util.parseQueryParams();if(b.log)try{console.log("Setting log level to ",b.log),a.log.setThreshold(a.log[b.log.toUpperCase()])}catch(c){}}(),a._busInit=function(){},a.authorization=new a.policyAuth.PDP({pip:new a.policyAuth.PIP,prp:new a.policyAuth.PRP,setsEndpoint:a.policyRootUrl}),("undefined"==typeof a.enableDefault||a.enableDefault)&&(a.initEndpoints(a.apiRootUrl||"api"),a.defaultPeer=new a.Peer,a.defaultLocalStorageLink=new a.KeyBroadcastLocalStorageLink({peer:a.defaultPeer}),a.heartBeatFrequency=1e4,a.defaultRouter=new a.Router({peer:a.defaultPeer,heartbeatFrequency:a.heartBeatFrequency}),a._busInit=function(){("undefined"==typeof a.runApis||a.runApis)&&(a.defaultLeadershipStates=function(){return{leader:["actingLeader"],election:["leaderSync","actingLeader"],queueing:["leaderSync"],member:[]}},a.locksApi=new a.LocksApi({participant:new a.LeaderGroupParticipant({name:"locks.api",states:a.defaultLeadershipStates(),electionTimeout:a.ELECTION_TIMEOUT,getStateData:function(){var b={};return b.data=a.locksApi.data,b}})}),a.defaultRouter.registerParticipant(a.locksApi.participant),a.namesApi=new a.NamesApi({name:"names.api"}),a.dataApi=new a.DataApi({name:"data.api"}),a.intentsApi=new a.IntentsApi({name:"intents.api"}),a.systemApi=new a.SystemApi({name:"system.api"})),("undefined"==typeof a.acceptPostMessageParticipants||a.acceptPostMessageParticipants)&&(a.defaultPostMessageParticipantListener=new a.PostMessageParticipantListener({router:a.defaultRouter}))}),new Promise(function(a){void 0===document.visibilityState||"prerender"!==document.visibilityState&&"unload"!==document.visibilityState?a():document.addEventListener("visibilityChange",function b(){"prerender"!==document.visibilityState&&(a(),document.removeEventListener(b))})}).then(a._busInit),a});